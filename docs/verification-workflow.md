# 验收测试流程与标准

> **适用范围**: 所有新功能的 E2E 验收

---

## 1. 验收流程 (5 步)

```
┌─────────────────────────────────────────────────────────┐
│  Step 1: 编译检查                                        │
│  cargo build --release                                  │
├─────────────────────────────────────────────────────────┤
│  Step 2: 单元测试                                        │
│  cargo test                                             │
├─────────────────────────────────────────────────────────┤
│  Step 3: 代码质量                                        │
│  cargo clippy (warnings 可接受, errors 不可接受)         │
├─────────────────────────────────────────────────────────┤
│  Step 4: E2E 测试 ⭐                                     │
│  - 启动服务                                              │
│  - 执行真实业务流程                                      │
│  - 捕获实际输出                                          │
├─────────────────────────────────────────────────────────┤
│  Step 5: 输出审查 ⭐                                     │
│  - 对照 API 规范逐字段检查                               │
│  - 验证格式、命名、数值                                  │
└─────────────────────────────────────────────────────────┘
```

---

## 2. E2E 测试执行

### 2.1 Gateway + WebSocket

```bash
# 1. 启动服务
cargo run --release -- --gateway --port 8080

# 2. WebSocket 连接测试
websocat ws://localhost:8080/ws

# 3. 发送认证
{"type":"auth","user_id":1001}

# 4. 提交订单 (另一个终端)
curl -X POST http://localhost:8080/api/v1/create_order \
  -H "Content-Type: application/json" \
  -H "X-User-ID: 1001" \
  -d '{"symbol":"BTC_USDT","side":"BUY","order_type":"LIMIT","price":"85000.00","qty":"0.001"}'

# 5. 观察 WebSocket 推送消息
```

### 2.2 HTTP API

```bash
# 查询订单
curl http://localhost:8080/api/v1/order/1 -H "X-User-ID: 1001"

# 查询余额
curl http://localhost:8080/api/v1/balances?user_id=1001&asset_id=1
```

---

## 3. 输出审查标准

### 3.1 API 响应格式

```json
// ✅ 正确
{
    "code": 0,
    "msg": "ok",
    "data": { ... }
}

// ❌ 错误: 字段名不对
{
    "status": 0,
    "message": "ok"
}
```

### 3.2 数值格式

| 字段类型 | 正确格式 | 错误格式 |
|----------|----------|----------|
| 价格 | `"85000.00"` | `"8500000"` |
| 数量 | `"0.001000"` | `"1000"` |
| 余额 | `"1.500000"` | `"1500000"` |

**规则**: 
- 所有数值必须是 **String** 类型
- 必须使用 **display_decimals** 格式化

### 3.3 枚举/状态值

| 类型 | 正确格式 | 错误格式 |
|------|----------|----------|
| 订单状态 | `"FILLED"` | `"filled"`, `"Filled"` |
| 交易方向 | `"BUY"` | `"buy"`, `"Buy"` |
| 事件类型 | `"order.update"` | `"order_update"` |

**规则**: SCREAMING_CASE，点号分隔事件类型

### 3.4 资产/交易对名称

| 类型 | 正确格式 | 错误格式 |
|------|----------|----------|
| 资产 | `"BTC"` | `"ASSET_1"`, `1` |
| 交易对 | `"BTC_USDT"` | `"SYMBOL_1"`, `1` |

**规则**: 使用可读名称，不是 ID

---

## 4. 检查清单模板

```markdown
## 验收清单: [功能名称]

### 编译 & 测试
- [ ] `cargo build --release` 成功
- [ ] `cargo test` 全部通过
- [ ] `cargo clippy` 无 errors

### E2E 验证
- [ ] 服务启动正常
- [ ] 业务流程可执行
- [ ] 实际输出已捕获

### 输出审查
- [ ] 响应格式 {code, msg, data}
- [ ] 数值格式 (String + decimals)
- [ ] 枚举值 SCREAMING_CASE
- [ ] 事件类型点号分隔
- [ ] 资产/交易对使用名称

### 签收
- [ ] 所有检查通过
- [ ] 签收人: ___________
- [ ] 日期: ___________
```

---

## 5. 常见错误

| 错误 | 根因 | 检查方法 |
|------|------|----------|
| `"type": "order_update"` | serde rename_all 使用下划线 | 查看 JSON 输出 |
| `"qty": "10000000"` | 直接 to_string() | 检查是否调用 format_decimal |
| `"asset": "ASSET_1"` | 未查 SymbolManager | 检查是否解析 asset_id |

---

## 6. 核心原则

> **测试通过 ≠ 功能正确**
> 
> 必须检查 **真实输出** 是否符合 **设计规范**
