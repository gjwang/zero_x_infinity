# 0x0D UBSCore WAL & Snapshot è¯¦ç»†è®¾è®¡

> **Status**: ğŸ“‹ DRAFT  
> **Author**: Architect Team  
> **Date**: 2024-12-25  
> **Parent**: [Service-Level Design](./0x0D-service-wal-snapshot-design.md)

---

## 1. çŠ¶æ€æ¦‚è¿°

| çŠ¶æ€ | ç±»å‹ | è¯´æ˜ |
|------|------|------|
| **accounts** | `FxHashMap<UserId, UserAccount>` | æ‰€æœ‰ç”¨æˆ·ä½™é¢ |
| **next_seq_id** | `u64` | ä¸‹ä¸€ä¸ªè®¢å•åºåˆ—å· |

---

## 2. æ­£å¸¸è¿è¡Œæ—¶æµç¨‹

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         UBSCore æ­£å¸¸è¿è¡Œæ—¶æµç¨‹                                  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                                 â”‚
â”‚   å¤–éƒ¨è¯·æ±‚                     UBSCore                      æŒä¹…åŒ–              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”                 â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                       â”‚
â”‚  â”‚ Order   â”‚                 â”‚  1. éªŒè¯è¯·æ±‚             â”‚                       â”‚
â”‚  â”‚ Deposit â”‚  â”€â”€è¯·æ±‚â”€â”€â–¶     â”‚  2. å†™ WAL (å…ˆå†™æ—¥å¿—!)   â”‚                       â”‚
â”‚  â”‚ Withdrawâ”‚                 â”‚  3. æ›´æ–°å†…å­˜çŠ¶æ€         â”‚                       â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                 â”‚  4. è¾“å‡ºç»™ä¸‹æ¸¸ (ME)      â”‚                       â”‚
â”‚                              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                       â”‚
â”‚                                          â”‚                                      â”‚
â”‚                                          â–¼                                      â”‚
â”‚                              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                       â”‚
â”‚                              â”‚       Order WAL         â”‚                       â”‚
â”‚                              â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚                       â”‚
â”‚                              â”‚  â”‚ seq=1: Order A    â”‚  â”‚                       â”‚
â”‚                              â”‚  â”‚ seq=2: Deposit    â”‚  â”‚                       â”‚
â”‚                              â”‚  â”‚ seq=3: Order B    â”‚  â”‚                       â”‚
â”‚                              â”‚  â”‚ seq=4: Cancel A   â”‚  â”‚                       â”‚
â”‚                              â”‚  â”‚ ...               â”‚  â”‚                       â”‚
â”‚                              â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚                       â”‚
â”‚                              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                       â”‚
â”‚                                                                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 3. å•ç¬”è®¢å•å¤„ç†æµç¨‹

```rust
pub fn process_order(&mut self, order: InternalOrder) -> Result<OrderResult> {
    // ============ Step 1: éªŒè¯ ============
    let user = self.accounts.get(&order.user_id)?;
    user.validate_balance(order.cost)?;
    
    // ============ Step 2: å†™ WAL (å…³é”®!) ============
    // å¿…é¡»å…ˆå†™ WALï¼Œå†æ›´æ–°å†…å­˜
    // è¿™æ ·å³ä½¿ crashï¼Œä¹Ÿèƒ½ä» WAL æ¢å¤
    let seq_id = self.next_seq_id;
    self.wal_writer.append(WalEntryType::Order, &OrderPayload {
        seq_id,
        order_id: order.order_id,
        user_id: order.user_id,
        symbol_id: order.symbol_id,
        price: order.price,
        qty: order.qty,
        side: order.side,
        order_type: order.order_type,
        ingested_at_ns: order.ingested_at_ns,
    })?;
    self.next_seq_id += 1;
    
    // ============ Step 3: æ›´æ–°å†…å­˜çŠ¶æ€ ============
    let user = self.accounts.get_mut(&order.user_id)?;
    user.lock_balance(order.asset_id, order.cost)?;
    
    // ============ Step 4: è¾“å‡ºç»™ä¸‹æ¸¸ ============
    Ok(OrderResult::Valid(ValidOrder { ... }))
}
```

### å…³é”®ç‚¹

| æ­¥éª¤ | è¯´æ˜ | å¤±è´¥å¤„ç† |
|------|------|----------|
| éªŒè¯ | æ£€æŸ¥ä½™é¢æ˜¯å¦è¶³å¤Ÿ | æ‹’ç»è®¢å• |
| **å†™ WAL** | **å¿…é¡»åœ¨æ›´æ–°å†…å­˜å‰** | è¿”å›é”™è¯¯ |
| æ›´æ–°å†…å­˜ | é”å®šä½™é¢ | - |
| è¾“å‡º | å‘é€ç»™ ME | - |

---

## 4. Snapshot åˆ›å»ºæµç¨‹

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         Snapshot åˆ›å»ºæµç¨‹                                       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                                 â”‚
â”‚   è§¦å‘æ¡ä»¶:                                                                     â”‚
â”‚   - å®šæ—¶: æ¯ 10 åˆ†é’Ÿ                                                           â”‚
â”‚   - é˜ˆå€¼: æ¯ 100,000 è®¢å•                                                      â”‚
â”‚   - å…³æœº: graceful shutdown æ—¶                                                  â”‚
â”‚                                                                                 â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”‚
â”‚   â”‚  1. æš‚åœå†™å…¥ (è·å–ä¸€è‡´æ€§ç‚¹)                                           â”‚     â”‚
â”‚   â”‚     current_seq = self.next_seq_id - 1                               â”‚     â”‚
â”‚   â”‚                                                                       â”‚     â”‚
â”‚   â”‚  2. åˆ›å»ºä¸´æ—¶ç›®å½•                                                      â”‚     â”‚
â”‚   â”‚     tmp_dir = snapshots/.tmp-{timestamp}/                            â”‚     â”‚
â”‚   â”‚                                                                       â”‚     â”‚
â”‚   â”‚  3. åºåˆ—åŒ– accounts                                                   â”‚     â”‚
â”‚   â”‚     bincode::serialize(accounts) -> accounts.bin                     â”‚     â”‚
â”‚   â”‚     è®¡ç®— CRC64 checksum                                               â”‚     â”‚
â”‚   â”‚                                                                       â”‚     â”‚
â”‚   â”‚  4. å†™ metadata.json                                                  â”‚     â”‚
â”‚   â”‚     {                                                                 â”‚     â”‚
â”‚   â”‚       "format_version": 1,                                           â”‚     â”‚
â”‚   â”‚       "wal_seq_id": 12345,      // <-- å…³é”®: å¿«ç…§å¯¹åº”çš„ seq           â”‚     â”‚
â”‚   â”‚       "user_count": 10000,                                           â”‚     â”‚
â”‚   â”‚       "accounts_checksum": "abc123...",                              â”‚     â”‚
â”‚   â”‚       "created_at": "2024-12-25T20:00:00Z"                          â”‚     â”‚
â”‚   â”‚     }                                                                 â”‚     â”‚
â”‚   â”‚                                                                       â”‚     â”‚
â”‚   â”‚  5. å†™ COMPLETE æ ‡è®°                                                  â”‚     â”‚
â”‚   â”‚     touch COMPLETE                                                   â”‚     â”‚
â”‚   â”‚                                                                       â”‚     â”‚
â”‚   â”‚  6. åŸå­é‡å‘½å                                                        â”‚     â”‚
â”‚   â”‚     rename(.tmp-xxx -> snapshot-12345)                               â”‚     â”‚
â”‚   â”‚                                                                       â”‚     â”‚
â”‚   â”‚  7. æ›´æ–° latest ç¬¦å·é“¾æ¥                                              â”‚     â”‚
â”‚   â”‚     ln -sf snapshot-12345 latest                                     â”‚     â”‚
â”‚   â”‚                                                                       â”‚     â”‚
â”‚   â”‚  8. æ¢å¤å†™å…¥                                                          â”‚     â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚
â”‚                                                                                 â”‚
â”‚   æœ€ç»ˆç›®å½•ç»“æ„:                                                                 â”‚
â”‚   snapshots/                                                                    â”‚
â”‚   â”œâ”€â”€ snapshot-12345/                                                          â”‚
â”‚   â”‚   â”œâ”€â”€ metadata.json                                                        â”‚
â”‚   â”‚   â”œâ”€â”€ accounts.bin                                                         â”‚
â”‚   â”‚   â””â”€â”€ COMPLETE                                                             â”‚
â”‚   â””â”€â”€ latest -> snapshot-12345/                                                â”‚
â”‚                                                                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 5. æ¢å¤æµç¨‹ (å¯åŠ¨æ—¶)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         UBSCore æ¢å¤æµç¨‹ (å¯åŠ¨æ—¶)                               â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                                 â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”‚
â”‚   â”‚  1. æ£€æŸ¥ snapshots/latest æ˜¯å¦å­˜åœ¨                                    â”‚     â”‚
â”‚   â”‚                                                                       â”‚     â”‚
â”‚   â”‚  2. å¦‚æœå­˜åœ¨:                                                         â”‚     â”‚
â”‚   â”‚     a. æ£€æŸ¥ COMPLETE æ ‡è®° (ç¡®ä¿å¿«ç…§å®Œæ•´)                              â”‚     â”‚
â”‚   â”‚     b. è¯»å– metadata.json                                             â”‚     â”‚
â”‚   â”‚        snapshot_seq = metadata.wal_seq_id  // ä¾‹å¦‚ 12345              â”‚     â”‚
â”‚   â”‚     c. ååºåˆ—åŒ– accounts.bin                                          â”‚     â”‚
â”‚   â”‚        éªŒè¯ checksum                                                  â”‚     â”‚
â”‚   â”‚     d. æ¢å¤ accounts åˆ°å†…å­˜                                           â”‚     â”‚
â”‚   â”‚                                                                       â”‚     â”‚
â”‚   â”‚  3. å¦‚æœä¸å­˜åœ¨ (å†·å¯åŠ¨):                                              â”‚     â”‚
â”‚   â”‚     snapshot_seq = 0                                                  â”‚     â”‚
â”‚   â”‚     accounts = empty                                                  â”‚     â”‚
â”‚   â”‚                                                                       â”‚     â”‚
â”‚   â”‚  4. é‡æ”¾ WAL (ä» snapshot_seq + 1 å¼€å§‹)                               â”‚     â”‚
â”‚   â”‚     for entry in wal.replay(from_seq = snapshot_seq + 1):            â”‚     â”‚
â”‚   â”‚         match entry.type:                                             â”‚     â”‚
â”‚   â”‚             Order => replay_order(entry)                              â”‚     â”‚
â”‚   â”‚             Cancel => replay_cancel(entry)                            â”‚     â”‚
â”‚   â”‚             Deposit => replay_deposit(entry)                          â”‚     â”‚
â”‚   â”‚             Withdraw => replay_withdraw(entry)                        â”‚     â”‚
â”‚   â”‚         self.next_seq_id = entry.seq_id + 1                          â”‚     â”‚
â”‚   â”‚                                                                       â”‚     â”‚
â”‚   â”‚  5. æ¢å¤å®Œæˆ                                                          â”‚     â”‚
â”‚   â”‚     log: "Recovered to seq={}", self.next_seq_id - 1                 â”‚     â”‚
â”‚   â”‚                                                                       â”‚     â”‚
â”‚   â”‚  6. å¼€å§‹æ­£å¸¸æœåŠ¡                                                      â”‚     â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚
â”‚                                                                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 6. æ—¶åºå›¾

### 6.1 æ­£å¸¸è¿è¡Œ

```
            User         UBSCore           WAL             Memory
              â”‚             â”‚               â”‚                 â”‚
Order â”€â”€â”€â”€â”€â”€â”€â–¶â”‚             â”‚               â”‚                 â”‚
              â”‚  validate   â”‚               â”‚                 â”‚
              â”‚â—€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚               â”‚                 â”‚
              â”‚             â”‚  append       â”‚                 â”‚
              â”‚             â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚                 â”‚
              â”‚             â”‚  OK           â”‚                 â”‚
              â”‚             â”‚â—€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚                 â”‚
              â”‚             â”‚               â”‚   lock_balance  â”‚
              â”‚             â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚
              â”‚             â”‚               â”‚                 â”‚
Result â—€â”€â”€â”€â”€â”€â”€â”‚             â”‚               â”‚                 â”‚
```

### 6.2 æ¢å¤æµç¨‹

```
          Startup        Snapshot         WAL            Memory
              â”‚             â”‚               â”‚                â”‚
              â”‚  read       â”‚               â”‚                â”‚
              â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚               â”‚                â”‚
              â”‚  seq=12345  â”‚               â”‚                â”‚
              â”‚â—€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚               â”‚                â”‚
              â”‚             â”‚               â”‚                â”‚
              â”‚             â”‚  replay(12346+)               â”‚
              â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚                â”‚
              â”‚             â”‚  entries      â”‚                â”‚
              â”‚â—€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚                â”‚
              â”‚             â”‚               â”‚   restore      â”‚
              â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚
              â”‚             â”‚               â”‚                â”‚
           Ready           â”‚               â”‚                â”‚
```

---

## 7. WAL Entry Types

| Type | Payload | è¯´æ˜ |
|------|---------|------|
| `Order (1)` | OrderPayload | æ–°è®¢å• |
| `Cancel (2)` | CancelPayload | æ’¤å• |
| `Deposit (5)` | FundingPayload | å……å€¼ |
| `Withdraw (6)` | FundingPayload | æç° |

---

## 8. é…ç½®å‚æ•°

```rust
pub struct UBSCoreConfig {
    // WAL
    pub wal_dir: PathBuf,
    pub wal_max_file_size: u64,         // 256 MB
    pub wal_flush_interval_ms: u64,     // 100 ms
    
    // Snapshot
    pub snapshot_dir: PathBuf,
    pub snapshot_interval: Duration,     // 10 min
    pub snapshot_event_threshold: u64,   // 100,000
    pub snapshot_keep_count: usize,      // 3
}
```

---

*Document created: 2024-12-25*
