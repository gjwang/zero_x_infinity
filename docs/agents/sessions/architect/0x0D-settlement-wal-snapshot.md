# 0x0D Settlement Service WAL & Snapshot è¯¦ç»†è®¾è®¡

> **Status**: ğŸ“‹ DRAFT  
> **Author**: Architect Team  
> **Date**: 2024-12-25  
> **Parent**: [Service-Level Design](./0x0D-service-wal-snapshot-design.md)

---

## 1. çŠ¶æ€æ¦‚è¿°

| çŠ¶æ€ | ç±»å‹ | è¯´æ˜ |
|------|------|------|
| **last_trade_id** | `u64` | æœ€åå¤„ç†çš„æˆäº¤ ID |

> **æ— çŠ¶æ€è®¾è®¡**: Settlement ç›´æ¥å¤„ç†ä¸ç¼“å­˜ï¼Œä¾èµ–å¹‚ç­‰æ€§å’Œ TDengine æŒä¹…åŒ–

---

## 2. æ­£å¸¸è¿è¡Œæ—¶æµç¨‹

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         Settlement Service æ­£å¸¸è¿è¡Œæ—¶æµç¨‹                        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                                 â”‚
â”‚   Matching        Settlement Service              æŒä¹…åŒ–           ä¸‹æ¸¸         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                   â”‚
â”‚  â”‚ Trade   â”‚     â”‚  1. æ¥æ”¶æˆäº¤             â”‚                                   â”‚
â”‚  â”‚         â”‚â”€â”€â”€â”€â–¶â”‚  2. å¤„ç†ç»“ç®—             â”‚                                   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚  3. å†™çŠ¶æ€ WAL           â”‚                                   â”‚
â”‚                  â”‚  4. æŒä¹…åŒ–åˆ° DB          â”‚                                   â”‚
â”‚                  â”‚  5. é€šçŸ¥ä¸‹æ¸¸             â”‚                                   â”‚
â”‚                  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                   â”‚
â”‚                              â”‚                                                  â”‚
â”‚                              â–¼                                                  â”‚
â”‚                  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                   â”‚
â”‚                  â”‚     çŠ¶æ€ WAL            â”‚                                   â”‚
â”‚                  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚                                   â”‚
â”‚                  â”‚  â”‚ type: Checkpoint  â”‚  â”‚                                   â”‚
â”‚                  â”‚  â”‚ last_trade_id: 100â”‚  â”‚                                   â”‚
â”‚                  â”‚  â”‚ timestamp         â”‚  â”‚                                   â”‚
â”‚                  â”‚  â”‚ type: Checkpoint  â”‚  â”‚                                   â”‚
â”‚                  â”‚  â”‚ last_trade_id: 200â”‚  â”‚                                   â”‚
â”‚                  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚                                   â”‚
â”‚                  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                   â”‚
â”‚                              â”‚                                                  â”‚
â”‚                              â–¼                                                  â”‚
â”‚                      TDengine / å…¶ä»–å­˜å‚¨                                         â”‚
â”‚                                                                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 3. å•ç¬”æˆäº¤ç»“ç®—æµç¨‹

```rust
pub fn process_trade(&mut self, trade: Trade) -> Result<()> {
    // ============ Step 1: éªŒè¯æˆäº¤ ID è¿ç»­æ€§ ============
    if trade.trade_id != self.last_trade_id + 1 {
        return Err(format!(
            "Trade ID gap: expected {}, got {}",
            self.last_trade_id + 1,
            trade.trade_id
        ));
    }
    
    // ============ Step 2: å¤„ç†ç»“ç®— ============
    // è¿™é‡Œæ‰§è¡Œå®é™…çš„ç»“ç®—é€»è¾‘:
    // - æ›´æ–°ä½™é¢
    // - è®¡ç®—æ‰‹ç»­è´¹
    // - ç”Ÿæˆ BalanceEvent
    self.settle_trade(&trade)?;
    
    // ============ Step 3: æŒä¹…åŒ–åˆ° TDengine ============
    self.db.insert_trade(&trade)?;
    self.db.insert_balance_events(&trade.balance_events)?;
    
    // ============ Step 4: å†™çŠ¶æ€ WAL (è½»é‡) ============
    // åªè®°å½•å·²å¤„ç†åˆ°çš„è¿›åº¦
    self.last_trade_id = trade.trade_id;
    
    if self.last_trade_id % CHECKPOINT_INTERVAL == 0 {
        self.wal_writer.append(
            WalEntryType::SettlementCheckpoint,
            &CheckpointPayload {
                last_trade_id: self.last_trade_id,
                timestamp: now(),
            }
        )?;
    }
    
    // ============ Step 5: é€šçŸ¥ä¸‹æ¸¸ (å¯é€‰) ============
    // å‘é€ WebSocket æ›´æ–°ç­‰
    self.notify_downstream(&trade)?;
    
    Ok(())
}
```

### å…³é”®ç‚¹

| æ­¥éª¤ | è¯´æ˜ | å¤±è´¥å¤„ç† |
|------|------|----------|
| éªŒè¯ trade_id | ç¡®ä¿æ— é‡å¤/é—æ¼ | è¿”å›é”™è¯¯å¹¶é‡æ”¾ |
| ç»“ç®— | æ›´æ–°ä½™é¢ã€è®¡ç®—è´¹ç”¨ | äº‹åŠ¡å›æ»š |
| æŒä¹…åŒ– | å†™å…¥ TDengine | é‡è¯• |
| **å†™ Checkpoint** | **å®šæœŸè®°å½•è¿›åº¦** | - |
| é€šçŸ¥ä¸‹æ¸¸ | WebSocket ç­‰ | å¯ä¸¢å¤± |

---

## 4. Snapshot åˆ›å»ºæµç¨‹

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         Settlement Snapshot åˆ›å»ºæµç¨‹                            â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                                 â”‚
â”‚   è§¦å‘æ¡ä»¶:                                                                     â”‚
â”‚   - é˜ˆå€¼: æ¯å¤„ç† 10,000 ç¬”æˆäº¤                                                 â”‚
â”‚   - å…³æœº: graceful shutdown æ—¶                                                  â”‚
â”‚                                                                                 â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”‚
â”‚   â”‚  1. æš‚åœå¤„ç† (è·å–ä¸€è‡´æ€§ç‚¹)                                           â”‚     â”‚
â”‚   â”‚     current_last_trade_id = self.last_trade_id                       â”‚     â”‚
â”‚   â”‚                                                                       â”‚     â”‚
â”‚   â”‚  2. åˆ›å»ºä¸´æ—¶ç›®å½•                                                      â”‚     â”‚
â”‚   â”‚     tmp_dir = snapshots/.tmp-{timestamp}/                            â”‚     â”‚
â”‚   â”‚                                                                       â”‚     â”‚
â”‚   â”‚  3. å†™ metadata.json (è½»é‡)                                           â”‚     â”‚
â”‚   â”‚     {                                                                 â”‚     â”‚
â”‚   â”‚       "format_version": 1,                                           â”‚     â”‚
â”‚   â”‚       "last_trade_id": 10000,                                        â”‚     â”‚
â”‚   â”‚       "created_at": "2024-12-25T20:00:00Z"                          â”‚     â”‚
â”‚   â”‚     }                                                                 â”‚     â”‚
â”‚   â”‚     // Settlement çš„ Snapshot éå¸¸è½»é‡                                â”‚     â”‚
â”‚   â”‚     // å› ä¸ºæ‰€æœ‰æ•°æ®å·²æŒä¹…åŒ–åˆ° TDengine                                â”‚     â”‚
â”‚   â”‚     // Snapshot åªè®°å½•è¿›åº¦                                           â”‚     â”‚
â”‚   â”‚                                                                       â”‚     â”‚
â”‚   â”‚  4. å†™ COMPLETE æ ‡è®°                                                  â”‚     â”‚
â”‚   â”‚  5. åŸå­é‡å‘½å                                                        â”‚     â”‚
â”‚   â”‚     rename(.tmp-xxx -> snapshot-{last_trade_id})                     â”‚     â”‚
â”‚   â”‚  6. æ›´æ–° latest ç¬¦å·é“¾æ¥                                              â”‚     â”‚
â”‚   â”‚  7. æ¢å¤å¤„ç†                                                          â”‚     â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚
â”‚                                                                                 â”‚
â”‚   æœ€ç»ˆç›®å½•ç»“æ„:                                                                 â”‚
â”‚   snapshots/                                                                    â”‚
â”‚   â”œâ”€â”€ snapshot-10000/                                                          â”‚
â”‚   â”‚   â”œâ”€â”€ metadata.json                                                        â”‚
â”‚   â”‚   â””â”€â”€ COMPLETE                                                             â”‚
â”‚   â””â”€â”€ latest -> snapshot-10000/                                                â”‚
â”‚                                                                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**æ³¨æ„**: Settlement çš„ Snapshot éå¸¸è½»é‡ï¼Œå› ä¸ºï¼š
- æ‰€æœ‰ Trade å’Œ BalanceEvent å·²æŒä¹…åŒ–åˆ° TDengine
- Snapshot åªéœ€è®°å½• `last_trade_id` (å¤„ç†è¿›åº¦)
- æ— éœ€å­˜å‚¨å¤§é‡çŠ¶æ€æ•°æ®

---

## 5. æ¢å¤æµç¨‹ (å¯åŠ¨æ—¶)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         Settlement Service æ¢å¤æµç¨‹ (å¯åŠ¨æ—¶)                    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                                 â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”‚
â”‚   â”‚  1. æ£€æŸ¥ snapshots/latest æ˜¯å¦å­˜åœ¨                                    â”‚     â”‚
â”‚   â”‚                                                                       â”‚     â”‚
â”‚   â”‚  2. å¦‚æœå­˜åœ¨:                                                         â”‚     â”‚
â”‚   â”‚     a. æ£€æŸ¥ COMPLETE æ ‡è®°                                             â”‚     â”‚
â”‚   â”‚     b. è¯»å– metadata.json                                             â”‚     â”‚
â”‚   â”‚        last_trade_id = metadata.last_trade_id  // ä¾‹å¦‚ 10000          â”‚     â”‚
â”‚   â”‚                                                                       â”‚     â”‚
â”‚   â”‚  3. å¦‚æœä¸å­˜åœ¨ (å†·å¯åŠ¨):                                              â”‚     â”‚
â”‚   â”‚     last_trade_id = 0                                                 â”‚     â”‚
â”‚   â”‚                                                                       â”‚     â”‚
â”‚   â”‚  4. é‡æ”¾ WAL (ä»æœ€åä¸€ä¸ª Checkpoint)                                  â”‚     â”‚
â”‚   â”‚     // WAL åªæœ‰è½»é‡çš„ Checkpoint è®°å½•                                 â”‚     â”‚
â”‚   â”‚     // ä¸»è¦ç”¨äºéªŒè¯ last_trade_id çš„å‡†ç¡®æ€§                            â”‚     â”‚
â”‚   â”‚     for entry in wal.replay():                                        â”‚     â”‚
â”‚   â”‚         if entry.type == SettlementCheckpoint:                        â”‚     â”‚
â”‚   â”‚             last_trade_id = max(last_trade_id, entry.last_trade_id)  â”‚     â”‚
â”‚   â”‚                                                                       â”‚     â”‚
â”‚   â”‚  5. è¯·æ±‚ ME é‡æ”¾ (ä» last_trade_id + 1 å¼€å§‹)                          â”‚     â”‚
â”‚   â”‚     request = ReplayRequest { from_trade_id: last_trade_id + 1 }     â”‚     â”‚
â”‚   â”‚     matching.replay_trades(request, |trade| {                         â”‚     â”‚
â”‚   â”‚         self.process_trade(trade);                                    â”‚     â”‚
â”‚   â”‚     });                                                                â”‚     â”‚
â”‚   â”‚                                                                       â”‚     â”‚
â”‚   â”‚  6. æ¢å¤å®Œæˆ                                                          â”‚     â”‚
â”‚   â”‚     log: "Recovered Settlement to trade_id={}", self.last_trade_id   â”‚     â”‚
â”‚   â”‚                                                                       â”‚     â”‚
â”‚   â”‚  7. å¼€å§‹æ­£å¸¸ç»“ç®—                                                      â”‚     â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚
â”‚                                                                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 6. æ—¶åºå›¾

### 6.1 æ­£å¸¸è¿è¡Œ

```
      Matching      Settlement        State WAL       TDengine
          â”‚             â”‚                 â”‚              â”‚
  Trade   â”‚             â”‚                 â”‚              â”‚
  â”€â”€â”€â”€â”€â”€â”€â”€â–¶             â”‚                 â”‚              â”‚
          â”‚  settle     â”‚                 â”‚              â”‚
          â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚                 â”‚              â”‚
          â”‚             â”‚  insert         â”‚              â”‚
          â”‚             â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚
          â”‚             â”‚  OK             â”‚              â”‚
          â”‚             â”‚â—€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚
          â”‚             â”‚  checkpoint     â”‚              â”‚
          â”‚             â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚              â”‚
          â”‚             â”‚  OK             â”‚              â”‚
          â”‚             â”‚â—€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚              â”‚
          â”‚             â”‚                 â”‚              â”‚
```

### 6.2 æ¢å¤æµç¨‹

```
      Startup    Snapshot      WAL        Matching    Settlement
          â”‚         â”‚           â”‚             â”‚            â”‚
          â”‚  read   â”‚           â”‚             â”‚            â”‚
          â”‚â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚           â”‚             â”‚            â”‚
          â”‚ id=10000â”‚           â”‚             â”‚            â”‚
          â”‚â—€â”€â”€â”€â”€â”€â”€â”€â”€â”‚           â”‚             â”‚            â”‚
          â”‚         â”‚  replay   â”‚             â”‚            â”‚
          â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶             â”‚            â”‚
          â”‚         â”‚  checkpoints            â”‚            â”‚
          â”‚â—€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€             â”‚            â”‚
          â”‚         â”‚           â”‚  replay(10001+)          â”‚
          â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚            â”‚
          â”‚         â”‚           â”‚  Trades     â”‚            â”‚
          â”‚â—€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚            â”‚
          â”‚         â”‚           â”‚             â”‚  re-settle â”‚
          â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚
          â”‚         â”‚           â”‚             â”‚            â”‚
       Ready       â”‚           â”‚             â”‚            â”‚
```

---

## 7. WAL Entry Types

| Type | Payload | è¯´æ˜ |
|------|---------|------|
| `SettlementCheckpoint` | CheckpointPayload | ç»“ç®—è¿›åº¦æ£€æŸ¥ç‚¹ |

**CheckpointPayload**:
```rust
struct CheckpointPayload {
    last_trade_id: u64,      // æœ€åå¤„ç†çš„ trade_id
    timestamp: u64,          // æ—¶é—´æˆ³
}
```

**Checkpoint é—´éš”**: æ¯ 1,000 ç¬”æˆäº¤

---

## 8. Snapshot æ ¼å¼

```rust
struct SettlementSnapshot {
    format_version: u32,
    last_trade_id: u64,      // æœ€åå¤„ç†çš„ trade_id
    created_at: u64,
}
```

**ç‰¹ç‚¹**: 
- éå¸¸è½»é‡ (åªæœ‰å…ƒæ•°æ®)
- æ‰€æœ‰ä¸šåŠ¡æ•°æ®å·²åœ¨ TDengine ä¸­
- Snapshot åªè®°å½•å¤„ç†è¿›åº¦

---

## 9. é…ç½®å‚æ•°

```rust
pub struct SettlementConfig {
    // WAL
    pub wal_dir: PathBuf,
    pub checkpoint_interval: u64,       // 1,000 trades
    
    // Snapshot
    pub snapshot_dir: PathBuf,
    pub snapshot_threshold: u64,        // 10,000 trades
    pub snapshot_keep_count: usize,     // 3
    
    // Matching è¿æ¥
    pub matching_replay_endpoint: String,
    
    // TDengine
    pub tdengine_url: String,
}
```

---

## 10. å¹‚ç­‰æ€§ä¿è¯

Settlement å¿…é¡»ç¡®ä¿å¹‚ç­‰æ€§ï¼Œé¿å…é‡å¤å¤„ç†ï¼š

```rust
pub fn ensure_idempotency(&self, trade: &Trade) -> Result<()> {
    // æ£€æŸ¥ TDengine æ˜¯å¦å·²å­˜åœ¨è¯¥ trade_id
    if self.db.trade_exists(trade.trade_id)? {
        warn!("Trade {} already processed, skipping", trade.trade_id);
        return Ok(());
    }
    
    // æ£€æŸ¥ trade_id è¿ç»­æ€§
    if trade.trade_id != self.last_trade_id + 1 {
        return Err(format!(
            "Trade ID gap detected: expected {}, got {}",
            self.last_trade_id + 1,
            trade.trade_id
        ));
    }
    
    Ok(())
}
```

---

*Document created: 2024-12-25*
