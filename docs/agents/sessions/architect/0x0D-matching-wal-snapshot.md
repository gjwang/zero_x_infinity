# 0x0D Matching Service WAL & Snapshot è¯¦ç»†è®¾è®¡

> **Status**: ğŸ“‹ DRAFT  
> **Author**: Architect Team  
> **Date**: 2024-12-25  
> **Parent**: [Service-Level Design](./0x0D-service-wal-snapshot-design.md)

---

## 1. çŠ¶æ€æ¦‚è¿°

| çŠ¶æ€ | ç±»å‹ | è¯´æ˜ |
|------|------|------|
| **orderbooks** | `HashMap<SymbolId, OrderBook>` | æ‰€æœ‰äº¤æ˜“å¯¹çš„è®¢å•ç°¿ |
| **next_trade_id** | `u64` | ä¸‹ä¸€ä¸ªæˆäº¤ ID |
| **last_order_seq** | `u64` | æœ€åå¤„ç†çš„è®¢å• seq (æ¥è‡ª UBSCore) |

---

## 2. æ­£å¸¸è¿è¡Œæ—¶æµç¨‹

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         Matching Engine æ­£å¸¸è¿è¡Œæ—¶æµç¨‹                          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                                 â”‚
â”‚   UBSCore          Matching Engine                Trade WAL         ä¸‹æ¸¸        â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                 â”‚
â”‚  â”‚ValidOrderâ”‚      â”‚  1. æ¥æ”¶è®¢å•             â”‚                                 â”‚
â”‚  â”‚         â”‚â”€â”€â”€â”€â”€â”€â–¶â”‚  2. æ’®åˆ OrderBook       â”‚                                 â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â”‚  3. ç”Ÿæˆæˆäº¤             â”‚                                 â”‚
â”‚                    â”‚  4. å†™ Trade WAL         â”‚                                 â”‚
â”‚                    â”‚  5. æ›´æ–° OrderBook       â”‚                                 â”‚
â”‚                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                 â”‚
â”‚                                â”‚                                                â”‚
â”‚                                â–¼                                                â”‚
â”‚                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                 â”‚
â”‚                    â”‚      Trade WAL          â”‚                                 â”‚
â”‚                    â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚                                 â”‚
â”‚                    â”‚  â”‚ trade_id=1: BTCUSDTâ”‚  â”‚                                 â”‚
â”‚                    â”‚  â”‚   price=50000     â”‚  â”‚                                 â”‚
â”‚                    â”‚  â”‚   qty=0.1         â”‚  â”‚                                 â”‚
â”‚                    â”‚  â”‚ trade_id=2: ...    â”‚  â”‚                                 â”‚
â”‚                    â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚                                 â”‚
â”‚                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                 â”‚
â”‚                                â”‚                                                â”‚
â”‚                                â–¼                                                â”‚
â”‚                            Settlement                                           â”‚
â”‚                                                                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 3. å•ç¬”è®¢å•åŒ¹é…æµç¨‹

```rust
pub fn process_order(&mut self, order: ValidOrder) -> Vec<Trade> {
    // ============ Step 1: è·å– OrderBook ============
    let orderbook = self.orderbooks
        .entry(order.symbol_id)
        .or_insert_with(|| OrderBook::new(order.symbol_id));
    
    // ============ Step 2: æ’®åˆ ============
    let trades = orderbook.match_order(&order);
    
    // ============ Step 3: å†™ Trade WAL (å…³é”®!) ============
    // å¿…é¡»å…ˆå†™ WALï¼Œå†æ›´æ–° OrderBook çŠ¶æ€
    for trade in &trades {
        let trade_id = self.next_trade_id;
        self.wal_writer.append(WalEntryType::Trade, &TradePayload {
            trade_id,
            symbol_id: order.symbol_id,
            price: trade.price,
            qty: trade.qty,
            buyer_order_id: trade.buyer_order_id,
            seller_order_id: trade.seller_order_id,
            taker_side: trade.taker_side,
            timestamp: trade.timestamp,
        })?;
        self.next_trade_id += 1;
    }
    
    // ============ Step 4: æ›´æ–° OrderBook (ç§»é™¤æˆäº¤è®¢å•) ============
    orderbook.apply_trades(&trades);
    
    // ============ Step 5: æ›´æ–° last_order_seq ============
    self.last_order_seq = order.seq_id;
    
    // ============ Step 6: è¾“å‡ºç»™ä¸‹æ¸¸ ============
    trades
}
```

### å…³é”®ç‚¹

| æ­¥éª¤ | è¯´æ˜ | å¤±è´¥å¤„ç† |
|------|------|----------|
| è·å– OrderBook | æ‡’åŠ è½½ï¼Œä¸å­˜åœ¨åˆ™åˆ›å»º | - |
| æ’®åˆ | ä»·æ ¼-æ—¶é—´ä¼˜å…ˆç®—æ³• | - |
| **å†™ Trade WAL** | **å¿…é¡»åœ¨ OrderBook æ›´æ–°å‰** | è¿”å›é”™è¯¯ï¼Œä¸æ›´æ–°çŠ¶æ€ |
| æ›´æ–° OrderBook | ç§»é™¤å®Œå…¨æˆäº¤çš„è®¢å• | - |
| è¾“å‡º | å‘é€ç»™ Settlement | - |

---

## 4. Snapshot åˆ›å»ºæµç¨‹

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         ME Snapshot åˆ›å»ºæµç¨‹                                    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                                 â”‚
â”‚   è§¦å‘æ¡ä»¶:                                                                     â”‚
â”‚   - å®šæ—¶: æ¯ 5 åˆ†é’Ÿ                                                            â”‚
â”‚   - é˜ˆå€¼: æ¯ 50,000 è®¢å•                                                       â”‚
â”‚   - å…³æœº: graceful shutdown æ—¶                                                  â”‚
â”‚                                                                                 â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”‚
â”‚   â”‚  1. æš‚åœè®¢å•å¤„ç† (è·å–ä¸€è‡´æ€§ç‚¹)                                       â”‚     â”‚
â”‚   â”‚     current_last_order_seq = self.last_order_seq                     â”‚     â”‚
â”‚   â”‚     current_next_trade_id = self.next_trade_id                       â”‚     â”‚
â”‚   â”‚                                                                       â”‚     â”‚
â”‚   â”‚  2. åˆ›å»ºä¸´æ—¶ç›®å½•                                                      â”‚     â”‚
â”‚   â”‚     tmp_dir = snapshots/.tmp-{timestamp}/                            â”‚     â”‚
â”‚   â”‚                                                                       â”‚     â”‚
â”‚   â”‚  3. åºåˆ—åŒ– OrderBooks                                                 â”‚     â”‚
â”‚   â”‚     for (symbol_id, orderbook) in orderbooks:                        â”‚     â”‚
â”‚   â”‚         bincode::serialize(orderbook)                                â”‚     â”‚
â”‚   â”‚           -> orderbook-{symbol_id}.bin                               â”‚     â”‚
â”‚   â”‚         è®¡ç®— CRC64 checksum                                           â”‚     â”‚
â”‚   â”‚                                                                       â”‚     â”‚
â”‚   â”‚  4. å†™ metadata.json                                                  â”‚     â”‚
â”‚   â”‚     {                                                                 â”‚     â”‚
â”‚   â”‚       "format_version": 1,                                           â”‚     â”‚
â”‚   â”‚       "last_order_seq": 12345,    // æ¥è‡ª UBSCore çš„ seq              â”‚     â”‚
â”‚   â”‚       "next_trade_id": 5678,                                         â”‚     â”‚
â”‚   â”‚       "orderbooks": [                                                â”‚     â”‚
â”‚   â”‚         {                                                             â”‚     â”‚
â”‚   â”‚           "symbol_id": 1,                                            â”‚     â”‚
â”‚   â”‚           "file": "orderbook-1.bin",                                 â”‚     â”‚
â”‚   â”‚           "checksum": "abc...",                                      â”‚     â”‚
â”‚   â”‚           "bid_count": 150,                                          â”‚     â”‚
â”‚   â”‚           "ask_count": 200                                           â”‚     â”‚
â”‚   â”‚         }                                                             â”‚     â”‚
â”‚   â”‚       ],                                                              â”‚     â”‚
â”‚   â”‚       "created_at": "2024-12-25T20:00:00Z"                          â”‚     â”‚
â”‚   â”‚     }                                                                 â”‚     â”‚
â”‚   â”‚                                                                       â”‚     â”‚
â”‚   â”‚  5. å†™ COMPLETE æ ‡è®°                                                  â”‚     â”‚
â”‚   â”‚  6. åŸå­é‡å‘½å                                                        â”‚     â”‚
â”‚   â”‚     rename(.tmp-xxx -> snapshot-{last_order_seq})                    â”‚     â”‚
â”‚   â”‚  7. æ›´æ–° latest ç¬¦å·é“¾æ¥                                              â”‚     â”‚
â”‚   â”‚  8. æ¢å¤è®¢å•å¤„ç†                                                      â”‚     â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚
â”‚                                                                                 â”‚
â”‚   æœ€ç»ˆç›®å½•ç»“æ„:                                                                 â”‚
â”‚   snapshots/                                                                    â”‚
â”‚   â”œâ”€â”€ snapshot-12345/                                                          â”‚
â”‚   â”‚   â”œâ”€â”€ metadata.json                                                        â”‚
â”‚   â”‚   â”œâ”€â”€ orderbook-1.bin       # BTCUSDT                                      â”‚
â”‚   â”‚   â”œâ”€â”€ orderbook-2.bin       # ETHUSDT                                      â”‚
â”‚   â”‚   â””â”€â”€ COMPLETE                                                             â”‚
â”‚   â””â”€â”€ latest -> snapshot-12345/                                                â”‚
â”‚                                                                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 5. æ¢å¤æµç¨‹ (å¯åŠ¨æ—¶)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         Matching Engine æ¢å¤æµç¨‹ (å¯åŠ¨æ—¶)                       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                                 â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”‚
â”‚   â”‚  1. æ£€æŸ¥ snapshots/latest æ˜¯å¦å­˜åœ¨                                    â”‚     â”‚
â”‚   â”‚                                                                       â”‚     â”‚
â”‚   â”‚  2. å¦‚æœå­˜åœ¨:                                                         â”‚     â”‚
â”‚   â”‚     a. æ£€æŸ¥ COMPLETE æ ‡è®° (ç¡®ä¿å¿«ç…§å®Œæ•´)                              â”‚     â”‚
â”‚   â”‚     b. è¯»å– metadata.json                                             â”‚     â”‚
â”‚   â”‚        last_order_seq = metadata.last_order_seq  // ä¾‹å¦‚ 12345        â”‚     â”‚
â”‚   â”‚        next_trade_id = metadata.next_trade_id    // ä¾‹å¦‚ 5678         â”‚     â”‚
â”‚   â”‚     c. ååºåˆ—åŒ– OrderBook                                             â”‚     â”‚
â”‚   â”‚        for ob_info in metadata.orderbooks:                            â”‚     â”‚
â”‚   â”‚            data = read(ob_info.file)                                  â”‚     â”‚
â”‚   â”‚            verify_checksum(data, ob_info.checksum)                    â”‚     â”‚
â”‚   â”‚            orderbook = bincode::deserialize(data)                     â”‚     â”‚
â”‚   â”‚            self.orderbooks.insert(ob_info.symbol_id, orderbook)       â”‚     â”‚
â”‚   â”‚                                                                       â”‚     â”‚
â”‚   â”‚  3. å¦‚æœä¸å­˜åœ¨ (å†·å¯åŠ¨):                                              â”‚     â”‚
â”‚   â”‚     last_order_seq = 0                                                â”‚     â”‚
â”‚   â”‚     next_trade_id = 1                                                 â”‚     â”‚
â”‚   â”‚     orderbooks = empty                                                â”‚     â”‚
â”‚   â”‚                                                                       â”‚     â”‚
â”‚   â”‚  4. è¯·æ±‚ UBSCore é‡æ”¾ (ä» last_order_seq + 1 å¼€å§‹)                    â”‚     â”‚
â”‚   â”‚     request = ReplayRequest { from_seq: last_order_seq + 1 }         â”‚     â”‚
â”‚   â”‚     ubscore.replay_orders(request, |order| {                          â”‚     â”‚
â”‚   â”‚         self.process_order(order);                                    â”‚     â”‚
â”‚   â”‚     });                                                                â”‚     â”‚
â”‚   â”‚                                                                       â”‚     â”‚
â”‚   â”‚  5. æ¢å¤å®Œæˆ                                                          â”‚     â”‚
â”‚   â”‚     log: "Recovered OrderBook to order_seq={}", self.last_order_seq  â”‚     â”‚
â”‚   â”‚                                                                       â”‚     â”‚
â”‚   â”‚  6. å¼€å§‹æ­£å¸¸æ’®åˆ                                                      â”‚     â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚
â”‚                                                                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 6. æ—¶åºå›¾

### 6.1 æ­£å¸¸è¿è¡Œ

```
       UBSCore        Matching         Trade WAL      OrderBook
          â”‚               â”‚                 â”‚              â”‚
ValidOrderâ”‚               â”‚                 â”‚              â”‚
  â”€â”€â”€â”€â”€â”€â”€â”€â–¶               â”‚                 â”‚              â”‚
          â”‚  match        â”‚                 â”‚              â”‚
          â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚                 â”‚              â”‚
          â”‚               â”‚  append Trade   â”‚              â”‚
          â”‚               â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚              â”‚
          â”‚               â”‚  OK             â”‚              â”‚
          â”‚               â”‚â—€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚              â”‚
          â”‚               â”‚                 â”‚  update      â”‚
          â”‚               â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚
          â”‚               â”‚                 â”‚              â”‚
  Trades  â”‚               â”‚                 â”‚              â”‚
  â—€â”€â”€â”€â”€â”€â”€â”€â”€               â”‚                 â”‚              â”‚
```

### 6.2 æ¢å¤æµç¨‹

```
      Startup      Snapshot      UBSCore       Matching
          â”‚           â”‚             â”‚              â”‚
          â”‚  read     â”‚             â”‚              â”‚
          â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚             â”‚              â”‚
          â”‚  seq=12345â”‚             â”‚              â”‚
          â”‚â—€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚             â”‚              â”‚
          â”‚           â”‚             â”‚              â”‚
          â”‚  load OrderBooks        â”‚              â”‚
          â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚              â”‚
          â”‚           â”‚             â”‚              â”‚
          â”‚           â”‚  replay(12346+)            â”‚
          â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚              â”‚
          â”‚           â”‚  ValidOrders               â”‚
          â”‚â—€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚              â”‚
          â”‚           â”‚             â”‚  re-match    â”‚
          â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚
          â”‚           â”‚             â”‚              â”‚
       Ready         â”‚             â”‚              â”‚
```

---

## 7. WAL Entry Types

| Type | Payload | è¯´æ˜ |
|------|---------|------|
| `Trade (3)` | TradePayload | æˆäº¤è®°å½• |
| `OrderUpdate (å¯é€‰)` | OrderUpdatePayload | è®¢å•çŠ¶æ€å˜æ›´ (å¯é€‰) |

**TradePayload**:
```rust
struct TradePayload {
    trade_id: u64,
    symbol_id: u32,
    price: i64,              // ä»·æ ¼ (å®šç‚¹æ•°)
    qty: i64,                // æ•°é‡ (å®šç‚¹æ•°)
    buyer_order_id: u64,
    seller_order_id: u64,
    taker_side: Side,        // Buy/Sell
    timestamp: u64,
}
```

---

## 8. OrderBook Snapshot æ ¼å¼

```rust
struct OrderBookSnapshot {
    symbol_id: u32,
    bids: Vec<PriceLevel>,   // ä¹°å•ä»·æ ¼å±‚çº§ (é™åº)
    asks: Vec<PriceLevel>,   // å–å•ä»·æ ¼å±‚çº§ (å‡åº)
}

struct PriceLevel {
    price: i64,
    orders: Vec<OrderEntry>,  // åŒä»·æ ¼è®¢å• (æ—¶é—´ä¼˜å…ˆ)
}

struct OrderEntry {
    order_id: u64,
    user_id: u32,
    qty: i64,                 // å‰©ä½™æ•°é‡
    timestamp: u64,
}
```

---

## 9. é…ç½®å‚æ•°

```rust
pub struct MatchingConfig {
    // WAL
    pub wal_dir: PathBuf,
    pub wal_max_file_size: u64,         // 256 MB
    
    // Snapshot
    pub snapshot_dir: PathBuf,
    pub snapshot_interval: Duration,     // 5 min
    pub snapshot_event_threshold: u64,   // 50,000
    pub snapshot_keep_count: usize,      // 3
    
    // UBSCore è¿æ¥
    pub ubscore_replay_endpoint: String,
}
```

---

## 10. é‡æ”¾è¾“å‡º API

```rust
/// ä¸‹æ¸¸ (Settlement) è¯·æ±‚é‡æ”¾
pub fn replay_trades(&self, from_trade_id: u64, callback: impl FnMut(Trade)) {
    // ä» Trade WAL è¯»å–å¹¶é‡æ”¾
    self.wal_reader.replay(from_trade_id, |header, payload| {
        if header.entry_type == WalEntryType::Trade {
            let trade = bincode::deserialize::<TradePayload>(payload)?;
            callback(trade);
        }
        true  // ç»§ç»­
    });
}
```

---

*Document created: 2024-12-25*
