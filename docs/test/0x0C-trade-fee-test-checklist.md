# 0x0C Trade Fee System - æµ‹è¯•éªŒæ”¶æ¸…å•
# Test Acceptance Checklist

> ğŸ“‹ **From Senior Test Engineer Perspective | èµ„æ·±æµ‹è¯•å·¥ç¨‹å¸ˆè§†è§’**

---

## 1. å•å…ƒæµ‹è¯• | Unit Tests

### 1.1 è´¹ç‡è®¡ç®—å‡†ç¡®æ€§ | Fee Calculation Accuracy

| ID | æµ‹è¯•é¡¹ | Test Case | é¢„æœŸç»“æœ | â˜‘ï¸ |
|----|--------|-----------|---------|-----|
| U01 | åŸºç¡€ Taker è´¹ç‡ | `amount=1_000_000_000, rate=2000 (0.20%)` | `fee=2_000_000` | â˜ |
| U02 | åŸºç¡€ Maker è´¹ç‡ | `amount=1_000_000_000, rate=1000 (0.10%)` | `fee=1_000_000` | â˜ |
| U03 | VIP æŠ˜æ‰£è®¡ç®— | `base=2000, discount=50%` | `final_rate=1000` | â˜ |
| U04 | é›¶è´¹ç‡ | `rate=0` | `fee=0` (å…è®¸) | â˜ |
| U05 | æœ€å°é‡‘é¢è¾¹ç•Œ | `amount=1, rate=2000` | æ­£ç¡®èˆå…¥ (â‰¥0) | â˜ |
| U06 | å¤§é‡‘é¢æº¢å‡ºä¿æŠ¤ | `amount=u64::MAX / 2, rate=1_000_000` | æ— æº¢å‡º (u128ä¸­é—´è®¡ç®—) | â˜ |
| U07 | ç²¾åº¦æŸå¤±æ£€éªŒ | éªŒè¯ 10^6 ç²¾åº¦ä¸‹çš„èˆå…¥è¯¯å·® | è¯¯å·® < 1 æœ€å°å•ä½ | â˜ |

### 1.2 è§’è‰²åˆ†é… | Role Assignment

| ID | æµ‹è¯•é¡¹ | Test Case | é¢„æœŸç»“æœ | â˜‘ï¸ |
|----|--------|-----------|---------|-----|
| U08 | æŒ‚å•æ–¹è§’è‰² | è®¢å•å…ˆè¿›å…¥ç›˜å£å†è¢«åŒ¹é… | `role=Maker` | â˜ |
| U09 | åƒå•æ–¹è§’è‰² | è®¢å•ç«‹å³åŒ¹é…å·²æœ‰è®¢å• | `role=Taker` | â˜ |
| U10 | è‡ªæˆäº¤è§’è‰² | åŒç”¨æˆ·è®¢å•äº’ç›¸åŒ¹é… | åŒæ–¹å„è‡ªè§’è‰²æ­£ç¡® | â˜ |

### 1.3 æ‰£è´¹èµ„äº§é€»è¾‘ | Fee Deduction Asset

| ID | æµ‹è¯•é¡¹ | Test Case | é¢„æœŸç»“æœ | â˜‘ï¸ |
|----|--------|-----------|---------|-----|
| U11 | ä¹°æ–¹æ‰£è´¹ | Buy 1 BTC @ 100,000 USDT | æ‰‹ç»­è´¹ä» BTC æ‰£é™¤ | â˜ |
| U12 | å–æ–¹æ‰£è´¹ | Sell 1 BTC @ 100,000 USDT | æ‰‹ç»­è´¹ä» USDT æ‰£é™¤ | â˜ |
| U13 | å‡€æ”¶åˆ°é‡‘é¢ | æ‰£è´¹åçš„ `credit_amount` | `= gross - fee` | â˜ |

---

## 2. é›†æˆæµ‹è¯• | Integration Tests

### 2.1 æ•°æ®æµå®Œæ•´æ€§ | Data Flow Integrity

| ID | æµ‹è¯•é¡¹ | Test Case | é¢„æœŸç»“æœ | â˜‘ï¸ |
|----|--------|-----------|---------|-----|
| I01 | ME â†’ UBSCore | Trade æ­£ç¡®ä¼ é€’ role ä¿¡æ¯ | UBSCore æ”¶åˆ°å¸¦ role çš„ Trade | â˜ |
| I02 | UBSCore â†’ BalanceEventBatch | ç”Ÿæˆæ­£ç¡®æ•°é‡çš„äº‹ä»¶ | 4 ä¸ªäº‹ä»¶ (2 TradeSettled + 2 FeeReceived) | â˜ |
| I03 | BalanceEventBatch â†’ TDengine | æ‰¹é‡å†™å…¥æˆåŠŸ | æ‰€æœ‰äº‹ä»¶æŒä¹…åŒ– | â˜ |
| I04 | BalanceEventBatch â†’ WebSocket | å®æ—¶æ¨é€æ­£ç¡® | ç”¨æˆ·æ”¶åˆ°è‡ªå·±çš„äº‹ä»¶ | â˜ |

### 2.2 å†…å­˜é…ç½®åŠ è½½ | Memory Config Loading

| ID | æµ‹è¯•é¡¹ | Test Case | é¢„æœŸç»“æœ | â˜‘ï¸ |
|----|--------|-----------|---------|-----|
| I05 | VIP ç­‰çº§åŠ è½½ | å¯åŠ¨æ—¶ä» DB åŠ è½½ | HashMap<UserId, u8> æ­£ç¡® | â˜ |
| I06 | VIP æŠ˜æ‰£åŠ è½½ | å¯åŠ¨æ—¶ä» DB åŠ è½½ | HashMap<u8, u8> æ­£ç¡® | â˜ |
| I07 | Symbol è´¹ç‡åŠ è½½ | å¯åŠ¨æ—¶ä» DB åŠ è½½ | HashMap<SymbolId, (u64, u64)> æ­£ç¡® | â˜ |
| I08 | é…ç½®çƒ­æ›´æ–° | è¿è¡Œæ—¶æ›´æ–°è´¹ç‡ | æ–°è´¹ç‡ç”Ÿæ•ˆ (å¦‚æ”¯æŒ) | â˜ |

### 2.3 BalanceEvent åŸå­æ€§ | BalanceEvent Atomicity

| ID | æµ‹è¯•é¡¹ | Test Case | é¢„æœŸç»“æœ | â˜‘ï¸ |
|----|--------|-----------|---------|-----|
| I09 | æ‰¹æ¬¡å®Œæ•´æ€§ | ä¸€æ¬¡ Trade çš„æ‰€æœ‰äº‹ä»¶ | åŒä¸€ trade_id å…³è” | â˜ |
| I10 | æŒä¹…åŒ–åŸå­æ€§ | éƒ¨åˆ†å†™å…¥å¤±è´¥æ—¶ | æ•´æ‰¹å›æ»šæˆ–é‡è¯• | â˜ |
| I11 | æ—¶é—´æˆ³ä¸€è‡´æ€§ | åŒæ‰¹æ¬¡äº‹ä»¶ | ç›¸åŒæˆ–é€’å¢çš„ ts | â˜ |

---

## 3. èµ„äº§å®ˆæ’æµ‹è¯• | Asset Conservation Tests

### 3.1 å•ç¬”äº¤æ˜“å®ˆæ’ | Single Trade Conservation

| ID | æµ‹è¯•é¡¹ | Test Case | é¢„æœŸç»“æœ | â˜‘ï¸ |
|----|--------|-----------|---------|-----|
| C01 | ä¹°æ–¹å®ˆæ’ | `debit(quote) + credit(base-fee) = 0` | ç­‰å¼æˆç«‹ | â˜ |
| C02 | å–æ–¹å®ˆæ’ | `debit(base) + credit(quote-fee) = 0` | ç­‰å¼æˆç«‹ | â˜ |
| C03 | æ”¶å…¥è´¦æˆ· | `revenue.credit = buyer_fee + seller_fee` | å®Œå…¨åŒ¹é… | â˜ |
| C04 | å…¨å±€å®ˆæ’ | `Î£ æ‰€æœ‰ BalanceEvent = 0` | ç­‰å¼æˆç«‹ | â˜ |

### 3.2 æ‰¹é‡äº¤æ˜“å®¡è®¡ | Bulk Trade Audit

| ID | æµ‹è¯•é¡¹ | Test Case | é¢„æœŸç»“æœ | â˜‘ï¸ |
|----|--------|-----------|---------|-----|
| C05 | 100K è®¢å•å®¡è®¡ | 100K è®¢å•æ³¨å…¥å | èµ„äº§å®ˆæ’éªŒè¯é€šè¿‡ | â˜ |
| C06 | Fee Ledger å¯¹è´¦ | `SUM(trades.fee) vs SUM(revenue_events)` | å®Œå…¨åŒ¹é… | â˜ |
| C07 | è·¨èµ„äº§å®¡è®¡ | å¤šäº¤æ˜“å¯¹æ··åˆ | å„èµ„äº§ç‹¬ç«‹å®ˆæ’ | â˜ |

---

## 4. æ•°æ®åº“æµ‹è¯• | Database Tests

### 4.1 Schema éªŒè¯ | Schema Validation

| ID | æµ‹è¯•é¡¹ | Test Case | é¢„æœŸç»“æœ | â˜‘ï¸ |
|----|--------|-----------|---------|-----|
| D01 | symbols_tb æ‰©å±• | `base_maker_fee`, `base_taker_fee` åˆ— | å­˜åœ¨ä¸”é»˜è®¤å€¼æ­£ç¡® | â˜ |
| D02 | users_tb æ‰©å±• | `vip_level` åˆ— | å­˜åœ¨ä¸”é»˜è®¤å€¼ = 0 | â˜ |
| D03 | balance_events stable | TDengine è¶…çº§è¡¨åˆ›å»º | æ­£ç¡®åˆ›å»º | â˜ |
| D04 | å­è¡¨è‡ªåŠ¨åˆ›å»º | æ–° user_id å†™å…¥ | è‡ªåŠ¨åˆ›å»ºå­è¡¨ | â˜ |

### 4.2 æŸ¥è¯¢æ€§èƒ½ | Query Performance

| ID | æµ‹è¯•é¡¹ | Test Case | é¢„æœŸç»“æœ | â˜‘ï¸ |
|----|--------|-----------|---------|-----|
| D05 | ç”¨æˆ·æ‰‹ç»­è´¹å†å² | å•ç”¨æˆ· 30 å¤©æŸ¥è¯¢ | < 100ms | â˜ |
| D06 | å¹³å°æ”¶å…¥ç»Ÿè®¡ | å…¨å¹³å°æ—¥ç»Ÿè®¡ | < 500ms | â˜ |
| D07 | Trade è¿½æº¯ | æŒ‰ trade_id æŸ¥å…¨éƒ¨äº‹ä»¶ | < 50ms | â˜ |
| D08 | åˆ†åŒºæ‰«ææ•ˆç‡ | ç”¨æˆ·æŸ¥è¯¢ä¸æ‰«æå…¶ä»–ç”¨æˆ· | EXPLAIN éªŒè¯ | â˜ |

---

## 5. API æµ‹è¯• | API Tests

### 5.1 Trade å“åº” | Trade Response

| ID | æµ‹è¯•é¡¹ | Test Case | é¢„æœŸç»“æœ | â˜‘ï¸ |
|----|--------|-----------|---------|-----|
| A01 | fee å­—æ®µå­˜åœ¨ | ä¸‹å•æˆäº¤å | `"fee": "0.002"` æ ¼å¼æ­£ç¡® | â˜ |
| A02 | fee_asset å­—æ®µ | ä¸‹å•æˆäº¤å | `"fee_asset": "BTC"` | â˜ |
| A03 | role å­—æ®µ | ä¸‹å•æˆäº¤å | `"role": "TAKER"` æˆ– `"MAKER"` | â˜ |
| A04 | å°æ•°ç²¾åº¦ | å„ç²¾åº¦èµ„äº§ | æ­£ç¡®çš„ display_decimals | â˜ |

### 5.2 WebSocket æ¨é€ | WebSocket Push

| ID | æµ‹è¯•é¡¹ | Test Case | é¢„æœŸç»“æœ | â˜‘ï¸ |
|----|--------|-----------|---------|-----|
| A05 | trade.update äº‹ä»¶ | æˆäº¤æ—¶ | åŒ…å« fee, fee_asset, is_maker | â˜ |
| A06 | æ¨é€å»¶è¿Ÿ | æˆäº¤åˆ°æ”¶åˆ° WS | < 10ms | â˜ |
| A07 | éšç§éš”ç¦» | ç”¨æˆ· A çš„ WS | ä¸æ”¶åˆ°ç”¨æˆ· B çš„äº‹ä»¶ | â˜ |
| A08 | å¤šè¿æ¥æ¨é€ | åŒç”¨æˆ·å¤šWSè¿æ¥ | å…¨éƒ¨æ”¶åˆ°ç›¸åŒäº‹ä»¶ | â˜ |

---

## 6. è¾¹ç•Œä¸å¼‚å¸¸æµ‹è¯• | Edge Cases & Error Handling

### 6.1 è¾¹ç•Œæƒ…å†µ | Boundary Conditions

| ID | æµ‹è¯•é¡¹ | Test Case | é¢„æœŸç»“æœ | â˜‘ï¸ |
|----|--------|-----------|---------|-----|
| E01 | é›¶è´¹ç‡äº¤æ˜“å¯¹ | `maker_fee=0, taker_fee=0` | æ­£å¸¸æˆäº¤ï¼Œfee=0 | â˜ |
| E02 | æœ€é«˜ VIP | `discount=0%` (å…è´¹) | fee=0 | â˜ |
| E03 | æœªçŸ¥ VIP ç­‰çº§ | vip_level ä¸åœ¨è¡¨ä¸­ | ä½¿ç”¨é»˜è®¤ discount=100% | â˜ |
| E04 | æœªçŸ¥ Symbol | symbol_id ä¸å­˜åœ¨ | æ‹’ç»è®¢å•æˆ–ä½¿ç”¨é»˜è®¤è´¹ç‡ | â˜ |

### 6.2 å¼‚å¸¸æ¢å¤ | Error Recovery

| ID | æµ‹è¯•é¡¹ | Test Case | é¢„æœŸç»“æœ | â˜‘ï¸ |
|----|--------|-----------|---------|-----|
| E05 | TDengine ä¸å¯ç”¨ | å†™å…¥ balance_events å¤±è´¥ | äº‹ä»¶é˜Ÿåˆ—ç¼“å†²ï¼Œä¸ä¸¢å¤± | â˜ |
| E06 | é‡å¯æ¢å¤ | UBSCore é‡å¯å | å†…å­˜é…ç½®é‡æ–°åŠ è½½ | â˜ |
| E07 | äº‹ä»¶é‡æ”¾ | ä» balance_events é‡å»º | ä½™é¢ä¸å®æ—¶ä¸€è‡´ | â˜ |

---

## 7. æ€§èƒ½æµ‹è¯• | Performance Tests

### 7.1 ååé‡ | Throughput

| ID | æµ‹è¯•é¡¹ | Test Case | é¢„æœŸç»“æœ | â˜‘ï¸ |
|----|--------|-----------|---------|-----|
| P01 | è´¹ç‡è®¡ç®— TPS | å•çº¿ç¨‹è®¡ç®— | > 1M/s (çº¯å†…å­˜) | â˜ |
| P02 | BalanceEvent ç”Ÿæˆ | æ¯ç§’ç”Ÿæˆäº‹ä»¶æ•° | > 100K/s | â˜ |
| P03 | TDengine å†™å…¥ | æ‰¹é‡å†™å…¥ TPS | > 50K events/s | â˜ |
| P04 | E2E pipeline | Trade åˆ° WS æ¨é€ | > 10K trades/s | â˜ |

### 7.2 å»¶è¿Ÿ | Latency

| ID | æµ‹è¯•é¡¹ | Test Case | é¢„æœŸç»“æœ | â˜‘ï¸ |
|----|--------|-----------|---------|-----|
| P05 | è´¹ç”¨è®¡ç®—å»¶è¿Ÿ | settle_trade è°ƒç”¨ | < 1Î¼s (å¾®ç§’) | â˜ |
| P06 | äº‹ä»¶é˜Ÿåˆ—å»¶è¿Ÿ | UBSCore â†’ Settlement | < 100Î¼s | â˜ |
| P07 | ç«¯åˆ°ç«¯å»¶è¿Ÿ | Match â†’ WS æ¨é€ | < 1ms P99 | â˜ |

### 7.3 èµ„æºä½¿ç”¨ | Resource Usage

| ID | æµ‹è¯•é¡¹ | Test Case | é¢„æœŸç»“æœ | â˜‘ï¸ |
|----|--------|-----------|---------|-----|
| P08 | å†…å­˜å ç”¨ | 10K ç”¨æˆ· + 100 äº¤æ˜“å¯¹ | HashMap å ç”¨ < 10MB | â˜ |
| P09 | CPU ä½¿ç”¨ | æ»¡è´Ÿè½½æ—¶ | è´¹ç”¨è®¡ç®— CPU < 5% | â˜ |

---

## 8. å®‰å…¨æµ‹è¯• | Security Tests

| ID | æµ‹è¯•é¡¹ | Test Case | é¢„æœŸç»“æœ | â˜‘ï¸ |
|----|--------|-----------|---------|-----|
| S01 | è´¹ç‡ç¯¡æ”¹é˜²æŠ¤ | å°è¯•é€šè¿‡ API ä¿®æ”¹è´¹ç‡ | æ‹’ç»æˆ–éœ€è¦ç®¡ç†å‘˜æƒé™ | â˜ |
| S02 | VIP ç­‰çº§æ³¨å…¥ | éæ³• vip_level å€¼ | æ‹’ç»æˆ–ä½¿ç”¨é»˜è®¤å€¼ | â˜ |
| S03 | è·¨ç”¨æˆ·è®¿é—® | æŸ¥è¯¢ä»–äºº fee å†å² | æƒé™æ‹’ç» | â˜ |
| S04 | æ”¶å…¥è´¦æˆ·ä¿æŠ¤ | å°è¯•è½¬å‡º REVENUE ä½™é¢ | æƒé™æ‹’ç» | â˜ |

---

## 9. å›å½’æµ‹è¯• | Regression Tests

| ID | æµ‹è¯•é¡¹ | Test Case | é¢„æœŸç»“æœ | â˜‘ï¸ |
|----|--------|-----------|---------|-----|
| R01 | ç°æœ‰åŠŸèƒ½å…¼å®¹ | å‡çº§ååŸæœ‰è®¢å•æµç¨‹ | æ— å›å½’ | â˜ |
| R02 | æ— è´¹ç‡æ—¶å…¼å®¹ | symbols_tb æ— è´¹ç‡åˆ—æ—¶ | ä½¿ç”¨é»˜è®¤å€¼ï¼Œç³»ç»Ÿæ­£å¸¸ | â˜ |
| R03 | API å‘åå…¼å®¹ | è€å®¢æˆ·ç«¯ä¸å¤„ç† fee å­—æ®µ | ä»èƒ½æ­£å¸¸è§£æå“åº” | â˜ |

---

## 10. éªŒæ”¶æ ‡å‡†æ€»ç»“ | Acceptance Criteria Summary

### æ ¸å¿ƒåŠŸèƒ½ (Must Pass)

- [ ] **AC-1**: äº¤æ˜“æ­£ç¡®æ‰£é™¤å¯¹åº”è§’è‰²çš„æ‰‹ç»­è´¹
- [ ] **AC-2**: Fee Ledger ä¸ Î£(trade.fee) å®Œå…¨åŒ¹é…
- [ ] **AC-3**: API å“åº”åŒ…å« fee ä¿¡æ¯
- [ ] **AC-4**: WebSocket æ¨é€åŒ…å« fee ä¿¡æ¯
- [ ] **AC-5**: èµ„äº§å®ˆæ’å®¡è®¡é€šè¿‡ (å…¨å±€ Î£ = 0)

### æ€§èƒ½æ ‡å‡† (Must Meet)

- [ ] **AC-6**: è´¹ç‡è®¡ç®— O(1) æ—¶é—´å¤æ‚åº¦
- [ ] **AC-7**: ç«¯åˆ°ç«¯å»¶è¿Ÿ < 1ms P99
- [ ] **AC-8**: TDengine å†™å…¥ > 50K events/s

### å¯é æ€§æ ‡å‡† (Must Verify)

- [ ] **AC-9**: äº‹ä»¶åŸå­æ€§ä¿è¯
- [ ] **AC-10**: æ•…éšœæ¢å¤åæ•°æ®ä¸€è‡´

---

## é™„å½•: æµ‹è¯•æ•°æ®å‡†å¤‡ | Test Data Preparation

### VIP ç­‰çº§æµ‹è¯•æ•°æ®

```sql
INSERT INTO vip_levels (level, discount_percent, description) VALUES
(0, 100, 'Normal'),
(1, 90, 'VIP 1'),
(2, 80, 'VIP 2'),
(3, 70, 'VIP 3'),
(5, 50, 'VIP 5'),
(9, 10, 'VIP 9 - Top Tier');
```

### Symbol è´¹ç‡æµ‹è¯•æ•°æ®

```sql
UPDATE symbols_tb SET 
  base_maker_fee = 1000,  -- 0.10%
  base_taker_fee = 2000   -- 0.20%
WHERE symbol = 'BTC_USDT';

-- é›¶è´¹ç‡æµ‹è¯•å¯¹
UPDATE symbols_tb SET 
  base_maker_fee = 0,
  base_taker_fee = 0
WHERE symbol = 'TEST_ZERO_FEE';
```

### æµ‹è¯•ç”¨æˆ·æ•°æ®

```sql
-- æ™®é€šç”¨æˆ·
UPDATE users_tb SET vip_level = 0 WHERE user_id = 1001;
-- VIP ç”¨æˆ·
UPDATE users_tb SET vip_level = 5 WHERE user_id = 1002;
-- æœ€é«˜ VIP
UPDATE users_tb SET vip_level = 9 WHERE user_id = 1003;
```

---

> **ğŸ“Œ æ³¨æ„**: æœ¬æ¸…å•åŸºäº `0x0C-trade-fee.md` æ¶æ„è®¾è®¡æ–‡æ¡£ç¼–å†™ã€‚å®é™…æµ‹è¯•æ—¶åº”æ ¹æ®å…·ä½“å®ç°è°ƒæ•´ã€‚
