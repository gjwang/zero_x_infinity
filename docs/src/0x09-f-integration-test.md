# 0x09-f é›†æˆæµ‹è¯•: å…¨åŠŸèƒ½éªŒæ”¶

> **ğŸ“¦ ä»£ç å˜æ›´**: [æŸ¥çœ‹ Diff](https://github.com/gjwang/zero_x_infinity/compare/v0.9-e-orderbook-depth...v0.9-f-integration-test)

> **æœ¬èŠ‚æ ¸å¿ƒç›®æ ‡**ï¼šä½¿ç”¨å†å²æ•°æ®é›†å¯¹æ‰€æœ‰ 0x09 åŠŸèƒ½è¿›è¡Œå…¨é¢é›†æˆæµ‹è¯•ï¼Œå»ºç«‹å¯é‡å¤çš„éªŒæ”¶åŸºçº¿ã€‚

---

## èƒŒæ™¯

Phase 0x09 å®ç°äº†å¤šä¸ªå…³é”®åŠŸèƒ½ï¼š

| ç« èŠ‚ | åŠŸèƒ½ | çŠ¶æ€ |
|------|------|------|
| 0x09-a | Gateway HTTP API | âœ… |
| 0x09-b | Settlement Persistence | âœ… |
| 0x09-c | WebSocket Push | âœ… |
| 0x09-d | K-Line Aggregation | âœ… |
| 0x09-e | Order Book Depth | âœ… |

ç°éœ€å°†è¿™äº›åŠŸèƒ½æ•´åˆéªŒè¯ï¼Œç¡®ä¿ç³»ç»Ÿç«¯åˆ°ç«¯æ­£ç¡®æ€§ã€‚

---

## æµ‹è¯•èŒƒå›´

### 1. Pipeline æ­£ç¡®æ€§

| æµ‹è¯• | æ•°æ®é›† | éªŒè¯ç‚¹ |
|------|--------|--------|
| å•çº¿ç¨‹ vs å¤šçº¿ç¨‹ | 100K | è¾“å‡ºå®Œå…¨ä¸€è‡´ |
| å•çº¿ç¨‹ vs å¤šçº¿ç¨‹ | 1.3M | è¾“å‡ºå®Œå…¨ä¸€è‡´ |

### 2. Settlement æŒä¹…åŒ–

| æµ‹è¯• | éªŒè¯ç‚¹ |
|------|--------|
| Orders è¡¨ | çŠ¶æ€å˜æ›´æ­£ç¡®è®°å½• |
| Trades è¡¨ | æˆäº¤æ•°æ®å®Œæ•´ |
| Balances è¡¨ | æœ€ç»ˆä½™é¢ä¸€è‡´ |

### 3. HTTP API

| ç«¯ç‚¹ | éªŒè¯ç‚¹ |
|------|--------|
| POST /create_order | è®¢å•åˆ›å»ºæˆåŠŸ |
| POST /cancel_order | å–æ¶ˆæ­£ç¡®æ‰§è¡Œ |
| GET /orders | æŸ¥è¯¢ç»“æœæ­£ç¡® |
| GET /trades | æˆäº¤è®°å½•å®Œæ•´ |
| GET /balances | ä½™é¢å‡†ç¡® |
| GET /klines | K çº¿èšåˆæ­£ç¡® |
| GET /depth | ç›˜å£æ•°æ®å‡†ç¡® |

### 4. WebSocket æ¨é€

| äº‹ä»¶ | éªŒè¯ç‚¹ |
|------|--------|
| order.update | çŠ¶æ€å˜æ›´æ¨é€ |
| trade | æˆäº¤æ¨é€ |
| balance.update | ä½™é¢å˜æ›´æ¨é€ |

### 5. æ€§èƒ½åŸºçº¿

| æŒ‡æ ‡ | ç›®æ ‡ |
|------|------|
| ååé‡ (TPS) | è®°å½•å¹¶ä¸å†å²å¯¹æ¯” |
| å»¶è¿Ÿ (P99) | è®°å½•å¹¶ä¸å†å²å¯¹æ¯” |
| å†…å­˜ä½¿ç”¨ | ç›‘æ§å³°å€¼ |

---

## æµ‹è¯•æ–¹æ¡ˆ

### Phase 1: æ•°æ®å‡†å¤‡
- ç¡®è®¤ 100K æ•°æ®é›† (`fixtures/test_100k`)
- ç¡®è®¤ 1.3M æ•°æ®é›† (`fixtures/test_with_cancel_highbal`)

### Phase 2: Pipeline éªŒè¯
- è¿è¡Œå•çº¿ç¨‹/å¤šçº¿ç¨‹å¯¹æ¯”è„šæœ¬
- éªŒè¯è¾“å‡ºä¸€è‡´æ€§

### Phase 3: Gateway é›†æˆæµ‹è¯•
- å¯åŠ¨ Gateway + TDengine
- é€šè¿‡ API æäº¤è®¢å•
- éªŒè¯å„ç«¯ç‚¹å“åº”

### Phase 4: æ€§èƒ½æµ‹è¯•
- è¿è¡Œ 1.3M æ•°æ®é›†
- è®°å½• TPS/å»¶è¿ŸæŒ‡æ ‡
- ä¸å†å²åŸºçº¿å¯¹æ¯”

---

## éªŒæ”¶æ ‡å‡†

### 1. Pipeline æ­£ç¡®æ€§ (å¿…é¡»å…¨éƒ¨é€šè¿‡)

| æµ‹è¯•é¡¹ | é€šè¿‡æ¡ä»¶ |
|--------|----------|
| 100K è¾“å‡ºå¯¹æ¯” | `diff` ç»“æœä¸ºç©º |
| 1.3M è¾“å‡ºå¯¹æ¯” | `diff` ç»“æœä¸ºç©º |
| ä½™é¢æœ€ç»ˆçŠ¶æ€ | å•çº¿ç¨‹ == å¤šçº¿ç¨‹ |
| æˆäº¤æ•°é‡ | å•çº¿ç¨‹ == å¤šçº¿ç¨‹ |

### 2. Settlement æŒä¹…åŒ– (å¿…é¡»å…¨éƒ¨é€šè¿‡)

| æµ‹è¯•é¡¹ | é€šè¿‡æ¡ä»¶ |
|--------|----------|
| Orders è®°å½•æ•° | == æ€»è®¢å•æ•° |
| Orders æœ€ç»ˆçŠ¶æ€ | æ¯æ¡è®°å½•çŠ¶æ€å®Œå…¨åŒ¹é… Pipeline è¾“å‡º |
| Trades è®°å½•æ•° | == æ€»æˆäº¤æ•° |
| Trades å†…å®¹ | æ¯æ¡æˆäº¤è®°å½•å­—æ®µå®Œå…¨åŒ¹é… |
| Balances æœ€ç»ˆå€¼ | æ¯ä¸ªè´¦æˆ·æ¯ä¸ªèµ„äº§å®Œå…¨åŒ¹é… |
| æ•°æ®ç²¾åº¦ | ä»·æ ¼/æ•°é‡ä¿ç•™æ­£ç¡®å°æ•°ä½ |

> [!IMPORTANT]
> **ä¸€è‡´æ€§è¦æ±‚**ï¼šæ ¸å¿ƒèµ„äº§ (avail, frozen) å’Œè®¢å•çŠ¶æ€ (filled_qty, status) å¿…é¡» 100% ä¸€è‡´ã€‚
> 
> **è¯´æ˜**ï¼š
> 1. **ç‰ˆæœ¬å· (lock_version)**ï¼šç”±äº 0x09-f å¼•å…¥äº†ç‰ˆæœ¬ç©ºé—´éš”ç¦»ï¼Œä¸åŒæ¨¡å¼ä¸‹å¯èƒ½å­˜åœ¨æ¼‚ç§»ï¼ŒéªŒè¯æ—¶ä»…æ¯”å¯¹æ ¸å¿ƒä½™é¢ã€‚
> 2. **æµæ°´æ—¥å¿— (Ledger CSV)**ï¼šå¤šçº¿ç¨‹æ¨¡å¼å·²åˆ‡æ¢ä¸º DB (TDengine) æŒä¹…åŒ–ï¼Œä¸å†åŒæ­¥å†™å…¥æœ¬åœ° `t2_events.csv`ï¼Œå›å½’æµ‹è¯•é‡ç‚¹è½¬å‘ DB å†…éƒ¨ä¸€è‡´æ€§ã€‚

**éªŒè¯å·¥å…·**ï¼šå¤æ‚å¯¹æ¯”ä½¿ç”¨ Python3 è„šæœ¬ (`scripts/compare_settlement.py`)

### 3. HTTP API (å¿…é¡»å…¨éƒ¨é€šè¿‡)

| ç«¯ç‚¹ | é€šè¿‡æ¡ä»¶ |
|------|----------|
| POST /create_order | `code: 0`, è¿”å› order_id |
| POST /cancel_order | çŠ¶æ€å˜ä¸º CANCELLED |
| GET /orders | åˆ—è¡¨æ ¼å¼æ­£ç¡®ï¼Œåˆ†é¡µæœ‰æ•ˆ |
| GET /trades | è¿”å›æˆäº¤è®°å½• |
| GET /balances | ä½™é¢å€¼æ­£ç¡® |
| GET /klines | OHLCV æ•°æ®æ­£ç¡® |
| GET /depth | bids/asks æŒ‰ä»·æ ¼æ’åº |

### 4. WebSocket æ¨é€ (å¿…é¡»å…¨éƒ¨é€šè¿‡)

| äº‹ä»¶ | é€šè¿‡æ¡ä»¶ |
|------|----------|
| order.update | æ”¶åˆ°è®¢å•çŠ¶æ€å˜æ›´ |
| trade | æ”¶åˆ°æˆäº¤äº‹ä»¶ |
| balance.update | æ”¶åˆ°ä½™é¢å˜æ›´ |

### 5. æ€§èƒ½æŒ‡æ ‡ (è®°å½•åŸºçº¿)

| æŒ‡æ ‡ | è®°å½•é¡¹ |
|------|--------|
| 100K TPS | è®°å½•ååé‡ |
| 1.3M TPS | è®°å½•ååé‡ |
| P99 å»¶è¿Ÿ | å•è®¢å•å¤„ç†å»¶è¿Ÿ |
| å†…å­˜å³°å€¼ | è¿è¡Œæ—¶å†…å­˜å ç”¨ |

---

## æ–‡ä»¶ç»“æ„

```
scripts/
â”œâ”€â”€ test_integration_full.sh     # ä¸»æµ‹è¯•è„šæœ¬ [NEW]
â”œâ”€â”€ compare_settlement.py        # Python3 å¯¹æ¯”è„šæœ¬ [NEW]
â”œâ”€â”€ test_pipeline_compare.sh     # å·²æœ‰
â”œâ”€â”€ test_gateway_e2e.sh          # å·²æœ‰
â””â”€â”€ ...

docs/src/
â””â”€â”€ 0x09-f-integration-test.md   # æœ¬æ–‡æ¡£ [NEW]
```

---

## æµ‹è¯•äº§ç‰©ä¸åŸºçº¿

### ç”ŸæˆåŸºçº¿

æµ‹è¯•å®Œæˆåï¼Œæ•´ç†ä»¥ä¸‹äº§ç‰©ä½œä¸ºæœªæ¥å›å½’æµ‹è¯•çš„åŸºçº¿ï¼š

| äº§ç‰© | è·¯å¾„ | ç”¨é€” |
|------|------|------|
| 100K è¾“å‡º | `baseline/100k/` | Pipeline æ­£ç¡®æ€§å¯¹æ¯” |
| 1.3M è¾“å‡º | `baseline/1.3m/` | Pipeline æ­£ç¡®æ€§å¯¹æ¯” |
| æ€§èƒ½æŒ‡æ ‡ | `docs/src/perf-history/` | æ€§èƒ½å›å½’æ£€æµ‹ |

### åŸºçº¿æ–‡ä»¶

```
baseline/
â”œâ”€â”€ 100k/
â”‚   â”œâ”€â”€ orders_final.csv       # æœ€ç»ˆè®¢å•çŠ¶æ€
â”‚   â”œâ”€â”€ trades.csv             # æˆäº¤è®°å½•
â”‚   â””â”€â”€ balances_final.csv     # æœ€ç»ˆä½™é¢
â”œâ”€â”€ 1.3m/
â”‚   â”œâ”€â”€ orders_final.csv
â”‚   â”œâ”€â”€ trades.csv
â”‚   â””â”€â”€ balances_final.csv
â””â”€â”€ README.md                   # åŸºçº¿è¯´æ˜ï¼ˆç‰ˆæœ¬ã€ç”Ÿæˆæ—¶é—´ï¼‰
```

### åŸºçº¿æ•´ç†ä¸å›å½’ (Regression)

è„šæœ¬å·²æ”¯æŒåŸºçº¿ä¿æŠ¤å’Œå›å½’æ£€æŸ¥ï¼š

- **ç”Ÿæˆ/æ›´æ–°åŸºçº¿**ï¼šåªæœ‰åœ¨ç¡®è®¤æ–°è¾“å‡ºä¸º Ground Truth æ—¶ä½¿ç”¨ï¼š
  ```bash
  ./scripts/generate_baseline.sh 100k -f
  ./scripts/generate_baseline.sh 1.3m -f
  ```
- **å›å½’æµ‹è¯•**ï¼š`test_pipeline_compare.sh` ä¼šè‡ªåŠ¨æ£€æµ‹ `baseline/` ç›®å½•å¹¶è¿›è¡Œå¯¹æ¯”ï¼š
  ```bash
  # è‡ªåŠ¨æ‰§è¡Œ ST vs MT ä»¥åŠ MT vs Baseline
  ./scripts/test_pipeline_compare.sh 100k
  ```
- **å…¨é›†æˆæµ‹è¯•**ï¼š
  ```bash
  ./scripts/test_integration_full.sh
  ```

---

## å¤§æ•°æ®é›†æµ‹è¯•æ³¨æ„äº‹é¡¹

> [!IMPORTANT]
> è¿è¡Œ 1.3M æ•°æ®é›†æµ‹è¯•æ—¶éœ€è¦ç‰¹åˆ«æ³¨æ„ä»¥ä¸‹å‡ ç‚¹ï¼š

### 1. è¾“å‡ºé‡å®šå‘ï¼ˆå¿…é¡»ï¼‰

å¤§æ•°æ®é›†æµ‹è¯•ä¼šäº§ç”Ÿå¤§é‡æ—¥å¿—ï¼Œ**å¿…é¡»**å°†è¾“å‡ºé‡å®šå‘åˆ°æ–‡ä»¶ä»¥é¿å… IDE å¡é¡¿ï¼š

```bash
# ä½¿ç”¨ nohup åå°æ‰§è¡Œï¼Œè¾“å‡ºé‡å®šå‘åˆ°æ–‡ä»¶
nohup ./scripts/test_pipeline_compare.sh highbal > /tmp/pipeline.log 2>&1 &

# ç›‘æ§æµ‹è¯•è¿›åº¦
tail -f /tmp/pipeline.log

# æŸ¥çœ‹æœ€ç»ˆç»“æœ
grep -A20 "Comparing Results" /tmp/pipeline.log
```

### 2. æ‰§è¡Œæ—¶é—´é¢„æœŸ

| é˜¶æ®µ | å•çº¿ç¨‹æ¨¡å¼ | å¤šçº¿ç¨‹æ¨¡å¼ |
|------|------------|------------|
| 1.3M è®¢å•å¤„ç† | ~16 ç§’ | ~100+ ç§’ |
| å®Œæ•´æµ‹è¯•æ—¶é—´ | ~25 ç§’ | ~500+ ç§’ |

> [!NOTE]
> å¤šçº¿ç¨‹æ¨¡å¼è¾ƒæ…¢æ˜¯å› ä¸ºåŒ…å«å®Œæ•´çš„ persistence å’Œ event generation å¼€é”€ã€‚

### 3. Balance Events å·®å¼‚è¯´æ˜

`verify_balance_events.py` è„šæœ¬å¯èƒ½æŠ¥å‘Š lock events æ•°é‡ä¸åŒ¹é…ï¼š

```
Lock events (1000000) != Accepted orders (1300000)
```

è¿™æ˜¯**æ­£å¸¸é¢„æœŸè¡Œä¸º**ï¼š
- Lock events = **Place orders** (1,000,000)
- Cancel orders (300,000) ä¸ä¼šäº§ç”Ÿæ–°çš„ lock events
- æœ€ç»ˆ frozen balances éªŒè¯é€šè¿‡å³è¡¨ç¤ºæ­£ç¡®

### 4. Push Queue æº¢å‡ºè­¦å‘Š

å¤šçº¿ç¨‹æ¨¡å¼ä¼šå‡ºç°å¤§é‡ `[PUSH] queue full` è­¦å‘Šï¼š

```
[PUSH] âŒ Failed to push OrderUpdate - queue full!
```

è¿™æ˜¯**é¢„æœŸè¡Œä¸º**ï¼Œä¸å½±å“æµ‹è¯•ç»“æœã€‚push queue å®¹é‡æœ‰é™ï¼Œé«˜é€Ÿå¤„ç†æ—¶æ¶ˆè´¹è·Ÿä¸ä¸Šç”Ÿäº§æ˜¯æ­£å¸¸çš„ã€‚

### 5. æµ‹è¯•è„šæœ¬è¶…æ—¶è®¾ç½®

`test_integration_full.sh` å¯¹å„é˜¶æ®µè®¾ç½®äº†è¶…æ—¶ï¼š
- 100K æµ‹è¯•: 600 ç§’
- 1.3M æµ‹è¯•: 3600 ç§’

å¦‚éœ€è°ƒæ•´ï¼Œä¿®æ”¹è„šæœ¬ä¸­çš„ `timeout` å‚æ•°ã€‚

---

## æµ‹è¯•æŠ¥å‘Š

### Phase 1: Gateway E2E æ³¨å…¥æµ‹è¯•

è¯¦è§ [E2E æµ‹è¯•æŠ¥å‘Š](./0x09-f-e2e-test-report.md)

### Phase 2: é›†æˆæµ‹è¯•ç»“æœ (2025-12-21)

#### æ€§èƒ½åŸºçº¿

| ç‰ˆæœ¬ | æ—¶é—´ | é€Ÿç‡ | vs åŸºçº¿ |
|------|------|------|---------|
| åŸºçº¿ (urllib) | 576s | 174/s | - |
| HTTP Keep-Alive | 117s | 857/s | +393% |
| **ä¼˜åŒ–å (å½“å‰)** | **69s** | **1,435/s** | **+725%** |

#### Pipeline æ­£ç¡®æ€§ (1.3M Dataset) âœ…

| æµ‹è¯•é¡¹ | ç»“æœ |
|--------|------|
| 100K å•çº¿ç¨‹ vs å¤šçº¿ç¨‹ | âœ… æ ¸å¿ƒä½™é¢ä¸€è‡´ |
| 1.3M å•çº¿ç¨‹ vs å¤šçº¿ç¨‹ | âœ… æ ¸å¿ƒä½™é¢ä¸€è‡´ (è€—æ—¶ 101s, 12.7K/s) |
| æˆäº¤æ•°é‡åŒ¹é… (1.3M) | âœ… **667,567** |
| ä½™é¢æœ€ç»ˆçŠ¶æ€ (1.3M) | âœ… **100% MATCH** (user, asset, avail, frozen) |

#### Settlement æŒä¹…åŒ–è¯¦ç»†æ¯”è¾ƒ (100K Dataset)

##### Orders æ¯”è¾ƒ

| æ¯”è¾ƒé¡¹ | Pipeline | TDengine | çŠ¶æ€ |
|--------|----------|----------|------|
| **è®°å½•æ•°** | 100,000 | 147,886 | âœ… MATCH (100k + 47,886 trades) |
| order_id | - | - | âœ… 100% åŒ¹é… |
| user_id | - | - | âœ… 100% åŒ¹é… |
| side | - | - | âœ… 100% åŒ¹é… |
| price | - | - | âœ… 100% åŒ¹é… |
| qty | - | - | âœ… 100% åŒ¹é… |
| **filled_qty** | 100% åŒ¹é… | 100% åŒ¹é… | âœ… **100% åŒ¹é…** |
| **status** | 100% åŒ¹é… | 100% åŒ¹é… | âœ… **100% åŒ¹é…** (å« Convention å¤„ç†) |

> [!NOTE]
> **Append-only æ¨¡å‹å·²éªŒè¯**ï¼šTDengine `orders` è¡¨ç°åœ¨è®°å½•æ¯æ¬¡çŠ¶æ€å˜æ›´ã€‚147,886 è¡Œå®Œç¾å¯¹åº” 100,000 æ¬¡æäº¤ + 47,886 æ¬¡æˆäº¤æ›´æ–°ã€‚

##### Trades æ¯”è¾ƒ

| æ¯”è¾ƒé¡¹ | Pipeline | TDengine | çŠ¶æ€ |
|--------|----------|----------|------|
| **è®°å½•æ•°** | 47,886 | 47,886 | âœ… **100% MATCH** |
| ç»“æ„éªŒè¯ | Maker/Taker åŒæ–¹è®°å½• | æ­£ç¡®è®°å½• (role 0/1) | âœ… **100% MATCH** |
| **æˆäº¤é‡åŒ¹é…** | - | - | âœ… **100% åŒ¹é…** (å¯¹é½ Orders filled_qty) |

> [!NOTE]
> **æˆäº¤ä¸€è‡´æ€§å·²éªŒè¯**ï¼šé€šè¿‡ `compare_trades_tdengine.py` éªŒè¯äº† TDengine å†…éƒ¨ M/T æ’®åˆå¯¹çš„å®Œæ•´æ€§ï¼Œå¹¶ç¡®è®¤æˆäº¤æ€»é‡ä¸ `orders` è¡¨çš„ `filled_qty` 100% é—­ç¯ã€‚

##### Balances æ¯”è¾ƒ

| æ¯”è¾ƒé¡¹ | Pipeline | TDengine | çŠ¶æ€ |
|--------|----------|----------|------|
| **è®°å½•æ•°** | 2,000 | 2,000 | âœ… **100% MATCH** |
| **avail** | - | - | âœ… **100% åŒ¹é…** |
| **frozen** | - | - | âœ… **100% åŒ¹é…** |

> [!NOTE]
> Balances 100% åŒ¹é…ã€‚ä¹‹å‰å‘ç°çš„ 4 æ¡ç¼ºå¤±è®°å½•å·²é€šè¿‡ä¿®å¤ `balances_init.csv` è§£å†³ã€‚

---

#### é›†æˆç»“è®º (1.3M) âœ…

1.3M é«˜å¹¶å‘æ•°æ®é›†ï¼ˆå« 300K æ’¤å•ï¼‰æµ‹è¯•åœ†æ»¡æˆåŠŸï¼š
- **ä¸€è‡´æ€§**ï¼šBalances ä¸ Trades å®ç° 100% å­—æ®µçº§é—­ç¯ä¸€è‡´æ€§ã€‚
- **ç¨³å®šæ€§**ï¼šç½‘å…³åœ¨è¿ç»­ 15 åˆ†é’Ÿé«˜å‹ä¸‹æœªå‡ºç°é™çº§æˆ– OOMã€‚
- **æ€§èƒ½**ï¼šæ³¨å…¥é€Ÿç‡ç¨³å®šåœ¨ **1,377/s**ï¼Œä¸ 100K åŸºçº¿ä¿æŒä¸€è‡´ã€‚

ç»¼ä¸Šæ‰€è¿°ï¼Œ0x09 é˜¶æ®µçš„æ‰€æœ‰æŒä¹…åŒ–ä¸ç½‘å…³åŠŸèƒ½å·²å…·å¤‡ç”Ÿäº§çº§ç¨³å®šæ€§ã€‚

---

#### HTTP API âœ…

| ç«¯ç‚¹ | çŠ¶æ€ |
|------|------|
| GET /health | âœ… |
| POST /create_order | âœ… |
| GET /trades | âœ… |
| GET /klines | âœ… |
| GET /depth | âœ… |

#### éªŒè¯è„šæœ¬

```bash
# å®Œæ•´ Settlement éªŒè¯
./scripts/verify_settlement.sh

# Orders å­—æ®µçº§åˆ«æ¯”è¾ƒ
python3 scripts/compare_orders_tdengine.py --pipeline output/t2_orderbook.csv

# Balances å­—æ®µçº§åˆ«æ¯”è¾ƒ (ä½¿ç”¨ REST API)
python3 scripts/compare_balances_tdengine.py --pipeline output/t2_balances_final.csv

# 100K æ€§èƒ½æµ‹è¯•
python3 scripts/inject_orders.py --input fixtures/orders.csv --limit 0
```
