# 0x09-f é›†æˆæµ‹è¯•: å…¨åŠŸèƒ½éªŒæ”¶

> **ğŸ“¦ ä»£ç å˜æ›´**: [æŸ¥çœ‹ Diff](https://github.com/gjwang/zero_x_infinity/compare/v0.9-e-orderbook-depth...v0.9-f-integration-test)

> **æœ¬èŠ‚æ ¸å¿ƒç›®æ ‡**ï¼šä½¿ç”¨å†å²æ•°æ®é›†å¯¹æ‰€æœ‰ 0x09 åŠŸèƒ½è¿›è¡Œå…¨é¢é›†æˆæµ‹è¯•ï¼Œå»ºç«‹å¯é‡å¤çš„éªŒæ”¶åŸºçº¿ã€‚

---

## èƒŒæ™¯

Phase 0x09 å®ç°äº†å¤šä¸ªå…³é”®åŠŸèƒ½ï¼š

| ç« èŠ‚ | åŠŸèƒ½ | çŠ¶æ€ |
|------|------|------|
| 0x09-a | Gateway HTTP API | âœ… |
| 0x09-b | Settlement Persistence | âœ… |
| 0x09-c | WebSocket Push | âœ… |
| 0x09-d | K-Line Aggregation | âœ… |
| 0x09-e | Order Book Depth | âœ… |

ç°éœ€å°†è¿™äº›åŠŸèƒ½æ•´åˆéªŒè¯ï¼Œç¡®ä¿ç³»ç»Ÿç«¯åˆ°ç«¯æ­£ç¡®æ€§ã€‚

---

## æµ‹è¯•èŒƒå›´

### 1. Pipeline æ­£ç¡®æ€§

| æµ‹è¯• | æ•°æ®é›† | éªŒè¯ç‚¹ |
|------|--------|--------|
| å•çº¿ç¨‹ vs å¤šçº¿ç¨‹ | 100K | è¾“å‡ºå®Œå…¨ä¸€è‡´ |
| å•çº¿ç¨‹ vs å¤šçº¿ç¨‹ | 1.3M | è¾“å‡ºå®Œå…¨ä¸€è‡´ |

### 2. Settlement æŒä¹…åŒ–

| æµ‹è¯• | éªŒè¯ç‚¹ |
|------|--------|
| Orders è¡¨ | çŠ¶æ€å˜æ›´æ­£ç¡®è®°å½• |
| Trades è¡¨ | æˆäº¤æ•°æ®å®Œæ•´ |
| Balances è¡¨ | æœ€ç»ˆä½™é¢ä¸€è‡´ |

### 3. HTTP API

| ç«¯ç‚¹ | éªŒè¯ç‚¹ |
|------|--------|
| POST /create_order | è®¢å•åˆ›å»ºæˆåŠŸ |
| POST /cancel_order | å–æ¶ˆæ­£ç¡®æ‰§è¡Œ |
| GET /orders | æŸ¥è¯¢ç»“æœæ­£ç¡® |
| GET /trades | æˆäº¤è®°å½•å®Œæ•´ |
| GET /balances | ä½™é¢å‡†ç¡® |
| GET /klines | K çº¿èšåˆæ­£ç¡® |
| GET /depth | ç›˜å£æ•°æ®å‡†ç¡® |

### 4. WebSocket æ¨é€

| äº‹ä»¶ | éªŒè¯ç‚¹ |
|------|--------|
| order.update | çŠ¶æ€å˜æ›´æ¨é€ |
| trade | æˆäº¤æ¨é€ |
| balance.update | ä½™é¢å˜æ›´æ¨é€ |

### 5. æ€§èƒ½åŸºçº¿

| æŒ‡æ ‡ | ç›®æ ‡ |
|------|------|
| ååé‡ (TPS) | è®°å½•å¹¶ä¸å†å²å¯¹æ¯” |
| å»¶è¿Ÿ (P99) | è®°å½•å¹¶ä¸å†å²å¯¹æ¯” |
| å†…å­˜ä½¿ç”¨ | ç›‘æ§å³°å€¼ |

---

## æµ‹è¯•æ–¹æ¡ˆ

### Phase 1: æ•°æ®å‡†å¤‡
- ç¡®è®¤ 100K æ•°æ®é›† (`fixtures/test_100k`)
- ç¡®è®¤ 1.3M æ•°æ®é›† (`fixtures/test_with_cancel_highbal`)

### Phase 2: Pipeline éªŒè¯
- è¿è¡Œå•çº¿ç¨‹/å¤šçº¿ç¨‹å¯¹æ¯”è„šæœ¬
- éªŒè¯è¾“å‡ºä¸€è‡´æ€§

### Phase 3: Gateway é›†æˆæµ‹è¯•
- å¯åŠ¨ Gateway + TDengine
- é€šè¿‡ API æäº¤è®¢å•
- éªŒè¯å„ç«¯ç‚¹å“åº”

### Phase 4: æ€§èƒ½æµ‹è¯•
- è¿è¡Œ 1.3M æ•°æ®é›†
- è®°å½• TPS/å»¶è¿ŸæŒ‡æ ‡
- ä¸å†å²åŸºçº¿å¯¹æ¯”

---

## éªŒæ”¶æ ‡å‡†

### 1. Pipeline æ­£ç¡®æ€§ (å¿…é¡»å…¨éƒ¨é€šè¿‡)

| æµ‹è¯•é¡¹ | é€šè¿‡æ¡ä»¶ |
|--------|----------|
| 100K è¾“å‡ºå¯¹æ¯” | `diff` ç»“æœä¸ºç©º |
| 1.3M è¾“å‡ºå¯¹æ¯” | `diff` ç»“æœä¸ºç©º |
| ä½™é¢æœ€ç»ˆçŠ¶æ€ | å•çº¿ç¨‹ == å¤šçº¿ç¨‹ |
| æˆäº¤æ•°é‡ | å•çº¿ç¨‹ == å¤šçº¿ç¨‹ |

### 2. Settlement æŒä¹…åŒ– (å¿…é¡»å…¨éƒ¨é€šè¿‡)

| æµ‹è¯•é¡¹ | é€šè¿‡æ¡ä»¶ |
|--------|----------|
| Orders è®°å½•æ•° | == æ€»è®¢å•æ•° |
| Orders æœ€ç»ˆçŠ¶æ€ | æ¯æ¡è®°å½•çŠ¶æ€å®Œå…¨åŒ¹é… Pipeline è¾“å‡º |
| Trades è®°å½•æ•° | == æ€»æˆäº¤æ•° |
| Trades å†…å®¹ | æ¯æ¡æˆäº¤è®°å½•å­—æ®µå®Œå…¨åŒ¹é… |
| Balances æœ€ç»ˆå€¼ | æ¯ä¸ªè´¦æˆ·æ¯ä¸ªèµ„äº§å®Œå…¨åŒ¹é… |
| æ•°æ®ç²¾åº¦ | ä»·æ ¼/æ•°é‡ä¿ç•™æ­£ç¡®å°æ•°ä½ |

> [!IMPORTANT]
> **ä¸€è‡´æ€§è¦æ±‚**ï¼šä¸ä»…æ•°é‡ä¸€è‡´ï¼Œ**æ‰€æœ‰å­—æ®µæœ€ç»ˆçŠ¶æ€å¿…é¡»å®Œå…¨ä¸€è‡´**ã€‚
> å¦‚æœ‰ä¸­é—´è¿‡ç¨‹æ•°æ®ï¼ˆå¦‚ Ledgerï¼‰ï¼Œè¿‡ç¨‹ä¹Ÿéœ€å®Œå…¨ä¸€è‡´ã€‚

**éªŒè¯å·¥å…·**ï¼šå¤æ‚å¯¹æ¯”ä½¿ç”¨ Python3 è„šæœ¬ (`scripts/compare_settlement.py`)

### 3. HTTP API (å¿…é¡»å…¨éƒ¨é€šè¿‡)

| ç«¯ç‚¹ | é€šè¿‡æ¡ä»¶ |
|------|----------|
| POST /create_order | `code: 0`, è¿”å› order_id |
| POST /cancel_order | çŠ¶æ€å˜ä¸º CANCELLED |
| GET /orders | åˆ—è¡¨æ ¼å¼æ­£ç¡®ï¼Œåˆ†é¡µæœ‰æ•ˆ |
| GET /trades | è¿”å›æˆäº¤è®°å½• |
| GET /balances | ä½™é¢å€¼æ­£ç¡® |
| GET /klines | OHLCV æ•°æ®æ­£ç¡® |
| GET /depth | bids/asks æŒ‰ä»·æ ¼æ’åº |

### 4. WebSocket æ¨é€ (å¿…é¡»å…¨éƒ¨é€šè¿‡)

| äº‹ä»¶ | é€šè¿‡æ¡ä»¶ |
|------|----------|
| order.update | æ”¶åˆ°è®¢å•çŠ¶æ€å˜æ›´ |
| trade | æ”¶åˆ°æˆäº¤äº‹ä»¶ |
| balance.update | æ”¶åˆ°ä½™é¢å˜æ›´ |

### 5. æ€§èƒ½æŒ‡æ ‡ (è®°å½•åŸºçº¿)

| æŒ‡æ ‡ | è®°å½•é¡¹ |
|------|--------|
| 100K TPS | è®°å½•ååé‡ |
| 1.3M TPS | è®°å½•ååé‡ |
| P99 å»¶è¿Ÿ | å•è®¢å•å¤„ç†å»¶è¿Ÿ |
| å†…å­˜å³°å€¼ | è¿è¡Œæ—¶å†…å­˜å ç”¨ |

---

## æ–‡ä»¶ç»“æ„

```
scripts/
â”œâ”€â”€ test_integration_full.sh     # ä¸»æµ‹è¯•è„šæœ¬ [NEW]
â”œâ”€â”€ compare_settlement.py        # Python3 å¯¹æ¯”è„šæœ¬ [NEW]
â”œâ”€â”€ test_pipeline_compare.sh     # å·²æœ‰
â”œâ”€â”€ test_gateway_e2e.sh          # å·²æœ‰
â””â”€â”€ ...

docs/src/
â””â”€â”€ 0x09-f-integration-test.md   # æœ¬æ–‡æ¡£ [NEW]
```

---

## æµ‹è¯•äº§ç‰©ä¸åŸºçº¿

### ç”ŸæˆåŸºçº¿

æµ‹è¯•å®Œæˆåï¼Œæ•´ç†ä»¥ä¸‹äº§ç‰©ä½œä¸ºæœªæ¥å›å½’æµ‹è¯•çš„åŸºçº¿ï¼š

| äº§ç‰© | è·¯å¾„ | ç”¨é€” |
|------|------|------|
| 100K è¾“å‡º | `baseline/100k/` | Pipeline æ­£ç¡®æ€§å¯¹æ¯” |
| 1.3M è¾“å‡º | `baseline/1.3m/` | Pipeline æ­£ç¡®æ€§å¯¹æ¯” |
| æ€§èƒ½æŒ‡æ ‡ | `docs/src/perf-history/` | æ€§èƒ½å›å½’æ£€æµ‹ |

### åŸºçº¿æ–‡ä»¶

```
baseline/
â”œâ”€â”€ 100k/
â”‚   â”œâ”€â”€ orders_final.csv       # æœ€ç»ˆè®¢å•çŠ¶æ€
â”‚   â”œâ”€â”€ trades.csv             # æˆäº¤è®°å½•
â”‚   â””â”€â”€ balances_final.csv     # æœ€ç»ˆä½™é¢
â”œâ”€â”€ 1.3m/
â”‚   â”œâ”€â”€ orders_final.csv
â”‚   â”œâ”€â”€ trades.csv
â”‚   â””â”€â”€ balances_final.csv
â””â”€â”€ README.md                   # åŸºçº¿è¯´æ˜ï¼ˆç‰ˆæœ¬ã€ç”Ÿæˆæ—¶é—´ï¼‰
```

### å¯é‡å¤æ‰§è¡Œ

```bash
# ä¸€é”®è¿è¡Œå…¨éƒ¨æµ‹è¯•
./scripts/test_integration_full.sh

# ç”Ÿæˆæ–°åŸºçº¿
./scripts/generate_baseline.sh 100k
./scripts/generate_baseline.sh 1.3m
```

