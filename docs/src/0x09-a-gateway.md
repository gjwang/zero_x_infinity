# 0x09-a Gateway: å®¢æˆ·ç«¯æ¥å…¥å±‚ (Client Access Layer)

> **ğŸ“¦ ä»£ç å˜æ›´**: [æŸ¥çœ‹ Diff](https://github.com/gjwang/zero_x_infinity/compare/v0.8-h-performance-monitoring...v0.9-a-gateway)

> **æ ¸å¿ƒç›®æ ‡**ï¼šå®ç°ä¸€ä¸ªç”Ÿäº§çº§çš„ HTTP/WebSocket Gatewayï¼Œè¿æ¥å®¢æˆ·ç«¯ä¸äº¤æ˜“æ ¸å¿ƒç³»ç»Ÿã€‚

---

## èƒŒæ™¯ï¼šä»æ ¸å¿ƒåˆ°å®Œæ•´ MVP

åœ¨å‰é¢çš„ç« èŠ‚ä¸­ï¼Œæˆ‘ä»¬å·²ç»æ„å»ºäº†ä¸€ä¸ªåŠŸèƒ½å®Œæ•´çš„**äº¤æ˜“æ ¸å¿ƒç³»ç»Ÿ**ï¼š

| ç»„ä»¶ | çŠ¶æ€ | ç« èŠ‚ |
|------|------|------|
| OrderBook (BTreeMap) | âœ… | 0x04 |
| Balance Management | âœ… | 0x05-0x06 |
| Matching Engine | âœ… | 0x08 |
| Multi-Thread Pipeline | âœ… | 0x08-f/g |
| Performance Monitoring | âœ… | 0x08-h |

ä½†è¦æˆä¸ºä¸€ä¸ªå¯ç”¨çš„ **MVP (Minimum Viable Product)**ï¼Œè¿˜éœ€è¦ä»¥ä¸‹è¾…åŠ©ç³»ç»Ÿï¼š

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        Complete Trading System MVP                       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                          â”‚
â”‚  Client (Web/Mobile/API)                                                 â”‚
â”‚       â”‚                                                                  â”‚
â”‚       â–¼                                                                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                                     â”‚
â”‚  â”‚   0x09-a        â”‚  â† æœ¬ç« ï¼šæ¥æ”¶è®¢å•ï¼Œè¿”å›å“åº”                           â”‚
â”‚  â”‚   Gateway       â”‚                                                     â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                                     â”‚
â”‚           â”‚                                                              â”‚
â”‚           â–¼                                                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”‚
â”‚  â”‚              Trading Core (å·²å®Œæˆ)                               â”‚     â”‚
â”‚  â”‚  Ingestion â†’ UBSCore â†’ ME â†’ Settlement                          â”‚     â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚
â”‚           â”‚                                                              â”‚
â”‚           â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚
â”‚           â”‚                                                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”             â”‚
â”‚  â”‚   0x09-b        â”‚  â”‚   0x09-c       â”‚  â”‚   0x09-d       â”‚             â”‚
â”‚  â”‚   Settlement    â”‚  â”‚   K-Line       â”‚  â”‚   WebSocket    â”‚             â”‚
â”‚  â”‚   Persistence   â”‚  â”‚   Aggregation  â”‚  â”‚   Push         â”‚             â”‚
â”‚  â”‚   (DB Write)    â”‚  â”‚   (Candles)    â”‚  â”‚   (Real-time)  â”‚             â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜             â”‚
â”‚                                                                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 0x09 ç³»åˆ—ç« èŠ‚è§„åˆ’

| ç« èŠ‚ | ä¸»é¢˜ | æ ¸å¿ƒåŠŸèƒ½ |
|------|------|----------|
| **0x09-a** | Gateway | HTTP/WS è®¢å•æ¥å…¥ã€Pre-Check |
| 0x09-b | Settlement Persistence | ç”¨æˆ·ä½™é¢ã€è®¢å•ã€æˆäº¤å…¥åº“ |
| 0x09-c | K-Line Aggregation | å®æ—¶ K çº¿èšåˆ |
| 0x09-d | WebSocket Push | å®æ—¶è¡Œæƒ…æ¨é€ |

---

## 1. Gateway è®¾è®¡

### 1.1 èŒè´£

Gateway æ˜¯**å®¢æˆ·ç«¯ä¸äº¤æ˜“ç³»ç»Ÿçš„å”¯ä¸€å…¥å£**ï¼š

| èŒè´£ | è¯´æ˜ |
|------|------|
| **åè®®è½¬æ¢** | HTTP/WebSocket â†’ å†…éƒ¨æ¶ˆæ¯æ ¼å¼ |
| **èº«ä»½éªŒè¯** | API Key / JWT è®¤è¯ |
| **Pre-Check** | å¿«é€Ÿä½™é¢æ ¡éªŒï¼Œè¿‡æ»¤æ— æ•ˆè¯·æ±‚ |
| **é™æµ** | Rate Limitingï¼Œé˜²æ­¢ DDoS |
| **å“åº”** | åŒæ­¥è¿”å›è®¢å•æ¥æ”¶ç¡®è®¤ |

### 1.2 ä¸ºä»€ä¹ˆ Gateway + Trading Core åˆ†ç¦»ï¼Ÿ

| æ¶æ„ | é—®é¢˜ | åˆ†ç¦»åä¼˜åŠ¿ |
|------|------|-----------|
| Gateway ç›´æ¥å¤„ç†è®¢å• | ç½‘ç»œ I/O é˜»å¡æ’®åˆ | ç½‘ç»œå¤„ç†ä¸æ’®åˆè§£è€¦ |
| å•ç‚¹æ¶æ„ | æ— æ³•æ°´å¹³æ‰©å±• | Gateway å¯å¤šå®ä¾‹éƒ¨ç½² |
| åŒæ­¥å¤„ç† | å»¶è¿Ÿä¸å¯æ§ | å¼‚æ­¥é˜Ÿåˆ—ï¼Œå»¶è¿Ÿå¯é¢„æµ‹ |

### 1.3 æŠ€æœ¯é€‰å‹

| ç»„ä»¶ | é€‰æ‹© | ç†ç”± |
|------|------|------|
| HTTP Framework | `axum` | é«˜æ€§èƒ½ã€tokio åŸç”Ÿã€ç±»å‹å®‰å…¨ |
| WebSocket | `tokio-tungstenite` | æˆç†Ÿç¨³å®š |
| Serialization | `serde` + JSON | æ ‡å‡†ã€è°ƒè¯•å‹å¥½ |
| Rate Limiting | `tower` middleware | å¯ç»„åˆã€ç”Ÿäº§çº§ |

---

## 2. æ ¸å¿ƒæ•°æ®æµ

### 2.1 è®¢å•æäº¤æµç¨‹

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    HTTP POST    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    Ring Buffer   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Client  â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚ Gateway  â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚ Ingestionâ”‚
â”‚          â”‚                 â”‚          â”‚                   â”‚  Stage   â”‚
â”‚          â”‚â—€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ â”‚          â”‚                   â”‚          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  202 Accepted   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                   +                                              â”‚
              order_id                                            â–¼
              seq_id                                        Trading Core
```

### 2.2 Pre-Check æµç¨‹

```rust
async fn submit_order(order: OrderRequest) -> Result<OrderResponse, ApiError> {
    // 1. å‚æ•°æ ¡éªŒ
    validate_order(&order)?;
    
    // 2. èº«ä»½éªŒè¯ (ä» Header è·å–)
    let user_id = authenticate(&headers)?;
    
    // 3. Pre-Check: ä½™é¢æ˜¯å¦è¶³å¤Ÿ (åªè¯»æŸ¥è¯¢)
    let balance = ubscore.query_balance(user_id, order.asset_id).await?;
    let required = calculate_required(&order);
    if balance.avail < required {
        return Err(ApiError::InsufficientBalance);
    }
    
    // 4. åˆ†é… order_id å’Œ client_order_id
    let order_id = id_generator.next();
    
    // 5. å‘é€åˆ° Ring Buffer
    order_queue.push(SequencedOrder {
        order_id,
        user_id,
        ...order,
    })?;
    
    // 6. è¿”å›æ¥æ”¶ç¡®è®¤ (å¼‚æ­¥å¤„ç†)
    Ok(OrderResponse {
        order_id,
        status: "PENDING",
        accepted_at: now(),
    })
}
```

**å…³é”®ç‚¹**ï¼š
- Pre-Check æ˜¯**å°½åŠ›è€Œä¸º**çš„æ£€æŸ¥ï¼Œä¸ä¿è¯ 100% å‡†ç¡®
- æœ€ç»ˆçš„ä½™é¢é”å®šåœ¨ UBSCore æ‰§è¡Œ
- Gateway è¿”å› `202 Accepted` è¡¨ç¤º"å·²æ¥æ”¶ï¼Œå¼‚æ­¥å¤„ç†ä¸­"

---

## 3. API è®¾è®¡

### 3.1 RESTful Endpoints

| Method | Path | æè¿° |
|--------|------|------|
| `POST` | `/api/v1/order` | æäº¤è®¢å• |
| `DELETE` | `/api/v1/order/{order_id}` | å–æ¶ˆè®¢å• |
| `GET` | `/api/v1/order/{order_id}` | æŸ¥è¯¢è®¢å•çŠ¶æ€ |
| `GET` | `/api/v1/orders` | æŸ¥è¯¢ç”¨æˆ·è®¢å•åˆ—è¡¨ |
| `GET` | `/api/v1/balance` | æŸ¥è¯¢ç”¨æˆ·ä½™é¢ |
| `GET` | `/api/v1/trades` | æŸ¥è¯¢æˆäº¤å†å² |

### 3.2 è¯·æ±‚/å“åº”æ ¼å¼

#### æäº¤è®¢å•

```json
// POST /api/v1/order
// Request
{
    "client_order_id": "my-order-001",
    "symbol": "BTC_USDT",
    "side": "BUY",
    "type": "LIMIT",
    "price": "85000.00",
    "quantity": "0.001"
}

// Response (202 Accepted)
{
    "order_id": 1001,
    "client_order_id": "my-order-001",
    "status": "PENDING",
    "accepted_at": 1734533784000
}
```

#### å–æ¶ˆè®¢å•

```json
// DELETE /api/v1/order/1001
// Response (200 OK)
{
    "order_id": 1001,
    "status": "CANCEL_PENDING"
}
```

### 3.3 é”™è¯¯å“åº”

```json
// 4xx Client Error
{
    "error": {
        "code": "INSUFFICIENT_BALANCE",
        "message": "Available balance is insufficient",
        "details": {
            "required": "1000.00",
            "available": "500.00"
        }
    }
}
```

| Code | HTTP Status | è¯´æ˜ |
|------|-------------|------|
| `INVALID_PARAMETER` | 400 | å‚æ•°æ ¼å¼é”™è¯¯ |
| `UNAUTHORIZED` | 401 | è®¤è¯å¤±è´¥ |
| `INSUFFICIENT_BALANCE` | 400 | ä½™é¢ä¸è¶³ |
| `ORDER_NOT_FOUND` | 404 | è®¢å•ä¸å­˜åœ¨ |
| `RATE_LIMITED` | 429 | è¯·æ±‚è¿‡äºé¢‘ç¹ |
| `INTERNAL_ERROR` | 500 | æœåŠ¡å™¨å†…éƒ¨é”™è¯¯ |

---

## 4. WebSocket å®æ—¶æ¨é€

### 4.1 è¿æ¥æµç¨‹

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    WS Connect    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Client  â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚ Gateway  â”‚
â”‚          â”‚                   â”‚          â”‚
â”‚          â”‚    Auth Token     â”‚          â”‚
â”‚          â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚          â”‚
â”‚          â”‚                   â”‚          â”‚
â”‚          â”‚â—€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ â”‚          â”‚
â”‚          â”‚    Connected      â”‚          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 4.2 è®¢é˜…é¢‘é“

```json
// è®¢é˜…è®¢å•çŠ¶æ€æ›´æ–°
{
    "action": "subscribe",
    "channel": "order_updates"
}

// è®¢é˜…ä½™é¢å˜æ›´
{
    "action": "subscribe",
    "channel": "balance_updates"
}

// è®¢é˜…æˆäº¤ (å…¬å¼€)
{
    "action": "subscribe",
    "channel": "trades",
    "symbol": "BTC_USDT"
}
```

### 4.3 æ¨é€æ¶ˆæ¯æ ¼å¼

```json
// è®¢å•çŠ¶æ€å˜æ›´
{
    "channel": "order_updates",
    "data": {
        "order_id": 1001,
        "status": "FILLED",
        "filled_qty": "0.001",
        "avg_price": "85000.00",
        "timestamp": 1734533785000
    }
}

// ä½™é¢å˜æ›´
{
    "channel": "balance_updates",
    "data": {
        "asset": "USDT",
        "available": "9915.00",
        "frozen": "0.00",
        "timestamp": 1734533785000
    }
}
```

---

## 5. å®‰å…¨è®¾è®¡

### 5.1 èº«ä»½éªŒè¯

| æ–¹æ³• | é€‚ç”¨åœºæ™¯ | è¯´æ˜ |
|------|----------|------|
| **API Key + Secret** | ç¨‹åºåŒ–äº¤æ˜“ | HMAC-SHA256 ç­¾å |
| **JWT Token** | Web/Mobile | çŸ­æœŸæœ‰æ•ˆï¼Œéœ€åˆ·æ–° |

#### HMAC ç­¾åç¤ºä¾‹

```python
# Python å®¢æˆ·ç«¯ç¤ºä¾‹
import hmac
import hashlib
import time

api_key = "your_api_key"
secret = "your_secret"

timestamp = str(int(time.time() * 1000))
body = '{"symbol":"BTC_USDT","side":"BUY",...}'

# ç­¾å = HMAC-SHA256(secret, timestamp + body)
signature = hmac.new(
    secret.encode(),
    (timestamp + body).encode(),
    hashlib.sha256
).hexdigest()

headers = {
    "X-API-KEY": api_key,
    "X-TIMESTAMP": timestamp,
    "X-SIGNATURE": signature,
}
```

### 5.2 Rate Limiting

| èµ„æº | é™åˆ¶ | çª—å£ |
|------|------|------|
| è®¢å•æäº¤ | 10 req/s | æ»‘åŠ¨çª—å£ |
| è®¢å•å–æ¶ˆ | 10 req/s | æ»‘åŠ¨çª—å£ |
| æŸ¥è¯¢ | 100 req/s | æ»‘åŠ¨çª—å£ |
| WebSocket æ¶ˆæ¯ | 100 msg/s | - |

---

## 6. é€šä¿¡æ¶æ„è®¾è®¡

### 6.1 é€šä¿¡æ–¹æ¡ˆé€‰æ‹©

| æ–¹æ¡ˆ | å»¶è¿Ÿ | å¤æ‚åº¦ | é€‚ç”¨åœºæ™¯ | é€‰æ‹© |
|------|------|--------|----------|------|
| **åŒè¿›ç¨‹ + Ring Buffer** | ~100ns | â­ | **MVP** | âœ… é‡‡ç”¨ |
| è·¨è¿›ç¨‹ SharedMem | ~1Âµs | â­â­â­ | åˆ†ç¦»éƒ¨ç½² | æœªæ¥ |
| TCP/Unix Socket | ~10Âµs | â­â­ | åˆ†å¸ƒå¼ | æœªæ¥ |
| gRPC | ~100Âµs | â­â­ | å¾®æœåŠ¡ | æœªæ¥ |

**MVP å†³ç­–**ï¼šGateway å’Œ Trading Core è¿è¡Œåœ¨**åŒä¸€è¿›ç¨‹**ä¸­ï¼Œé€šè¿‡ `Arc<ArrayQueue>` é€šä¿¡ã€‚

**ä¼˜åŠ¿**ï¼š
- âœ… é›¶æ”¹åŠ¨ï¼šç›´æ¥å¤ç”¨ç°æœ‰çš„ `crossbeam::ArrayQueue`
- âœ… æœ€ä½å»¶è¿Ÿï¼šæ— éœ€åºåˆ—åŒ–ï¼Œæ— ç½‘ç»œå¼€é”€
- âœ… æœ€ç®€å•ï¼šä¸éœ€è¦é¢å¤–çš„é€šä¿¡åè®®
- âœ… æ˜“äºé›†æˆæµ‹è¯•ï¼šå•è¿›ç¨‹å¯åŠ¨

### 6.2 MVP æ¶æ„ï¼šåŒè¿›ç¨‹ Ring Buffer

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     Single Process (--gateway mode)                      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚                    HTTP/WS Server (tokio runtime)                 â”‚   â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”‚   â”‚
â”‚  â”‚  â”‚ POST /order  â”‚    â”‚ DELETE /orderâ”‚    â”‚ WS Handler   â”‚         â”‚   â”‚
â”‚  â”‚  â”‚              â”‚    â”‚              â”‚    â”‚              â”‚         â”‚   â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â”‚   â”‚
â”‚  â”‚         â”‚                   â”‚                                      â”‚   â”‚
â”‚  â”‚         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                   â”‚   â”‚
â”‚  â”‚                                                â”‚                   â”‚   â”‚
â”‚  â”‚                                                â–¼                   â”‚   â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚   â”‚
â”‚  â”‚  â”‚             order_queue: Arc<ArrayQueue<OrderAction>>        â”‚ â”‚   â”‚
â”‚  â”‚  â”‚                        (å…±äº« Ring Buffer)                    â”‚ â”‚   â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                â”‚                         â”‚
â”‚                                                â”‚ åŒä¸€è¿›ç¨‹å†…ç›´æ¥è®¿é—®        â”‚
â”‚                                                â–¼                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚                    Trading Core Threads                           â”‚   â”‚
â”‚  â”‚                                                                    â”‚   â”‚
â”‚  â”‚   Thread 1: Ingestion    (æ¶ˆè´¹ order_queue)                       â”‚   â”‚
â”‚  â”‚   Thread 2: UBSCore      (WAL + Lock + Settle)                    â”‚   â”‚
â”‚  â”‚   Thread 3: ME           (Matching + Cancel)                      â”‚   â”‚
â”‚  â”‚   Thread 4: Settlement   (Persistence)                            â”‚   â”‚
â”‚  â”‚                                                                    â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 6.3 ä»£ç ç»“æ„

```rust
// main.rs
fn main() {
    // å…±äº«çš„ Ring Buffer
    let queues = Arc::new(MultiThreadQueues::new());
    
    if args.gateway {
        // æ¨¡å¼1: Gateway + Trading Core (åŒè¿›ç¨‹)
        let queues_clone = queues.clone();
        
        // å¯åŠ¨ HTTP Server (tokio runtime)
        std::thread::spawn(move || {
            let rt = tokio::runtime::Runtime::new().unwrap();
            rt.block_on(run_http_server(queues_clone));
        });
        
        // å¯åŠ¨ Trading Core (ç°æœ‰ä»£ç )
        run_pipeline_multi_thread(queues, ...);
    } else {
        // æ¨¡å¼2: åŸæœ‰çš„ CSV æ‰¹é‡å¤„ç†æ¨¡å¼
        run_pipeline_multi_thread(queues, ...);
    }
}
```

### 6.4 æ¼”è¿›è·¯å¾„

```
Phase 1 (MVP - å½“å‰):  åŒè¿›ç¨‹ Ring Buffer
                            â†“
Phase 2:               Unix Socket (åŒæœºå¤šè¿›ç¨‹ï¼Œå¯ç‹¬ç«‹é‡å¯)
                            â†“
Phase 3:               TCP + è‡ªå®šä¹‰åè®® (è·¨æœºéƒ¨ç½²)
                            â†“
Phase 4:               Kafka/Redpanda (é«˜å¯ç”¨ï¼Œå¤šæ¶ˆè´¹è€…)
```

### 6.5 éƒ¨ç½²æ‹“æ‰‘ (æœªæ¥ - Phase 3+)

```
                    Load Balancer
                         â”‚
         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â–¼               â–¼               â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚Gateway 1â”‚     â”‚Gateway 2â”‚     â”‚Gateway Nâ”‚  â† æ— çŠ¶æ€ï¼Œå¯æ°´å¹³æ‰©å±•
    â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜
         â”‚               â”‚               â”‚
         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â”‚ TCP / Kafka
                         â–¼
                â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                â”‚  Trading Core   â”‚  â† å•ç‚¹ï¼Œä¿è¯é¡ºåº
                â”‚  (Active)       â”‚
                â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â”‚
                         â–¼
                â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                â”‚   Database      â”‚  â† æŒä¹…åŒ–å±‚
                â”‚   (PostgreSQL)  â”‚
                â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 7. å®ç°è®¡åˆ’

### Phase 1: åŸºç¡€ HTTP Gateway âœ… æœ¬ç« ç›®æ ‡

**é€šä¿¡æ–¹å¼**: åŒè¿›ç¨‹ Ring Buffer (MVP)

- [ ] æ·»åŠ  axum ä¾èµ–
- [ ] åˆ›å»º `src/gateway.rs` æ¨¡å—
- [ ] å®ç° AppState å…±äº« Ring Buffer
- [ ] POST /api/v1/order è®¢å•æäº¤
- [ ] DELETE /api/v1/order/{id} è®¢å•å–æ¶ˆ
- [ ] å¯åŠ¨æ¨¡å¼ `--gateway` (HTTP + Trading Core)
- [ ] ç®€å•ç”¨æˆ·è®¤è¯ (Header: X-User-ID)

### Phase 2: æŸ¥è¯¢ä¸ WebSocket (0x09-b/c)

- [ ] GET æŸ¥è¯¢æ¥å£ (éœ€è¦ DB)
- [ ] WebSocket è¿æ¥ç®¡ç†
- [ ] è®¢å•çŠ¶æ€æ¨é€

### Phase 3: å®‰å…¨åŠ å›º (0x09-d)

- [ ] API Key è®¤è¯
- [ ] Rate Limiting
- [ ] HTTPS/WSS

---

## 8. æµ‹è¯•ç­–ç•¥

### 8.1 å•å…ƒæµ‹è¯•

```rust
#[tokio::test]
async fn test_submit_order() {
    let app = create_test_app().await;
    
    let response = app
        .post("/api/v1/order")
        .json(&OrderRequest { ... })
        .send()
        .await;
    
    assert_eq!(response.status(), 202);
    let body: OrderResponse = response.json().await;
    assert!(body.order_id > 0);
}
```

### 8.2 é›†æˆæµ‹è¯•

```bash
# å¯åŠ¨ Gateway + Trading Core
cargo run --release -- --gateway

# å‘é€æµ‹è¯•è®¢å•
curl -X POST http://localhost:8080/api/v1/order \
  -H "Content-Type: application/json" \
  -d '{"symbol":"BTC_USDT","side":"BUY","price":"85000","quantity":"0.001"}'
```

---

## Summary

æœ¬ç« è®¾è®¡äº† Gateway ä½œä¸ºå®¢æˆ·ç«¯æ¥å…¥å±‚ï¼š

| è®¾è®¡ç‚¹ | æ–¹æ¡ˆ |
|--------|------|
| HTTP Framework | axum (é«˜æ€§èƒ½ã€ç±»å‹å®‰å…¨) |
| **é€šä¿¡æ–¹å¼** | **åŒè¿›ç¨‹ Ring Buffer** (MVP é˜¶æ®µ) |
| è®¢å•æäº¤ | å¼‚æ­¥æ¥æ”¶ï¼Œè¿”å› 202 Accepted |
| Pre-Check | åªè¯»ä½™é¢æŸ¥è¯¢ï¼Œè¿‡æ»¤æ— æ•ˆè®¢å• |
| é˜Ÿåˆ—è¿æ¥ | `Arc<ArrayQueue>` å…±äº« |
| å®‰å…¨ | ç®€å• Header è®¤è¯ (MVP) â†’ HMAC ç­¾å (æœªæ¥) |

**æ ¸å¿ƒç†å¿µ**ï¼š

> Gateway æ˜¯**é€Ÿåº¦é—¨å«**è€Œä¸æ˜¯**ä¸šåŠ¡å¤„ç†å™¨**ï¼šå¿«é€Ÿæ¥æ”¶ã€å¿«é€Ÿæ ¡éªŒã€å¿«é€Ÿè½¬å‘ã€‚çœŸæ­£çš„ä¸šåŠ¡é€»è¾‘åœ¨ Trading Core æ‰§è¡Œã€‚

ä¸‹ä¸€ç«  (0x09-b) å°†å®ç° Settlement Persistenceï¼Œå°†æˆäº¤æ•°æ®æŒä¹…åŒ–åˆ°æ•°æ®åº“ã€‚
