# 0x08-a äº¤æ˜“æµæ°´çº¿è®¾è®¡ (Trading Pipeline Design)

> **æ ¸å¿ƒç›®çš„**ï¼šè®¾è®¡å®Œæ•´çš„äº¤æ˜“æµæ°´çº¿æ¶æ„ï¼Œç¡®ä¿è®¢å•æŒä¹…åŒ–ã€ä½™é¢ä¸€è‡´æ€§å’Œç³»ç»Ÿå¯æ¢å¤æ€§ã€‚

æœ¬ç« è§£å†³æ’®åˆå¼•æ“æœ€å…³é”®çš„è®¾è®¡é—®é¢˜ï¼š**æœåŠ¡åˆ’åˆ†ã€æ•°æ®æµå’ŒåŸå­æ€§ä¿è¯**ã€‚

---

## 1. ä¸ºä»€ä¹ˆéœ€è¦æŒä¹…åŒ–ï¼Ÿ

### 1.1 é—®é¢˜åœºæ™¯

å‡è®¾ç³»ç»Ÿåœ¨æ’®åˆè¿‡ç¨‹ä¸­å´©æºƒï¼š

```
ç”¨æˆ· A å‘é€ä¹°å• â†’ ME æ¥æ”¶å¹¶æˆäº¤ â†’ ç³»ç»Ÿå´©æºƒ
                                    â†“
                            ç”¨æˆ· A çš„é’±æ‰£äº†
                            ä½†æ²¡æœ‰æˆäº¤è®°å½•
                            è®¢å•ä¸¢å¤±!
```

**æ²¡æœ‰æŒä¹…åŒ–çš„åæœ**ï¼š
- **è®¢å•ä¸¢å¤±**ï¼šç”¨æˆ·ä¸‹çš„å•æ¶ˆå¤±äº†
- **çŠ¶æ€ä¸ä¸€è‡´**ï¼šèµ„é‡‘å˜åŠ¨äº†ä½†æ²¡æœ‰è®°å½•
- **æ— æ³•æ¢å¤**ï¼šé‡å¯åä¸çŸ¥é“æœ‰å“ªäº›è®¢å•

### 1.2 è§£å†³æ–¹æ¡ˆï¼šå…ˆæŒä¹…åŒ–ï¼Œåæ’®åˆ

```
ç”¨æˆ· A å‘é€ä¹°å• â†’ WAL æŒä¹…åŒ– â†’ ME æ’®åˆ â†’ ç³»ç»Ÿå´©æºƒ
                    â†“              â†“
               è®¢å•å·²ä¿å­˜      å¯ä»¥é‡æ”¾æ¢å¤!
```

---

## 2. å”¯ä¸€æ’åº (Unique Ordering)

### 2.1 ä¸ºä»€ä¹ˆéœ€è¦å”¯ä¸€æ’åºï¼Ÿ

åœ¨åˆ†å¸ƒå¼ç³»ç»Ÿä¸­ï¼Œå¤šä¸ªèŠ‚ç‚¹å¿…é¡»å¯¹è®¢å•é¡ºåºè¾¾æˆä¸€è‡´ï¼š

| åœºæ™¯ | é—®é¢˜ |
|------|------|
| èŠ‚ç‚¹ A å…ˆæ”¶åˆ°è®¢å• 1ï¼Œå†æ”¶åˆ°è®¢å• 2 | |
| èŠ‚ç‚¹ B å…ˆæ”¶åˆ°è®¢å• 2ï¼Œå†æ”¶åˆ°è®¢å• 1 | é¡ºåºä¸ä¸€è‡´ï¼ |

**ç»“æœ**ï¼šä¸¤ä¸ªèŠ‚ç‚¹çš„æ’®åˆç»“æœå¯èƒ½ä¸åŒï¼

### 2.2 è§£å†³æ–¹æ¡ˆï¼šå•ç‚¹æ’åº + å…¨å±€åºå·

```
æ‰€æœ‰è®¢å• â†’ Sequencer â†’ åˆ†é…å…¨å±€ sequence_id â†’ æŒä¹…åŒ– â†’ åˆ†å‘åˆ° ME
              â†“
         å”¯ä¸€çš„åˆ°è¾¾é¡ºåº
```

| å­—æ®µ | è¯´æ˜ |
|------|------|
| `sequence_id` | å•è°ƒé€’å¢çš„å…¨å±€åºå· |
| `timestamp` | ç²¾ç¡®åˆ°çº³ç§’çš„æ—¶é—´æˆ³ |
| `order_id` | ä¸šåŠ¡å±‚è®¢å• ID |

---

## 3. è®¢å•ç”Ÿå‘½å‘¨æœŸ

### 3.1 å…ˆæŒä¹…åŒ–ï¼Œåæ‰§è¡Œ

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         è®¢å•ç”Ÿå‘½å‘¨æœŸ                                      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                         â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”             â”‚
â”‚   â”‚ Gateway â”‚â”€â”€â”€â–¶â”‚Pre-Checkâ”‚â”€â”€â”€â–¶â”‚   WAL   â”‚â”€â”€â”€â–¶â”‚   ME    â”‚             â”‚
â”‚   â”‚(æ¥æ”¶è®¢å•)â”‚    â”‚(ä½™é¢æ ¡éªŒ)â”‚    â”‚ (æŒä¹…åŒ–)â”‚    â”‚ (æ’®åˆ) â”‚             â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜             â”‚
â”‚        â”‚              â”‚              â”‚              â”‚                   â”‚
â”‚        â–¼              â–¼              â–¼              â–¼                   â”‚
â”‚    æ¥æ”¶è®¢å•      ä½™é¢ä¸è¶³?        å†™å…¥ç£ç›˜        æ‰§è¡Œæ’®åˆ               â”‚
â”‚                  æå‰æ‹’ç»        åˆ†é…seq_id      ä¿è¯æ‰§è¡Œ               â”‚
â”‚                                                                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 3.2 Pre-Checkï¼šå‡å°‘æ— æ•ˆè®¢å•

Pre-Check é€šè¿‡æŸ¥è¯¢ **UBSCore** (User Balance Core Serviceï¼Œç”¨æˆ·ä½™é¢æ ¸å¿ƒæœåŠ¡ï¼Œè¯¦è§ç¬¬ 7.2 èŠ‚) è·å–ä½™é¢ä¿¡æ¯ï¼Œ**åªè¯»ï¼Œæ— å‰¯ä½œç”¨**ï¼š

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     Pre-Check æµç¨‹ (ä¼ªä»£ç )                        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                   â”‚
â”‚  async fn pre_check(order: Order) -> Result<Order, Reject> {      â”‚
â”‚      // 1. æŸ¥è¯¢ UBSCore è·å–ä½™é¢ (åªè¯»æŸ¥è¯¢)                        â”‚
â”‚      let balance = ubscore.query_balance(order.user_id, asset);   â”‚
â”‚                                                                   â”‚
â”‚      // 2. è®¡ç®—æ‰€éœ€é‡‘é¢                                            â”‚
â”‚      let required = match order.side {                            â”‚
â”‚          Buy  => order.price * order.qty / QTY_UNIT,  // quote    â”‚
â”‚          Sell => order.qty,                            // base    â”‚
â”‚      };                                                           â”‚
â”‚                                                                   â”‚
â”‚      // 3. ä½™é¢æ£€æŸ¥ (åªè¯»ï¼Œä¸é”å®š)                                  â”‚
â”‚      if balance.avail < required {                                â”‚
â”‚          return Err(Reject::InsufficientBalance);                 â”‚
â”‚      }                                                            â”‚
â”‚                                                                   â”‚
â”‚      // 4. æ£€æŸ¥é€šè¿‡ï¼Œæ”¾è¡Œè®¢å•åˆ°ä¸‹ä¸€é˜¶æ®µ                             â”‚
â”‚      Ok(order)                                                    â”‚
â”‚  }                                                                â”‚
â”‚                                                                   â”‚
â”‚  æ³¨æ„ï¼šPre-Check ä¸é”å®šä½™é¢ï¼                                       â”‚
â”‚  ä½™é¢å¯èƒ½åœ¨ Pre-Check å’Œ WAL ä¹‹é—´è¢«å…¶ä»–è®¢å•æ¶ˆè€—                     â”‚
â”‚  è¿™æ˜¯å…è®¸çš„ï¼ŒWAL åçš„ Balance Lock ä¼šå¤„ç†è¿™ç§æƒ…å†µ                   â”‚
â”‚                                                                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**ä¸ºä»€ä¹ˆéœ€è¦ Pre-Checkï¼Ÿ**

æ ¸å¿ƒæµç¨‹ï¼ˆWAL æŒä¹…åŒ–ã€Balance Lockã€æ’®åˆï¼‰çš„å»¶è¿Ÿæˆæœ¬å¾ˆé«˜ã€‚
ç”¨æˆ·å¯èƒ½æäº¤å¤§é‡åƒåœ¾è®¢å•ï¼Œæˆ‘ä»¬éœ€è¦**æœ€å¿«é€Ÿ**åœ°é¢„è¿‡æ»¤ï¼Œå‡å°‘è¿›å…¥æ ¸å¿ƒæµç¨‹çš„è®¢å•é‡ã€‚

| ä¸ Pre-Check | æœ‰ Pre-Check |
|--------------|--------------|
| åƒåœ¾è®¢å•ç›´æ¥è¿›å…¥æ ¸å¿ƒæµç¨‹ | å¿«é€Ÿè¿‡æ»¤å¤§éƒ¨åˆ†æ— æ•ˆè®¢å• |
| æ ¸å¿ƒæµç¨‹å¤„ç†æ— æ•ˆè®¢å•ï¼Œæµªè´¹å»¶è¿Ÿ | æ ¸å¿ƒæµç¨‹åªå¤„ç†å¯èƒ½æœ‰æ•ˆçš„è®¢å• |
| ç³»ç»Ÿå®¹æ˜“è¢«åˆ·å•æ”»å‡» | å‡å°‘æ¶æ„è¯·æ±‚çš„å½±å“ |

**Pre-Check å¯ä»¥åŒ…å«å¤šç§å¿«é€Ÿæ£€æŸ¥**ï¼š
- âœ… ä½™é¢æ£€æŸ¥ï¼ˆå½“å‰å®ç°ï¼‰
- ğŸ“‹ ç”¨æˆ·çŠ¶æ€æ£€æŸ¥ï¼ˆæ˜¯å¦è¢«ç¦ç”¨ï¼‰
- ğŸ“‹ è®¢å•æ ¼å¼æ ¡éªŒ
- ğŸ“‹ é¢‘ç‡é™åˆ¶ (Rate Limit)
- ğŸ“‹ é£æ§è§„åˆ™ï¼ˆæœªæ¥æ‰©å±•ï¼‰

**é‡è¦**ï¼šPre-Check æ˜¯"å°½åŠ›è€Œä¸º"çš„è¿‡æ»¤å™¨ï¼Œä¸ä¿è¯ 100% å‡†ç¡®ã€‚
é€šè¿‡ Pre-Check çš„è®¢å•ï¼Œä»å¯èƒ½åœ¨ WAL + Balance Lock é˜¶æ®µè¢«æ‹’ç»ã€‚

### 3.3 ä¸€æ—¦æŒä¹…åŒ–ï¼Œå¿…é¡»å®Œæ•´æ‰§è¡Œ

```
è®¢å•è¢«æŒä¹…åŒ–åï¼Œæ— è®ºå‘ç”Ÿä»€ä¹ˆï¼Œéƒ½å¿…é¡»æœ‰ä»¥ä¸‹å…¶ä¸­ä¸€ä¸ªç»“æœï¼š

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ è®¢å•å·²æŒä¹…åŒ–         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚
           â”œâ”€â”€â–¶ æˆäº¤ (Filled)
           â”œâ”€â”€â–¶ éƒ¨åˆ†æˆäº¤ (PartialFilled)
           â”œâ”€â”€â–¶ æŒ‚å•ä¸­ (New)
           â”œâ”€â”€â–¶ ç”¨æˆ·å–æ¶ˆ (Cancelled)
           â”œâ”€â”€â–¶ ç³»ç»Ÿè¿‡æœŸ (Expired)
           â””â”€â”€â–¶ ä½™é¢ä¸è¶³è¢«æ‹’ç» (Rejected)  â† ä¹Ÿæ˜¯åˆæ³•çš„ç»ˆæ€ï¼

âŒ ç»å¯¹ä¸èƒ½ï¼šè®¢å•æ¶ˆå¤± / çŠ¶æ€æœªçŸ¥
```

---

## 4. WALï¼šä¸ºä»€ä¹ˆæ˜¯æœ€ä½³é€‰æ‹©ï¼Ÿ

### 4.1 ä»€ä¹ˆæ˜¯ WAL (Write-Ahead Log)?

WAL æ˜¯ä¸€ç§**è¿½åŠ å†™** (Append-Only) çš„æ—¥å¿—ç»“æ„ï¼š

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                          WAL File                               â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  Entry 1  â”‚  Entry 2  â”‚  Entry 3  â”‚  Entry 4  â”‚  ...  â”‚ â† è¿½åŠ   â”‚
â”‚ (seq=1)   â”‚ (seq=2)   â”‚ (seq=3)   â”‚ (seq=4)   â”‚       â”‚         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                                          â†‘
                                                     åªè¿½åŠ ï¼Œä¸ä¿®æ”¹
```

### 4.2 ä¸ºä»€ä¹ˆ WAL æ˜¯ HFT æœ€ä½³å®è·µï¼Ÿ

| æŒä¹…åŒ–æ–¹å¼ | å†™å…¥æ¨¡å¼ | å»¶è¿Ÿ | ååé‡ | HFT é€‚ç”¨æ€§ |
|-----------|----------|------|--------|-----------|
| æ•°æ®åº“ (MySQL/Postgres) | éšæœºå†™ + äº‹åŠ¡ | ~1-10ms | ~1K ops/s | âŒ å¤ªæ…¢ |
| KV å­˜å‚¨ (Redis/RocksDB) | éšæœºå†™ | ~0.1-1ms | ~10K ops/s | âš ï¸ ä¸€èˆ¬ |
| **WAL è¿½åŠ å†™** | **é¡ºåºå†™** | **~1-10Âµs** | **~1M ops/s** | âœ… **æœ€ä½³** |

**ä¸ºä»€ä¹ˆ WAL è¿™ä¹ˆå¿«ï¼Ÿ**

#### 4.2.1 é¡ºåºå†™ vs éšæœºå†™

```
éšæœºå†™ (æ•°æ®åº“):
â”Œâ”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”
â”‚ å†™1 â”‚     â”‚ å†™2 â”‚     â”‚ å†™3 â”‚
â””â”€â”€â”¬â”€â”€â”˜     â””â”€â”€â”¬â”€â”€â”˜     â””â”€â”€â”¬â”€â”€â”˜
   â”‚           â”‚           â”‚
   â–¼           â–¼           â–¼
 ä½ç½® A      ä½ç½® X      ä½ç½® M

é¡ºåºå†™ (WAL):
â”Œâ”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”
â”‚ å†™1 â”‚ å†™2 â”‚ å†™3 â”‚ â† è¿½åŠ åˆ°æ–‡ä»¶æœ«å°¾
â””â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”˜
```

**ä¸ºä»€ä¹ˆé¡ºåºå†™æ›´å¿«ï¼Ÿ**

| å­˜å‚¨ç±»å‹ | éšæœºå†™çš„é—®é¢˜ | é¡ºåºå†™çš„ä¼˜åŠ¿ |
|---------|-------------|-------------|
| **HDD** | ç£å¤´å¯»é“å»¶è¿Ÿ ~10ms | æ— å¯»é“ï¼Œè¿ç»­å†™å…¥ |
| **SSD** | å†™æ”¾å¤§ (Write Amplification)ã€GC å¼€é”€ | å‡å°‘å†™æ”¾å¤§ï¼Œå»¶é•¿å¯¿å‘½ |

å³ä½¿æ˜¯ SSDï¼Œé¡ºåºå†™ä¹Ÿæ¯”éšæœºå†™å¿« **10-100 å€**ã€‚

#### 4.2.2 æ— äº‹åŠ¡å¼€é”€

```
æ•°æ®åº“å†™å…¥:
1. å¼€å¯äº‹åŠ¡
2. è·å–é”
3. å†™ redo log
4. å†™æ•°æ®é¡µ
5. å†™ binlog
6. æäº¤äº‹åŠ¡ï¼Œé‡Šæ”¾é”
â†’ å¤šæ¬¡ç£ç›˜æ“ä½œï¼Œå¤šæ¬¡åŒæ­¥

WAL å†™å…¥:
1. åºåˆ—åŒ–æ•°æ®
2. è¿½åŠ å†™å…¥
3. (å¯é€‰) fsync
â†’ æœ€å°‘ä¸€æ¬¡ç£ç›˜æ“ä½œ
```

#### 4.2.3 æ‰¹é‡åˆ·ç›˜ (Group Commit)

```rust
/// æ‰¹é‡æäº¤ WAL
impl WalWriter {
    /// å†™å…¥ä½†ä¸ç«‹å³åˆ·ç›˜
    pub fn append(&mut self, entry: &[u8]) -> u64 {
        self.buffer.extend_from_slice(entry);
        self.pending_count += 1;
        self.next_seq()
    }
    
    /// æ‰¹é‡åˆ·ç›˜ï¼ˆæ¯ N ä¸ªè®¢å•æˆ–æ¯ T æ¯«ç§’ï¼‰
    pub fn flush(&mut self) -> io::Result<()> {
        self.file.write_all(&self.buffer)?;
        self.file.sync_data()?;  // fsync
        self.buffer.clear();
        Ok(())
    }
}
```

**Group Commit æ•ˆæœ**ï¼š

| åˆ·ç›˜ç­–ç•¥ | å»¶è¿Ÿ | ååé‡ | æ•°æ®å®‰å…¨ |
|----------|------|--------|----------|
| æ¯æ¡ fsync | ~50Âµs | ~20K/s | æœ€é«˜ |
| æ¯ 100 æ¡ fsync | ~5Âµs (å‡æ‘Š) | ~200K/s | é«˜ |
| æ¯ 1ms fsync | ~1Âµs (å‡æ‘Š) | ~1M/s | ä¸­ |

---

## 5. å•çº¿ç¨‹ + Lock-Free æ¶æ„

### 5.1 ä¸ºä»€ä¹ˆé€‰æ‹©å•çº¿ç¨‹ï¼Ÿ

å¤§å¤šæ•°äººç›´è§‰è®¤ä¸ºï¼šå¹¶å‘ = å¿«ã€‚ä½†åœ¨ HFT é¢†åŸŸï¼Œ**å•çº¿ç¨‹å¾€å¾€æ›´å¿«**ï¼š

| å¤šçº¿ç¨‹ | å•çº¿ç¨‹ |
|--------|--------|
| éœ€è¦é”ä¿æŠ¤å…±äº«çŠ¶æ€ | æ— é”ï¼Œæ— ç«äº‰ |
| ç¼“å­˜å¤±æ•ˆ (cache invalidation) | ç¼“å­˜å‹å¥½ |
| ä¸Šä¸‹æ–‡åˆ‡æ¢å¼€é”€ | æ— åˆ‡æ¢å¼€é”€ |
| é¡ºåºéš¾ä»¥ä¿è¯ | å¤©ç„¶æœ‰åº |
| å¤æ‚çš„åŒæ­¥é€»è¾‘ | ä»£ç ç®€å•ç›´è§‚ |

### 5.2 Mechanical Sympathy

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    CPU Cache Hierarchy                          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                 â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                                   â”‚
â”‚   â”‚   CPU   â”‚  L1 Cache: ~1ns (32KB)                           â”‚
â”‚   â”‚  Core 0 â”‚  L2 Cache: ~4ns (256KB)                          â”‚
â”‚   â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜  L3 Cache: ~12ns (shared, MBçº§)                  â”‚
â”‚        â”‚                                                        â”‚
â”‚        â–¼                                                        â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                                   â”‚
â”‚   â”‚   RAM   â”‚  ~100ns                                          â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                                   â”‚
â”‚                                                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

å•çº¿ç¨‹ä¼˜åŠ¿ï¼š
- æ•°æ®å§‹ç»ˆåœ¨ L1/L2 ç¼“å­˜ä¸­ï¼ˆçƒ­æ•°æ®ï¼‰
- æ—  cache line äº‰ç”¨
- æ—  false sharing
```

### 5.3 LMAX Disruptor æ¨¡å¼

è¿™ç§å•çº¿ç¨‹ + Ring Buffer çš„æ¶æ„æºè‡ª **LMAX Exchange**ï¼ˆä¼¦æ•¦å¤šèµ„äº§äº¤æ˜“æ‰€ï¼‰ï¼Œå·ç§°èƒ½åœ¨å•çº¿ç¨‹ä¸Šå¤„ç† **600 ä¸‡è®¢å•/ç§’**ï¼š

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    LMAX Disruptor Architecture                  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                 â”‚
â”‚   Publisher â”€â”€â”€â–¶ Ring Buffer â”€â”€â”€â–¶ Consumer                     â”‚
â”‚   (å•çº¿ç¨‹å†™)      (æ— é”é˜Ÿåˆ—)       (å•çº¿ç¨‹è¯»)                    â”‚
â”‚                                                                 â”‚
â”‚   å…³é”®ç‰¹æ€§ï¼š                                                     â”‚
â”‚   1. å•ä¸€ Writerï¼ˆé¿å…å†™ç«äº‰ï¼‰                                   â”‚
â”‚   2. é¢„åˆ†é…å†…å­˜ï¼ˆé¿å… GC/mallocï¼‰                                â”‚
â”‚   3. ç¼“å­˜è¡Œå¡«å……ï¼ˆé¿å… false sharingï¼‰                           â”‚
â”‚   4. æ‰¹é‡æ¶ˆè´¹ï¼ˆå‡å°‘åŒæ­¥ç‚¹ï¼‰                                      â”‚
â”‚                                                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 6. Ring Bufferï¼šæœåŠ¡é—´é€šä¿¡

### 6.1 ä¸ºä»€ä¹ˆä½¿ç”¨ Ring Bufferï¼Ÿ

æœåŠ¡é—´é€šä¿¡çš„é€‰æ‹©ï¼š

| æ–¹å¼ | å»¶è¿Ÿ | ååé‡ | å¤æ‚åº¦ |
|------|------|--------|--------|
| HTTP/gRPC | ~1ms | ~10K/s | ä½ |
| Kafka | ~1-10ms | ~1M/s | ä¸­ |
| Socket/ZMQ | ~100Âµs | ~100K/s | ä¸­ |
| **Shared Memory Ring Buffer** | **~100ns** | **~10M/s** | é«˜ |

### 6.2 Ring Buffer åŸç†

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        Ring Buffer                              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                 â”‚
â”‚      write_idx                       read_idx                   â”‚
â”‚          â†“                               â†“                      â”‚
â”‚   â”Œâ”€â”€â”€â”¬â”€â”€â”€â”¬â”€â”€â”€â”¬â”€â”€â”€â”¬â”€â”€â”€â”¬â”€â”€â”€â”¬â”€â”€â”€â”¬â”€â”€â”€â”¬â”€â”€â”€â”¬â”€â”€â”€â”¬â”€â”€â”€â”¬â”€â”€â”€â”            â”‚
â”‚   â”‚ 8 â”‚ 9 â”‚ 10â”‚ 11â”‚ 12â”‚ 13â”‚ 14â”‚ 15â”‚ 0 â”‚ 1 â”‚ 2 â”‚ 3 â”‚ ...        â”‚
â”‚   â””â”€â”€â”€â”´â”€â”€â”€â”´â”€â”€â”€â”´â”€â”€â”€â”´â”€â”€â”€â”´â”€â”€â”€â”´â”€â”€â”€â”´â”€â”€â”€â”´â”€â”€â”€â”´â”€â”€â”€â”´â”€â”€â”€â”´â”€â”€â”€â”˜            â”‚
â”‚         â†‘                               â†‘                       â”‚
â”‚     æ–°æ•°æ®å†™å…¥                        æ¶ˆè´¹è€…è¯»å–                  â”‚
â”‚                                                                 â”‚
â”‚   ç‰¹æ€§ï¼š                                                         â”‚
â”‚   - å›ºå®šå¤§å°ï¼Œå¾ªç¯ä½¿ç”¨                                           â”‚
â”‚   - æ— éœ€åŠ¨æ€åˆ†é…                                                 â”‚
â”‚   - Single Producer, Single Consumer (SPSC) å¯å®Œå…¨æ— é”          â”‚
â”‚                                                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 6.3 ä¸ºä»€ä¹ˆ Ring Buffer è¿™ä¹ˆå¿«ï¼Ÿ

```rust
/// SPSC Ring Buffer æ ¸å¿ƒå®ç°
pub struct RingBuffer<T, const N: usize> {
    buffer: [MaybeUninit<T>; N],
    write_idx: AtomicUsize,  // ç”Ÿäº§è€…ç‹¬å 
    read_idx: AtomicUsize,   // æ¶ˆè´¹è€…ç‹¬å 
}

impl<T, const N: usize> RingBuffer<T, N> {
    /// ç”Ÿäº§è€…å†™å…¥ï¼ˆæ— é”ï¼‰
    pub fn push(&self, item: T) -> bool {
        let write = self.write_idx.load(Ordering::Relaxed);
        let read = self.read_idx.load(Ordering::Acquire);
        
        if (write + 1) % N == read {
            return false;  // æ»¡äº†
        }
        
        unsafe {
            self.buffer[write].as_mut_ptr().write(item);
        }
        
        self.write_idx.store((write + 1) % N, Ordering::Release);
        true
    }
    
    /// æ¶ˆè´¹è€…è¯»å–ï¼ˆæ— é”ï¼‰
    pub fn pop(&self) -> Option<T> {
        let read = self.read_idx.load(Ordering::Relaxed);
        let write = self.write_idx.load(Ordering::Acquire);
        
        if read == write {
            return None;  // ç©ºçš„
        }
        
        let item = unsafe { self.buffer[read].as_ptr().read() };
        
        self.read_idx.store((read + 1) % N, Ordering::Release);
        Some(item)
    }
}
```

**å…³é”®ç‚¹**ï¼š
- **æ— é”**ï¼šä½¿ç”¨ Atomic æ“ä½œä»£æ›¿äº’æ–¥é”
- **æ— åˆ†é…**ï¼šé¢„åˆ†é…å›ºå®šå¤§å°çš„æ•°ç»„
- **ç¼“å­˜å‹å¥½**ï¼šè¿ç»­å†…å­˜å¸ƒå±€
- **æ‰¹é‡æ“ä½œ**ï¼šå¯ä»¥ä¸€æ¬¡è¯»å–å¤šä¸ªæ¡ç›®

---

## 7. æ•´ä½“æ¶æ„

### 7.1 æ ¸å¿ƒæœåŠ¡

ç³»ç»Ÿç”±ä»¥ä¸‹æ ¸å¿ƒæœåŠ¡ç»„æˆï¼š

| æœåŠ¡ | èŒè´£ | çŠ¶æ€ |
|------|------|------|
| **Gateway** | æ¥æ”¶å®¢æˆ·ç«¯è¯·æ±‚ | æ— çŠ¶æ€ |
| **Pre-Check** | åªè¯»æŸ¥è¯¢ä½™é¢ï¼Œè¿‡æ»¤æ— æ•ˆè®¢å• | æ— çŠ¶æ€ |
| **UBSCore** | æ‰€æœ‰ä½™é¢æ“ä½œ + Order WAL | æœ‰çŠ¶æ€ (ä½™é¢) |
| **ME** | çº¯æ’®åˆï¼Œç”Ÿæˆ Trade Events | æœ‰çŠ¶æ€ (OrderBook) |
| **Settlement** | æŒä¹…åŒ– eventsï¼Œæœªæ¥å†™ DB | æ— çŠ¶æ€ |

### 7.2 UBSCore Service (User Balance Core)

**UBSCore æ˜¯æ‰€æœ‰è´¦æˆ·ä½™é¢æ“ä½œçš„å”¯ä¸€å…¥å£**ï¼Œå•çº¿ç¨‹æ‰§è¡Œä¿è¯åŸå­æ€§ã€‚

#### 7.2.1 ä¸ºä»€ä¹ˆéœ€è¦ UBSCoreï¼Ÿ

| åˆ†æ•£å¤„ç†ä½™é¢ | é›†ä¸­åˆ° UBSCore |
|-------------|----------------|
| å¤šå¤„ä¿®æ”¹ä½™é¢ï¼Œéœ€è¦åˆ†å¸ƒå¼é” | å”¯ä¸€å…¥å£ï¼Œå•çº¿ç¨‹æ— é” |
| åŒèŠ±é£é™©é«˜ | å¤©ç„¶åŸå­ï¼Œæ— åŒèŠ± |
| éš¾ä»¥å®¡è®¡ | æ‰€æœ‰å˜æ›´å¯è¿½è¸ª |
| æ¢å¤å›°éš¾ | å•ä¸€ WAL å¯å®Œæ•´æ¢å¤ |

#### 7.2.2 UBSCore æä¾›çš„æ“ä½œ

```rust
// ä½™é¢æŸ¥è¯¢ (åªè¯»)
fn query_balance(user_id: UserId, asset_id: AssetId) -> Balance;

// ä½™é¢æ“ä½œ (ä¿®æ”¹)
fn lock(user_id: UserId, asset_id: AssetId, amount: u64) -> Result<()>;
fn unlock(user_id: UserId, asset_id: AssetId, amount: u64) -> Result<()>;
fn spend_frozen(user_id: UserId, asset_id: AssetId, amount: u64) -> Result<()>;
fn deposit(user_id: UserId, asset_id: AssetId, amount: u64) -> Result<()>;
```

#### 7.2.3 UBSCore åœ¨è®¢å•æµç¨‹ä¸­çš„è§’è‰²

```
è®¢å•åˆ°è¾¾ UBSCore åï¼š
1. Write Order WAL (æŒä¹…åŒ–è®¢å•)
2. Lock Balance (é”å®šèµ„é‡‘)
   - æˆåŠŸ â†’ è½¬å‘åˆ° ME
   - å¤±è´¥ â†’ æ ‡è®°ä¸º Rejectedï¼Œä¸è¿›å…¥ ME
3. æ”¶åˆ° Trade Events åæ‰§è¡Œ Settlement
   - Buyer: spend_frozen(quote), deposit(base)
   - Seller: spend_frozen(base), deposit(quote)
```

### 7.3 Matching Engine (ME)

**ME æ˜¯çº¯æ’®åˆå¼•æ“ï¼Œä¸å…³å¿ƒä½™é¢**ã€‚

| ME åšçš„äº‹ | ME ä¸åšçš„äº‹ |
|----------|------------|
| ç»´æŠ¤ OrderBook | æ£€æŸ¥ä½™é¢ |
| ä»·æ ¼-æ—¶é—´ä¼˜å…ˆæ’®åˆ | é”å®š/è§£é”ä½™é¢ |
| ç”Ÿæˆ Trade Events | æ›´æ–°ä½™é¢ |
|  | æŒä¹…åŒ–ä»»ä½•æ•°æ® |

**Trade Event åŒ…å«è¶³å¤Ÿä¿¡æ¯ç”Ÿæˆ Balance Update**ï¼š

```rust
struct TradeEvent {
    trade_id: TradeId,
    buyer_order_id: OrderId,
    seller_order_id: OrderId,
    buyer_user_id: UserId,
    seller_user_id: UserId,
    price: u64,
    qty: u64,
    // å¯ä»¥ä»è¿™äº›ä¿¡æ¯è®¡ç®—å‡ºï¼š
    // - buyer éœ€è¦ spend_frozen(quote, price * qty)
    // - buyer éœ€è¦ deposit(base, qty)
    // - seller éœ€è¦ spend_frozen(base, qty)
    // - seller éœ€è¦ deposit(quote, price * qty)
}
```

### 7.4 Settlement Service

**Settlement è´Ÿè´£æŒä¹…åŒ–ï¼Œä¸ä¿®æ”¹ä½™é¢**ã€‚

| Settlement åšçš„äº‹ | Settlement ä¸åšçš„äº‹ |
|------------------|-------------------|
| æŒä¹…åŒ– Trade Events | æ›´æ–°ä½™é¢ (ç”± UBSCore åš) |
| æŒä¹…åŒ– Order Events | æ’®åˆè®¢å• |
| æœªæ¥å†™å…¥ DB ä¾›æŸ¥è¯¢ | |
| ç”Ÿæˆå®¡è®¡æ—¥å¿— | |

### 7.5 å®Œæ•´æ¶æ„å›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         0xInfinity HFT Architecture                               â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                                   â”‚
â”‚   Client Orders                                                                   â”‚
â”‚        â”‚                                                                          â”‚
â”‚        â–¼                                                                          â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                                                â”‚
â”‚   â”‚   Gateway    â”‚  â† å¤šçº¿ç¨‹æ¥æ”¶ç½‘ç»œè¯·æ±‚                                           â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜                                                                â”‚
â”‚          â”‚                                                                        â”‚
â”‚          â–¼                                                                        â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         query balance          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚   â”‚  Pre-Check   â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚                            â”‚ â”‚
â”‚   â”‚  (åªè¯»æŸ¥è¯¢)   â”‚â—€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ â”‚                            â”‚ â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜         return balance         â”‚                            â”‚ â”‚
â”‚          â”‚                                        â”‚                            â”‚ â”‚
â”‚          â”‚ è¿‡æ»¤æ˜æ˜¾æ— æ•ˆè®¢å•                        â”‚                            â”‚ â”‚
â”‚          â–¼                                        â”‚                            â”‚ â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                â”‚      UBSCore Service       â”‚ â”‚
â”‚   â”‚ Order Buffer â”‚                                â”‚   (User Balance Core)      â”‚ â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜                                â”‚                            â”‚ â”‚
â”‚          â”‚ Ring Buffer                            â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚ â”‚
â”‚          â–¼                                        â”‚   â”‚  Balance State     â”‚   â”‚ â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚   â”‚  (å†…å­˜, å•çº¿ç¨‹)    â”‚   â”‚ â”‚
â”‚   â”‚  UBSCore: Order Processing               â”‚    â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚ â”‚
â”‚   â”‚  1. Write Order WAL (æŒä¹…åŒ–)              â”‚    â”‚                            â”‚ â”‚
â”‚   â”‚  2. Lock Balance                         â”‚    â”‚   Operations:              â”‚ â”‚
â”‚   â”‚     - OK â†’ forward to ME                 â”‚    â”‚   - lock / unlock          â”‚ â”‚
â”‚   â”‚     - Fail â†’ Rejected (è®°å½•çŠ¶æ€)         â”‚    â”‚   - spend_frozen           â”‚ â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚   - deposit                â”‚ â”‚
â”‚                  â”‚                                â”‚                            â”‚ â”‚
â”‚                  â”‚ Ring Buffer (valid orders)     â”‚                            â”‚ â”‚
â”‚                  â–¼                                â”‚                            â”‚ â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚                            â”‚ â”‚
â”‚   â”‚         Matching Engine (ME)             â”‚    â”‚                            â”‚ â”‚
â”‚   â”‚                                          â”‚    â”‚                            â”‚ â”‚
â”‚   â”‚  çº¯æ’®åˆï¼Œä¸å…³å¿ƒ Balance                   â”‚    â”‚                            â”‚ â”‚
â”‚   â”‚  è¾“å‡º: Trade Events                      â”‚    â”‚                            â”‚ â”‚
â”‚   â”‚                                          â”‚    â”‚                            â”‚ â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚                            â”‚ â”‚
â”‚                  â”‚                                â”‚                            â”‚ â”‚
â”‚                  â”‚ Ring Buffer (Trade Events)     â”‚                            â”‚ â”‚
â”‚                  â”‚                                â”‚                            â”‚ â”‚
â”‚         â”Œâ”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”                        â”‚                            â”‚ â”‚
â”‚         â”‚                â”‚                        â”‚                            â”‚ â”‚
â”‚         â–¼                â–¼                        â”‚                            â”‚ â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”‚                            â”‚ â”‚
â”‚   â”‚ Settlementâ”‚   â”‚ Balance Update Events   â”‚â”€â”€â”€â”€â–¶â”‚  æ‰§è¡Œä½™é¢æ›´æ–°:             â”‚ â”‚
â”‚   â”‚           â”‚   â”‚ (from Trade Events)     â”‚     â”‚  - Buyer: -quote, +base    â”‚ â”‚
â”‚   â”‚ æŒä¹…åŒ–:    â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚  - Seller: -base, +quote   â”‚ â”‚
â”‚   â”‚ - Trades  â”‚                                   â”‚                            â”‚ â”‚
â”‚   â”‚ - Orders  â”‚                                   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚   â”‚ - Ledger  â”‚                                                                   â”‚
â”‚   â”‚           â”‚                                                                   â”‚
â”‚   â”‚ æœªæ¥ â†’ DB â”‚                                                                   â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                                                   â”‚
â”‚                                                                                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 7.6 æ•°æ®æµè¯¦è§£

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                              è®¢å•å¤„ç†æµç¨‹                                         â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                                  â”‚
â”‚  [1] Pre-Check                                                                   â”‚
â”‚      â”‚                                                                           â”‚
â”‚      â”œâ”€â”€ Query UBSCore: è·å–ç”¨æˆ·ä½™é¢ (åªè¯»)                                       â”‚
â”‚      â”œâ”€â”€ æ£€æŸ¥: ä½™é¢æ˜¯å¦è¶³å¤Ÿï¼Ÿ                                                     â”‚
â”‚      â””â”€â”€ è¿‡æ»¤: æ˜æ˜¾æ— æ•ˆè®¢å•ä¸è¿›å…¥ç³»ç»Ÿ                                             â”‚
â”‚                                                                                  â”‚
â”‚  [2] Order Buffer â†’ Ring Buffer â†’ UBSCore                                       â”‚
â”‚      â”‚                                                                           â”‚
â”‚      â”œâ”€â”€ UBSCore æ”¶åˆ°è®¢å•                                                        â”‚
â”‚      â”œâ”€â”€ Step 1: Write Order WAL (å…ˆæŒä¹…åŒ–)                                      â”‚
â”‚      â”œâ”€â”€ Step 2: Lock Balance                                                   â”‚
â”‚      â”‚     â”œâ”€â”€ æˆåŠŸ â†’ è®¢å•æœ‰æ•ˆï¼Œè½¬å‘åˆ° ME                                        â”‚
â”‚      â”‚     â””â”€â”€ å¤±è´¥ â†’ è®¢å• Rejected (ä»æœ‰è®°å½•)                                   â”‚
â”‚      â””â”€â”€ Step 3: Forward to ME (via Ring Buffer)                                â”‚
â”‚                                                                                  â”‚
â”‚  [3] ME                                                                          â”‚
â”‚      â”‚                                                                           â”‚
â”‚      â”œâ”€â”€ æ”¶åˆ°æœ‰æ•ˆè®¢å•                                                            â”‚
â”‚      â”œâ”€â”€ æ’®åˆ: ä»·æ ¼-æ—¶é—´ä¼˜å…ˆ                                                      â”‚
â”‚      â””â”€â”€ è¾“å‡º: Trade Events                                                      â”‚
â”‚                                                                                  â”‚
â”‚  [4] Trade Events â†’ Fan-out                                                      â”‚
â”‚      â”‚                                                                           â”‚
â”‚      â”œâ”€â”€ â†’ UBSCore: Balance Update                                              â”‚
â”‚      â”‚     â”œâ”€â”€ Buyer: spend_frozen(quote, cost), deposit(base, qty)             â”‚
â”‚      â”‚     â””â”€â”€ Seller: spend_frozen(base, qty), deposit(quote, cost)            â”‚
â”‚      â”‚                                                                           â”‚
â”‚      â””â”€â”€ â†’ Settlement: Persist                                                   â”‚
â”‚            â”œâ”€â”€ æŒä¹…åŒ– Trade Events                                               â”‚
â”‚            â”œâ”€â”€ æŒä¹…åŒ– Order Events (çŠ¶æ€å˜æ›´)                                    â”‚
â”‚            â””â”€â”€ å†™å®¡è®¡æ—¥å¿— (Ledger)                                               â”‚
â”‚                                                                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 7.7 Event Sourcing + Pure State Machineï¼šæ ¸å¿ƒè®¾è®¡åŸåˆ™

#### 7.7.1 Order WAL = Single Source of Truth

**Order WAL æ˜¯ç³»ç»Ÿå”¯ä¸€çš„äº‹å®æ¥æº**ã€‚æ‰€æœ‰å…¶ä»–çŠ¶æ€éƒ½å¯ä»¥ä» Order WAL 100% é‡æ–°ç”Ÿæˆï¼š

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      Order WAL: Single Source of Truth                          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                                  â”‚
â”‚   Order WAL (å”¯ä¸€äº‹å®)                                                           â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                â”‚
â”‚   â”‚ Order 1 â”‚ Order 2 â”‚ Order 3 â”‚ Order 4 â”‚ Order 5 â”‚  ...    â”‚                â”‚
â”‚   â”‚ seq=1   â”‚ seq=2   â”‚ seq=3   â”‚ seq=4   â”‚ seq=5   â”‚         â”‚                â”‚
â”‚   â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”´â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”´â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”´â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”´â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                â”‚
â”‚        â”‚         â”‚         â”‚         â”‚         â”‚                                â”‚
â”‚        â–¼         â–¼         â–¼         â–¼         â–¼                                â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”              â”‚
â”‚   â”‚              Pure State Machines (çº¯çŠ¶æ€æœº)                   â”‚              â”‚
â”‚   â”‚                                                               â”‚              â”‚
â”‚   â”‚  Balance State = f(Order WAL)   â† å¯å®Œå…¨é‡å»º                  â”‚              â”‚
â”‚   â”‚  OrderBook     = f(Order WAL)   â† å¯å®Œå…¨é‡å»º                  â”‚              â”‚
â”‚   â”‚  Trade History = f(Order WAL)   â† å¯å®Œå…¨é‡å»º                  â”‚              â”‚
â”‚   â”‚                                                               â”‚              â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜              â”‚
â”‚                                                                                  â”‚
â”‚   åªè¦æœ‰ Order WALï¼Œå°±èƒ½æ¢å¤æ•´ä¸ªç³»ç»ŸçŠ¶æ€ï¼                                        â”‚
â”‚                                                                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### 7.7.2 Pure State Machine (çº¯çŠ¶æ€æœº)

**æ‰€æœ‰å¤„ç†å™¨éƒ½æ˜¯ Pure State Machine**ï¼šç»™å®šç›¸åŒè¾“å…¥ï¼Œå¿…å®šäº§ç”Ÿç›¸åŒè¾“å‡ºã€‚

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                          Pure State Machine ç‰¹æ€§                                 â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                                  â”‚
â”‚   Pure Function: output = f(state, input)                                       â”‚
â”‚                                                                                  â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                       â”‚
â”‚   â”‚   Input     â”‚â”€â”€â”€â–¶â”‚ State Machineâ”‚â”€â”€â”€â–¶â”‚   Output     â”‚                       â”‚
â”‚   â”‚  (Order)    â”‚    â”‚   (ME/UBSC)  â”‚    â”‚  (Events)    â”‚                       â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                       â”‚
â”‚                             â”‚                                                    â”‚
â”‚                             â–¼                                                    â”‚
â”‚                      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                            â”‚
â”‚                      â”‚  New State   â”‚                                            â”‚
â”‚                      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                            â”‚
â”‚                                                                                  â”‚
â”‚   ç‰¹æ€§ï¼š                                                                          â”‚
â”‚   âœ… ç¡®å®šæ€§ (Deterministic): ç›¸åŒè¾“å…¥ â†’ ç›¸åŒè¾“å‡º                                 â”‚
â”‚   âœ… æ— å‰¯ä½œç”¨ (No Side Effects): ä¸ä¾èµ–å¤–éƒ¨çŠ¶æ€                                   â”‚
â”‚   âœ… å¯é‡æ”¾ (Replayable): é‡æ”¾è¾“å…¥åºåˆ— â†’ ç›¸åŒç»“æœ                                 â”‚
â”‚   âœ… å¯æµ‹è¯• (Testable): è¾“å…¥è¾“å‡ºæ˜ç¡®ï¼Œæ˜“äºéªŒè¯                                    â”‚
â”‚                                                                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**æ¶æ„ä¸­çš„ Pure State Machines**ï¼š

| ç»„ä»¶ | è¾“å…¥ | çŠ¶æ€ | è¾“å‡º |
|------|------|------|------|
| **UBSCore** | Order Events | Balance State | Balance Events |
| **ME** | Valid Orders | OrderBook | Trade Events |

#### 7.7.3 Event Sourcing + Pure State Machine çš„ä¼˜åŠ¿

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              Event Sourcing + Pure State Machine = æœ€ä½³ç»„åˆ                      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                                  â”‚
â”‚   1. å´©æºƒæ¢å¤                                                                    â”‚
â”‚      ç³»ç»Ÿå´©æºƒ â†’ åŠ è½½ Order WAL â†’ é‡æ”¾åˆ°æœ€åä¸€æ¡ â†’ æ¢å¤å®Œæ•´çŠ¶æ€                    â”‚
â”‚                                                                                  â”‚
â”‚   2. å¤šå‰¯æœ¬ä¸€è‡´æ€§                                                                â”‚
â”‚      å¤šä¸ªèŠ‚ç‚¹ + ç›¸åŒ Order WAL â†’ é‡æ”¾ â†’ å®Œå…¨ç›¸åŒçš„çŠ¶æ€                            â”‚
â”‚                                                                                  â”‚
â”‚   3. è°ƒè¯•å’Œå®¡è®¡                                                                  â”‚
â”‚      ä»»ä½•é—®é¢˜ â†’ é‡æ”¾åˆ°é—®é¢˜å‘ç”Ÿæ—¶åˆ» â†’ è§‚å¯ŸçŠ¶æ€å˜åŒ–                                 â”‚
â”‚                                                                                  â”‚
â”‚   4. æ—¶é—´æ—…è¡Œ                                                                    â”‚
â”‚      æƒ³çŸ¥é“æ˜¨å¤© 14:00 çš„çŠ¶æ€ï¼Ÿâ†’ é‡æ”¾ Order WAL åˆ°é‚£ä¸ªæ—¶åˆ»                         â”‚
â”‚                                                                                  â”‚
â”‚   5. å¢é‡å¿«ç…§                                                                    â”‚
â”‚      å®šæœŸä¿å­˜ Snapshot + ä¹‹åçš„ WAL                                              â”‚
â”‚      æ¢å¤ = åŠ è½½ Snapshot + é‡æ”¾å¢é‡ WAL                                         â”‚
â”‚                                                                                  â”‚
â”‚   6. åˆ†å¸ƒå¼æ‰©å±•                                                                  â”‚
â”‚      æ–°èŠ‚ç‚¹åŠ å…¥ â†’ æ‹‰å– Order WAL â†’ é‡æ”¾ â†’ åŒæ­¥å®Œæˆ                               â”‚
â”‚                                                                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**å…³é”®ç­‰å¼**ï¼š

```
State(t) = Replay(Order_WAL[0..t])

å…¶ä¸­ï¼š
  - Order_WAL = æ‰€æœ‰è®¢å•çš„æŒä¹…åŒ–åºåˆ—
  - Replay = çº¯çŠ¶æ€æœºé‡æ”¾å‡½æ•°
  - State = Balance + OrderBook + TradeHistory
```

#### 7.7.4 ä¸ä¼ ç»Ÿæ¶æ„çš„å¯¹æ¯”

| ä¼ ç»Ÿæ¶æ„ | Event Sourcing + PSM |
|---------|---------------------|
| åªå­˜å‚¨å½“å‰çŠ¶æ€ | å­˜å‚¨å®Œæ•´äº‹ä»¶å†å² |
| çŠ¶æ€ä¸¢å¤±æ— æ³•æ¢å¤ | ä» WAL å®Œå…¨é‡å»º |
| è°ƒè¯•å›°éš¾ | ä»»æ„æ—¶åˆ»å¯é‡æ”¾ |
| å¤šå‰¯æœ¬éš¾ä»¥åŒæ­¥ | é‡æ”¾ WAL ä¿è¯ä¸€è‡´ |
| æ•°æ®åº“æ˜¯æ ¸å¿ƒ | WAL æ˜¯æ ¸å¿ƒï¼Œæ•°æ®åº“æ˜¯æ´¾ç”Ÿ |


### 7.8 ä¸ºä»€ä¹ˆè¿™æ ·è®¾è®¡ï¼Ÿ

| è®¾è®¡å†³ç­– | åŸå›  |
|---------|------|
| UBSCore å•çº¿ç¨‹ | ä½™é¢æ“ä½œå¤©ç„¶åŸå­ï¼Œæ— åŒèŠ± |
| ME ä¸å…³å¿ƒä½™é¢ | èŒè´£åˆ†ç¦»ï¼ŒME åªåšæ’®åˆ |
| Trade Events é©±åŠ¨ | Balance update ä» events ç”Ÿæˆï¼Œå¯é‡æ”¾ |
| Settlement åªæŒä¹…åŒ– | ä¸ä½™é¢æ“ä½œè§£è€¦ï¼Œæ–¹ä¾¿æ‰©å±• |
| Pre-Check åªè¯» | æ— å‰¯ä½œç”¨ï¼Œå¯æ°´å¹³æ‰©å±• |
| **Event Sourcing** | **å®Œæ•´å®¡è®¡ã€å¯æ¢å¤ã€å¯æ‰©å±•** |

### 7.9 æ¢å¤æµç¨‹

```
ç³»ç»Ÿé‡å¯åï¼š

1. UBSCore ä» Snapshot æ¢å¤ Balance State
   â””â”€â”€ æœ€è¿‘çš„ checkpoint

2. UBSCore é‡æ”¾ Order WAL
   â””â”€â”€ ä» checkpoint ä¹‹åçš„è®¢å•å¼€å§‹
   â””â”€â”€ é‡æ–°æ‰§è¡Œ Lock Balance + Forward to ME

3. ME é‡æ–°æ’®åˆ
   â””â”€â”€ ç”Ÿæˆ Trade Events

4. Trade Events â†’ Balance Update
   â””â”€â”€ UBSCore æ‰§è¡Œä½™é¢æ›´æ–°

5. ç³»ç»Ÿæ¢å¤åˆ°å´©æºƒå‰çŠ¶æ€
```

---

## 8. Summary

æœ¬ç« æ ¸å¿ƒè®¾è®¡ï¼š

| è®¾è®¡ç‚¹ | è§£å†³çš„é—®é¢˜ | æ–¹æ¡ˆ |
|--------|------------|------|
| è®¢å•ä¸¢å¤± | ç³»ç»Ÿå´©æºƒåæ— æ³•æ¢å¤ | å…ˆæŒä¹…åŒ–ï¼Œåæ’®åˆ |
| é¡ºåºä¸ä¸€è‡´ | åˆ†å¸ƒå¼èŠ‚ç‚¹é¡ºåºä¸åŒ | å•ç‚¹ Sequencer + å…¨å±€åºå· |
| æ— æ•ˆè®¢å• | æµªè´¹æŒä¹…åŒ–ç©ºé—´ | Pre-Check ä½™é¢æ ¡éªŒ (åªè¯») |
| æŒä¹…åŒ–æ€§èƒ½ | æ•°æ®åº“å¤ªæ…¢ | WAL è¿½åŠ å†™ + Group Commit |
| é”ç«äº‰ | å¤šçº¿ç¨‹åŒæ­¥å¼€é”€ | å•çº¿ç¨‹ + Lock-Free |
| æœåŠ¡é—´é€šä¿¡ | ç½‘ç»œè°ƒç”¨å»¶è¿Ÿé«˜ | Shared Memory Ring Buffer |
| **åŒèŠ±é£é™©** | å¹¶å‘ä¿®æ”¹ä½™é¢ | **UBSCore å•çº¿ç¨‹å¤„ç†æ‰€æœ‰ä½™é¢æ“ä½œ** |
| **èŒè´£ä¸æ¸…** | ME æ—¢æ’®åˆåˆç®¡ä½™é¢ | **ME çº¯æ’®åˆï¼ŒUBSCore ç®¡ä½™é¢** |

**æ ¸å¿ƒæœåŠ¡èŒè´£**ï¼š

| æœåŠ¡ | èŒè´£ |
|------|------|
| **Pre-Check** | åªè¯»æŸ¥è¯¢ UBSCoreï¼Œè¿‡æ»¤æ— æ•ˆè®¢å• |
| **UBSCore** | æ‰€æœ‰ä½™é¢æ“ä½œ + Order WAL (å•çº¿ç¨‹) |
| **ME** | çº¯æ’®åˆï¼Œç”Ÿæˆ Trade Events |
| **Settlement** | æŒä¹…åŒ– eventsï¼Œå†™ DB |

**æ ¸å¿ƒç†å¿µ**ï¼š

> åœ¨ HFT é¢†åŸŸï¼Œ**ç®€å•å°±æ˜¯å¿«**ã€‚å•çº¿ç¨‹ + é¡ºåºå†™ + æ— é”è®¾è®¡ï¼Œ
> æ¯”å¤æ‚çš„å¤šçº¿ç¨‹ + éšæœºå†™ + åŠ é”è®¾è®¡ï¼Œå¾€å¾€å¿« 10-100 å€ã€‚
>
> **èŒè´£åˆ†ç¦»**ï¼šUBSCore ç®¡ä½™é¢ï¼ŒME ç®¡æ’®åˆï¼ŒSettlement ç®¡æŒä¹…åŒ–ã€‚
> æ¯ä¸ªæœåŠ¡å•çº¿ç¨‹ï¼Œè‡ªç„¶åŸå­ï¼Œæ— éœ€åˆ†å¸ƒå¼é”ã€‚
>
> **Event Sourcing + Pure State Machine**ï¼šOrder WAL æ˜¯å”¯ä¸€äº‹å®æ¥æºï¼Œ
> æ‰€æœ‰çŠ¶æ€éƒ½å¯ä»¥ä» WAL 100% é‡å»ºã€‚

**æœ¬ç« ä»£ç é‡æ„**ï¼š

ä¸ºåç»­ç« èŠ‚çš„å®ç°åšå¥½å‡†å¤‡ï¼Œæœ¬ç« å¯¹ä»£ç è¿›è¡Œäº†å¤§è§„æ¨¡æ¨¡å—åŒ–é‡æ„ï¼š

| é‡æ„å†…å®¹ | è¯´æ˜ |
|---------|------|
| `main.rs` | ä» 963 è¡Œç²¾ç®€åˆ° 394 è¡Œï¼Œåªä¿ç•™ä¸»æµç¨‹ç¼–æ’ |
| `engine.rs` â†’ `orderbook.rs` | æå– OrderBook ä¸ºç‹¬ç«‹æ¨¡å— |
| `enforced_balance.rs` â†’ `balance.rs` | é‡å‘½åä¸ºæ›´ç®€æ´çš„æ¨¡å—å |
| æ–°å¢ `types.rs` â†’ `core_types.rs` | æ ¸å¿ƒç±»å‹åˆ«å (AssetId, UserId, OrderId, TradeId) |
| æ–°å¢ `config.rs` | TradingConfig, AssetConfig, SymbolConfig |
| æ–°å¢ `csv_io.rs` | æ‰€æœ‰ CSV åŠ è½½/ä¿å­˜å‡½æ•° |
| æ–°å¢ `ledger.rs` | LedgerWriter, LedgerEntry |
| æ–°å¢ `perf.rs` | PerfMetrics æ€§èƒ½æŒ‡æ ‡ |
| æ–°å¢ `lib.rs` | æ¨¡å—å¯¼å‡ºï¼Œcrate å…¥å£ |
| `OrderBook.all_orders()` | æŒ‰ä»·æ ¼ä¼˜å…ˆåºè¾“å‡ºï¼ˆä¹°å•é«˜ä»·ä¼˜å…ˆï¼Œå–å•ä½ä»·ä¼˜å…ˆï¼‰ |

**æ¨¡å—ç»“æ„ç°åœ¨ä¸º**ï¼š

```
src/
â”œâ”€â”€ lib.rs           # crate å…¥å£ï¼Œæ¨¡å—å¯¼å‡º
â”œâ”€â”€ main.rs          # ä¸»æµç¨‹ç¼–æ’
â”œâ”€â”€ core_types.rs    # æ ¸å¿ƒç±»å‹åˆ«å
â”œâ”€â”€ config.rs        # é…ç½®ç»“æ„
â”œâ”€â”€ balance.rs       # Balance ç»“æ„å’Œæ“ä½œ
â”œâ”€â”€ user_account.rs  # ç”¨æˆ·è´¦æˆ·ç®¡ç†
â”œâ”€â”€ orderbook.rs     # è®¢å•ç°¿æ•°æ®ç»“æ„
â”œâ”€â”€ engine.rs        # æ’®åˆå¼•æ“
â”œâ”€â”€ models.rs        # Order, Trade ç­‰æ¨¡å‹
â”œâ”€â”€ csv_io.rs        # CSV I/O
â”œâ”€â”€ ledger.rs        # å®¡è®¡æ—¥å¿—
â”œâ”€â”€ perf.rs          # æ€§èƒ½æŒ‡æ ‡
â””â”€â”€ symbol_manager.rs # äº¤æ˜“å¯¹ç®¡ç†
```

---

## 9. ä¸‹ä¸€æ­¥

1. **å®ç° UBSCore Service**ï¼š`src/ubscore.rs`
   - Balance state ç®¡ç†
   - Order WAL å†™å…¥
   - Balance lock/unlock/spend_frozen/deposit
   
2. **å®ç° Ring Buffer**ï¼š`src/ringbuffer.rs`
   - æœåŠ¡é—´æ— é”é€šä¿¡
   
3. **é‡æ„ ME**ï¼š`src/engine.rs`
   - ç§»é™¤æ‰€æœ‰ balance ç›¸å…³ä»£ç 
   - åªè´Ÿè´£æ’®åˆï¼Œè¾“å‡º Trade Events
   
4. **å®ç° Settlement**ï¼š`src/settlement.rs`
   - æŒä¹…åŒ– Trade/Order Events
   - å†™å®¡è®¡æ—¥å¿—
   
5. **é›†æˆæµ‹è¯•**ï¼šéªŒè¯å®Œæ•´æµç¨‹

