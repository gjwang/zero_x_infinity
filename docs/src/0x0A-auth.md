# 0x10 安全体系: API Key 与 鉴权

> **📅 状态**: 规划中
> **核心目标**: 实现生产级的 API 安全访问机制，确保用户交易指令的合法性。

---

## 背景

在第一阶段（0x01-0x09）中，我们构建了强大的撮合引擎核心。然而，目前的 Gateway 任何人都可以在知道 `user_id` 的情况下发起下单请求，这在公网环境下是极其危险的。

为了将系统推向产品化，我们必须建立一套基于密码学的身份验证体系。

## 核心任务

### 1. API Key 管理
- 每个用户可以拥有多个 API Key 对。
- `Access Key`: 公开标识符，用于查找用户及权限。
- `Secret Key` / `Public Key`: 用于签名验证（取决于签名算法类型）。

### 2. 数字签名机制

支持两种签名方式：

#### 2.1 对称签名 (HMAC-SHA256) - 默认
- 客户端对请求参数（Method, Path, Timestamp, Body）进行排序并加盐签名。
- 服务端通过相同的 `Secret Key` 验证签名。
- **适用场景**: 服务端调用、Bot 交易。

#### 2.2 非对称签名 (Ed25519/ECDSA) - 高安全
- 用户持有 `Private Key`，服务端只存储 `Public Key`。
- 客户端使用私钥签名请求，服务端使用公钥验证。
- **优势**: 即使服务端数据库泄露，攻击者也无法伪造签名。
- **适用场景**: 高频交易、机构客户、冷钱包签名。

| 特性 | HMAC-SHA256 | Ed25519 |
|------|-------------|---------|
| 密钥存储 | 服务端存储 Secret | 服务端只存 Public Key |
| 安全性 | 中 | 高 |
| 复杂度 | 低 | 中 |
| 推荐场景 | API Bot | 高安全需求 |

#### 通用安全措施
- **重放攻击保护**: 引入 `timestamp`，服务端校验请求时效性（30s 内有效）。
- **Nonce 机制**: 可选，防止重复请求攻击。

### 3. 限流与权限控制 (Rate Limiting & RBAC)
- 根据 API Key 的等级进行请求速率限制。
- 区分 Read-Only (查询) 与 Trade (操作) 权限。

## 架构路线

1. **中间件层**: 在 Gateway 引入 Auth Middleware。
2. **鉴权服务**: 独立或集成的 Key-Store 验证逻辑。
3. **数据库**: 在 TDengine 或其他存储中增加 `api_keys` 表。

---

> 此章节内容将随着开发进度持续更新。
