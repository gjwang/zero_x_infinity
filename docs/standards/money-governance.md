# Money Governance Standard | èµ„é‡‘æ“ä½œæ²»ç†è§„èŒƒ

> **Version**: 1.2 | **Last Updated**: 2025-12-31
>
> æœ¬æ–‡ä»¶å®šä¹‰äº†æœ¬é¡¹ç›®å¤„ç†èµ„é‡‘ï¼ˆä½™é¢ã€è®¢å•é‡‘é¢ã€æˆäº¤ä»·æ ¼ï¼‰çš„æœ€é«˜æ³•åˆ™ã€‚
> ä»»ä½•è¿åæœ¬è§„èŒƒçš„ä»£ç **ä¸å¾—åˆå¹¶**ã€‚

---

## Part I: é—®é¢˜åŸŸ (Problem Domain)

### 1.1 æ ¸å¿ƒé£é™©ï¼šç¼©æ”¾åœ°ç‹± (Scaling Hell)

åœ¨é‡‘èç³»ç»Ÿä¸­ï¼Œ"é’±"ä¸æ˜¯ä¸€ä¸ªåŸå§‹æ•´æ•°ï¼Œè€Œæ˜¯ä¸€ä¸ªå¸¦æœ‰**å›ºå®šç²¾åº¦**çš„é¢†åŸŸæ¦‚å¿µã€‚å°†å…¶è§†ä¸º `u64` å¹¶æ‰‹åŠ¨è¿›è¡Œ `* 10^8` è¿ç®—ï¼Œä¼šå¯¼è‡´ï¼š

| é£é™©ç±»å‹ | åæœ |
|----------|------|
| **è´¦æœ¬æ— æ³•å¯¹é½** | ä»»ä½•å¾®å°è¯¯å·®éƒ½ä¼šç ´å"èµ„é‡‘æ’ç­‰å®šç†"ï¼Œå¯¼è‡´æ— æ³• 100% ç²¾ç¡®å¯¹è´¦ã€‚æˆ‘ä»¬æ— æ³•åŒºåˆ†"æ­£å¸¸è¯¯å·®"è¿˜æ˜¯"çœŸæ­£çš„ Bug"ï¼ŒçœŸå®é—®é¢˜å¯èƒ½è¢«éšè—ã€‚ |
| **è¯­ä¹‰é”™è¯¯** | é”™è¯¯åœ°å°† BTC é‡‘é¢ä¸ USDT é‡‘é¢ç›´æ¥ç›¸åŠ ã€‚ |
| **æº¢å‡ºæ”»å‡»** | æ¶æ„æ„é€ çš„è¶…å¤§æ•°å€¼å¯¼è‡´ç³»ç»Ÿå´©æºƒæˆ–èµ„é‡‘é”™ç®—ã€‚ |
| **ç»´æŠ¤å™©æ¢¦** | ä»£ç åº“ä¸­æ•£è½ç€æ— æ•°ä¸ª `10u64.pow(8)`ã€‚è½¬æ¢é€»è¾‘å¤æ‚ï¼Œåˆ°å¤„é‡å¤å†™å¿…ç„¶åˆ°å¤„çŠ¯é”™ï¼›ä¿®æ”¹ä¸€å¤„é—æ¼å¦ä¸€å¤„ã€‚ |

### 1.2 è®¾è®¡é€‰æ‹©ï¼šä¸ºä»€ä¹ˆé€‰æ‹© `u64` + å†…éƒ¨ç¼©æ”¾ï¼Ÿ

**ç›®æ ‡**ï¼šæè‡´çš„æ’®åˆæ•ˆç‡ã€‚

åœ¨é«˜é¢‘æ’®åˆå¼•æ“ä¸­ï¼Œæ¯ä¸€çº³ç§’éƒ½è‡³å…³é‡è¦ã€‚æˆ‘ä»¬é€‰æ‹© `u64` ä½œä¸ºå†…éƒ¨é‡‘é¢è¡¨ç¤ºï¼ŒåŸå› å¦‚ä¸‹ï¼š

| æ–¹æ¡ˆ | æ€§èƒ½ | ç²¾åº¦ | å¤æ‚åº¦ |
|------|------|------|--------|
| `f64` (æµ®ç‚¹æ•°) | å¿« | âŒ ç²¾åº¦ä¸¢å¤± | ä½ |
| `Decimal` (ä»»æ„ç²¾åº¦) | æ…¢ (10x+) | âœ… ç²¾ç¡® | ä¸­ |
| **`u64` (æ•´æ•°ç¼©æ”¾)** | **æœ€å¿«** | âœ… ç²¾ç¡® | **é«˜** |

**æƒè¡¡**ï¼š`u64` éœ€è¦è¿›è¡Œ**å†…éƒ¨ç¼©æ”¾**ï¼ˆä¾‹å¦‚ï¼Œ1 BTC å­˜å‚¨ä¸º `100_000_000` èªï¼‰ã€‚è¿™å¼•å…¥äº†å¤æ‚æ€§ï¼š
- ä¸åŒèµ„äº§æœ‰ä¸åŒçš„ç²¾åº¦ï¼ˆBTC 8ä½ï¼ŒETH 18ä½ï¼ŒUSDT 6ä½ï¼‰ã€‚
- è½¬æ¢é€»è¾‘æ¶‰åŠå¹‚è¿ç®—ã€æº¢å‡ºæ£€æŸ¥ã€ç²¾åº¦éªŒè¯ã€‚

> [!IMPORTANT]
> **æ ¸å¿ƒç»“è®º**ï¼šæ­£å› ä¸ºé€‰æ‹©äº†é«˜æ•ˆä½†å¤æ‚çš„ `u64` ç¼©æ”¾æ–¹æ¡ˆï¼Œæˆ‘ä»¬**å¿…é¡»**å°†å…·ä½“çš„ç¼©æ”¾ç®—æ³•å°è£…èµ·æ¥ï¼Œ**ä¸¥ç¦æ‰‹å·¥è£¸ç¼©æ”¾**ã€‚
> è¿™æ˜¯æ•ˆç‡ä¸å®‰å…¨çš„å¹³è¡¡ç‚¹ã€‚

---

### 1.3 ç²¾åº¦å¤©èŠ±æ¿ (`u64` çš„æé™)

`u64` æœ€å¤§å€¼çº¦ä¸º `1.84 * 10^19`ã€‚

| èµ„äº§ç²¾åº¦ | æœ€å¤§å¯å¤„ç†é‡‘é¢ | ç¤ºä¾‹ |
|----------|----------------|------|
| 8 ä½ (BTC) | 184,467,440,737 BTC | è¿œè¶…æ€»ä¾›åº”é‡ï¼Œå®‰å…¨ |
| 18 ä½ (ETH) | **18.44 ETH** | âš ï¸ å­˜åœ¨æº¢å‡ºé£é™© |
| 18 ä½ (SHIB) | æå°æ•°é‡ | âš ï¸ æ— æ³•å¤„ç†å¤§æˆ·äº¤æ˜“ |

> [!WARNING]
> **å½“å‰å†³ç­–**: å¯¹äº 18 ä½ç²¾åº¦èµ„äº§ï¼Œç³»ç»Ÿåœ¨åˆæœŸé˜¶æ®µå¯æ¥å—æ­¤é™åˆ¶ã€‚**æœªæ¥å‡çº§è·¯å¾„**: å°†å†…éƒ¨è¡¨ç¤ºä» `u64` å‡çº§ä¸º `u128`ã€‚

---

## Part II: è§£å†³æ–¹æ¡ˆä¸å†³ç­– (Solutions & Decisions)

### 2.1 ç±»å‹å®‰å…¨ï¼šNewtype å®ˆå« (The Newtype Guardian)

**é—®é¢˜**: `u64` æ˜¯åŸç”Ÿç±»å‹ï¼Œå¼€å‘è€…å¯ä»¥è½»æ˜“å†™å‡º `amount * 10u64.pow(8)`ã€‚

**æ–¹æ¡ˆ**: å¼•å…¥**ä¸é€æ˜**çš„åŒ…è£…ç±»å‹ `ScaledAmount(u64)`:
- å†…éƒ¨å­—æ®µ `u64` æ˜¯ **private** çš„ï¼Œæ— æ³•ç›´æ¥è®¿é—®ã€‚
- æ‰€æœ‰æ„é€ å¿…é¡»é€šè¿‡ `money.rs` æä¾›çš„å®¡è®¡è¿‡çš„ Constructorã€‚
- å¦‚æœæœ‰äººæƒ³"ç§è‡ªè®¡ç®—"ï¼Œä»–å¿…é¡»å…ˆè§£åŒ…ï¼ˆ`to_raw()`ï¼‰ï¼Œè¿™ç§"ä¸è‡ªç„¶"çš„æ“ä½œåœ¨ Code Review ä¸­ä¸€çœ¼å¯è§ã€‚

```rust
// ğŸ›¡ï¸ æ ¸å¿ƒç±»å‹å®šä¹‰
pub struct ScaledAmount(u64);        // æ— ç¬¦å·ï¼šä½™é¢ã€è®¢å•æ•°é‡
pub struct ScaledAmountSigned(i64);  // æœ‰ç¬¦å·ï¼šç›ˆäºã€å·®é¢
```

**å·²å®ç°**:
- [x] `ScaledAmount` / `ScaledAmountSigned` å®šä¹‰
- [x] `checked_add` / `checked_sub` å®‰å…¨ç®—æœ¯
- [x] `Deref<Target = u64>` å…è®¸æ¯”è¾ƒï¼Œä½†ç¦æ­¢ç›´æ¥ç®—æœ¯

---

### 2.2 è®¿é—®æ§åˆ¶ï¼šå…¥å£æ”¶ç¼© (Visibility Chokepoint)

**é—®é¢˜**: å¦‚æœåº•å±‚å‡½æ•° `parse_amount(str, decimals)` æ˜¯ `pub` çš„ï¼Œå¼€å‘è€…ä¼šå€¾å‘äºç›´æ¥ä½¿ç”¨å®ƒã€‚

**æ–¹æ¡ˆ**: å°† Layer 1 å·¥å…·å‡½æ•°æ”¶ç¼©ä¸º `pub(crate)`ï¼š

| å¯è§æ€§ | å‡½æ•° | ç”¨é€” |
|--------|------|------|
| `pub(crate)` | `parse_amount`, `format_amount` | ä»…é™ `money.rs` å’Œæ ¸å¿ƒæ¨¡å—å†…éƒ¨ä½¿ç”¨ |
| `pub` | `SymbolManager::parse_qty()`, `SymbolManager::format_price()` | **å¤–éƒ¨å”¯ä¸€å…¥å£** |

**æ•ˆæœ**: åœ¨ä»£ç è‡ªåŠ¨è¡¥å…¨æ—¶ï¼Œå¼€å‘è€…é¦–å…ˆçœ‹åˆ°çš„æ˜¯ `SymbolManager` ä¸Šçš„é«˜å±‚æ–¹æ³•ã€‚

**å·²å®ç°**:
- [x] `parse_amount` / `format_amount` æ”¹ä¸º `pub(crate)`

---

### 2.3 åˆ†å±‚æ¶æ„ (Layered Architecture)

| å±‚çº§ | ç»„ä»¶ | èŒè´£ | å¯è§æ€§ |
|------|------|------|--------|
| **Layer 1 (Core)** | `money.rs` | åŸå­ç±»å‹å®šä¹‰ä¸åº•å±‚ç¼©æ”¾ | `pub(crate)` |
| **Layer 2 (Domain)** | `SymbolManager` | æ„ŸçŸ¥èµ„äº§/äº¤æ˜“å¯¹ç²¾åº¦ï¼Œæä¾›æ„å›¾ API | `pub` |
| **Layer 3 (Integration)** | `MoneyFormatter` | é«˜æ€§èƒ½æ‰¹é‡æ ¼å¼åŒ–ï¼ˆæ·±åº¦å›¾ã€Tickerï¼‰ | `pub` |

> [!TIP]
> **æ‰©å±•æ€§**: `MoneyFormatter` ç›®å‰æœåŠ¡äºæ·±åº¦å›¾ã€‚éšç€ Kline/Ticker å¤æ‚åŒ–ï¼Œæ­¤æ¨¡å¼å¯æ¨å¹¿è‡³æ‰€æœ‰è¡Œæƒ…å±•ç¤ºã€‚

---

## Part III: UX ä¸æ˜¾ç¤ºç­–ç•¥ (UX & Display Strategy)

### 3.1 ä¸¥æ ¼è§£æ vs. ç”¨æˆ·ä½“éªŒ

**å†³ç­–**: æ‹’ç» `.5` å’Œ `5.` ç­‰ç®€å†™ï¼Œå¼ºåˆ¶è¦æ±‚ `0.5` å’Œ `5.0`ã€‚

| å› ç´  | æƒè¡¡ |
|------|------|
| âœ… **å®‰å…¨æ€§** | æ¶ˆé™¤æ­§ä¹‰ï¼Œé˜²æ­¢æ‰‹æŠ–/è„šæœ¬è¾“å…¥ä¸å®Œæ•´æ•°å­— |
| âš ï¸ **API UX** | å¯¹æ‰‹å†™ cURL çš„å¼€å‘è€…ç•¥æ˜¾"æŒ‘å‰”" |

**è¡ŒåŠ¨é¡¹**:
- [ ] åœ¨ OpenAPI æ–‡æ¡£å’Œé”™è¯¯ä¿¡æ¯ä¸­æ˜ç¡®æç¤ºæ­¤è§„èŒƒ

---

### 3.2 æˆªæ–­ (Truncation) vs. å››èˆäº”å…¥ (Rounding)

**å½“å‰ç­–ç•¥**: ç»Ÿä¸€ä½¿ç”¨**è´¢åŠ¡æˆªæ–­**ã€‚

| åœºæ™¯ | ç­–ç•¥ | åŸå›  |
|------|------|------|
| **èµ„äº§ä½™é¢** | æˆªæ–­ (å¿…é¡») | å®æ„¿å°‘æ˜¾ç¤ºï¼Œä¹Ÿä¸èƒ½è®©ç”¨æˆ·è®¤ä¸ºè‡ªå·±æœ‰ä¸å­˜åœ¨çš„ 0.00000001 |
| **æˆäº¤ä»·æ ¼** | æˆªæ–­ (å½“å‰) | æè‡´èµ„é‡‘å®‰å…¨ |

**æœªæ¥è€ƒé‡**:
- [ ] è§†äº§å“éœ€æ±‚ï¼Œå¯åœ¨ `display_decimals` å±‚å¼•å…¥å››èˆäº”å…¥é€‰é¡¹ï¼ˆä»…ç”¨äº UI å±•ç¤ºï¼Œä¸å½±å“å†…éƒ¨è®¡ç®—ï¼‰

---

## Part IV: å¼ºåˆ¶æ‰§è¡Œæœºåˆ¶ (Enforcement Mechanisms)

### 4.1 ç¼–è¯‘æœŸï¼šç±»å‹ç³»ç»Ÿå±éšœ
- `ScaledAmount` æ— æ³•ä¸ `u64` ç›´æ¥è¿ç®—ã€‚
- å¿…é¡»é€šè¿‡ `Deref` (`*amount`) æˆ– `.to_raw()` æ˜¾å¼"é€ƒé€¸"ã€‚

### 4.2 ä»£ç å®¡æŸ¥ï¼šé«˜å¯è§æ€§ä¿¡å·
- ä»»ä½•ä½¿ç”¨ `.to_raw()` çš„åœ°æ–¹éƒ½åº”è¢«è§†ä¸º**éœ€è¦é¢å¤–å®¡æŸ¥**çš„ä¿¡å·ã€‚
- ä»»ä½•åœ¨ `money.rs` ä¹‹å¤–å‡ºç°çš„ `10u64.pow` éƒ½æ˜¯**ç»å¯¹ç¦æ­¢**çš„ã€‚

### 4.3 è‡ªåŠ¨åŒ–å®¡è®¡ (CI)
**å®¡è®¡è„šæœ¬**: `scripts/audit_money_safety.sh` (å¾…å®ç°)

```bash
# æ£€æŸ¥é money.rs æ–‡ä»¶ä¸­æ˜¯å¦å­˜åœ¨æ‰‹åŠ¨ç¼©æ”¾
grep -rn "10u64.pow" --include="*.rs" --exclude="money.rs" src/
grep -rn "Decimal::from(10).powi" --include="*.rs" --exclude="money.rs" src/
```
**é›†æˆ**: å°†è„šæœ¬åŠ å…¥ `.github/workflows` å’Œæœ¬åœ° pre-commit hookã€‚

### 4.4 Agent è®°å¿† (AGENTS.md)
**å·²ç”Ÿæ•ˆ**: `AGENTS.md` å¿…è¯»åˆ—è¡¨ä¸­åŒ…å«æœ¬è§„èŒƒã€‚æ‰€æœ‰ AI Agent åœ¨å¼€å§‹å·¥ä½œå‰å¿…é¡»é˜…è¯»ã€‚

---

## Part V: æœªæ¥å‡çº§è·¯å¾„ (Future Upgrade Path)

| é˜¶æ®µ | ç›®æ ‡ | çŠ¶æ€ |
|------|------|------|
| **Phase 0** | Newtype å®šä¹‰, API æ”¶ç¼©, æ–‡æ¡£æ²»ç† | âœ… å·²å®Œæˆ |
| **Phase 1** | `audit_money_safety.sh` é›†æˆ CI | â³ å¾…å®ç° |
| **Phase 2** | å­˜é‡ä»£ç å…¨é¢æ‰«æä¸è¿ç§» | â³ å¾…æ‰§è¡Œ |
| **Phase 3** | `u64` â†’ `u128` å‡çº§ (æ”¯æŒ 18 ä½é«˜ç²¾åº¦èµ„äº§) | ğŸ“‹ è§„åˆ’ä¸­ |

---

## æ€»ç»“ï¼šä¸ºä»€ä¹ˆå¦‚æ­¤ä¸¥è‹› (Why So Heavy?)

### æ ¸å¿ƒåŸåˆ™ 1ï¼šè´¦æœ¬å¿…é¡» 100% å¯å¯¹è´¦

> å¦‚æœå…è®¸ä»»ä½•ç²¾åº¦è¯¯å·®çš„å­˜åœ¨ï¼Œç³»ç»Ÿçš„è´¦æœ¬å°±æ— æ³•åšåˆ° **100% å¯¹é½**ã€‚
> æˆ‘ä»¬æ— æ³•åˆ©ç”¨"**èµ„é‡‘æ’ç­‰å®šç†**"ï¼ˆæ€»å…¥é‡‘ = æ€»ä½™é¢ + æ€»å‡ºé‡‘ï¼‰æ¥è¿›è¡Œç²¾ç¡®å¯¹è´¦ã€‚
> ä¸€æ—¦è´¦æœ¬ä¸èƒ½ 100% å¯¹é½ï¼Œæˆ‘ä»¬å°±**æ— æ³•åˆ†è¾¨**ä¸€ä¸ªå·®å¼‚æ˜¯"å¯æ¥å—çš„æ­£å¸¸è¯¯å·®"è¿˜æ˜¯ä¸€ä¸ª**éšè—çš„ Bug**ã€‚
> çœŸæ­£çš„é—®é¢˜å¯èƒ½è¢«"è¯¯å·®"æ©ç›–ï¼Œç›´åˆ°é€ æˆæ— æ³•æŒ½å›çš„æŸå¤±ã€‚

### æ ¸å¿ƒåŸåˆ™ 2ï¼šè½¬æ¢é€»è¾‘å¿…é¡»æ”¶æ•›åˆ°å”¯ä¸€ä½ç½®

> é‡‘é¢è½¬æ¢é€»è¾‘éå¸¸å¤æ‚ï¼ˆç²¾åº¦ã€èˆå…¥ã€æº¢å‡ºæ£€æŸ¥ï¼‰ã€‚
> å¦‚æœå…è®¸åœ¨ä»£ç åº“å„å¤„é‡å¤ç¼–å†™ï¼Œ**æ¯ä¸ªåœ°æ–¹éƒ½å¯èƒ½çŠ¯ä¸åŒçš„é”™è¯¯**ã€‚
> å°†è½¬æ¢æ”¶æ•›åˆ°**å”¯ä¸€çš„ã€ç»è¿‡å……åˆ†å®¡è®¡å’Œæµ‹è¯•çš„ä»£ç ä½ç½®** (`money.rs` + `SymbolManager`)ï¼Œæˆ‘ä»¬å¯ä»¥ï¼š
> - å¯¹è¿™ä¸€å¤„è¿›è¡Œ**ç©·å°½å¼æµ‹è¯•**ï¼ˆè¾¹ç•Œå€¼ã€æº¢å‡ºã€è´Ÿæ•°ç­‰ï¼‰ã€‚
> - ç¡®ä¿**æ‰€æœ‰è°ƒç”¨è€…**éƒ½äº«å—åŒç­‰çš„å®‰å…¨ä¿éšœã€‚
> - åœ¨å‘ç° Bug æ—¶ï¼Œ**åªéœ€ä¿®å¤ä¸€å¤„**ï¼Œå…¨å±€ç”Ÿæ•ˆã€‚

### ç®€å•æ€»ç»“ (The Rules)

- **NO** `10u64.pow()` outside `money.rs`.
- **NO** raw `u64` arithmetic for amounts.
- **NO** implicit scaling.
- **YES** `SymbolManager` for all intent-based conversions.
