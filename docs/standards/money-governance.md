# Money Governance Standard | èµ„é‡‘æ“ä½œæ²»ç†è§„èŒƒ

> **Version**: 1.2 | **Last Updated**: 2025-12-31
>
> æœ¬æ–‡ä»¶å®šä¹‰äº†æœ¬é¡¹ç›®å¤„ç†èµ„é‡‘ï¼ˆä½™é¢ã€è®¢å•é‡‘é¢ã€æˆäº¤ä»·æ ¼ï¼‰çš„æœ€é«˜æ³•åˆ™ã€‚
> ä»»ä½•è¿åæœ¬è§„èŒƒçš„ä»£ç **ä¸å¾—åˆå¹¶**ã€‚

---

## Part I: é—®é¢˜åŸŸ (Problem Domain)

### 1.1 æ ¸å¿ƒé£é™©ï¼šç¼©æ”¾åœ°ç‹± (Scaling Hell)

åœ¨é‡‘èç³»ç»Ÿä¸­ï¼Œ"é’±"ä¸æ˜¯ä¸€ä¸ªåŸå§‹æ•´æ•°ï¼Œè€Œæ˜¯ä¸€ä¸ªå¸¦æœ‰**å›ºå®šç²¾åº¦**çš„é¢†åŸŸæ¦‚å¿µã€‚å°†å…¶è§†ä¸º `u64` å¹¶æ‰‹åŠ¨è¿›è¡Œ `* 10^8` è¿ç®—ï¼Œä¼šå¯¼è‡´ï¼š

| é£é™©ç±»å‹ | åæœ |
|----------|------|
| **ç²¾åº¦ä¸¢å¤±** | 1 èªçš„è¯¯å·®ï¼Œåœ¨ç™¾ä¸‡ç¬”äº¤æ˜“åç´¯ç§¯ä¸ºèµ„ä¸æŠµå€ºã€‚ |
| **è¯­ä¹‰é”™è¯¯** | é”™è¯¯åœ°å°† BTC é‡‘é¢ä¸ USDT é‡‘é¢ç›´æ¥ç›¸åŠ ã€‚ |
| **æº¢å‡ºæ”»å‡»** | æ¶æ„æ„é€ çš„è¶…å¤§æ•°å€¼å¯¼è‡´ç³»ç»Ÿå´©æºƒæˆ–èµ„é‡‘é”™ç®—ã€‚ |
| **ç»´æŠ¤å™©æ¢¦** | ä»£ç åº“ä¸­æ•£è½ç€æ— æ•°ä¸ª `10u64.pow(8)`ï¼Œä¿®æ”¹ä¸€å¤„é—æ¼å¦ä¸€å¤„ã€‚ |

### 1.2 ç²¾åº¦å¤©èŠ±æ¿ (`u64` çš„æé™)

`u64` æœ€å¤§å€¼çº¦ä¸º `1.84 * 10^19`ã€‚

| èµ„äº§ç²¾åº¦ | æœ€å¤§å¯å¤„ç†é‡‘é¢ | ç¤ºä¾‹ |
|----------|----------------|------|
| 8 ä½ (BTC) | 184,467,440,737 BTC | è¿œè¶…æ€»ä¾›åº”é‡ï¼Œå®‰å…¨ |
| 18 ä½ (ETH) | **18.44 ETH** | âš ï¸ å­˜åœ¨æº¢å‡ºé£é™© |
| 18 ä½ (SHIB) | æå°æ•°é‡ | âš ï¸ æ— æ³•å¤„ç†å¤§æˆ·äº¤æ˜“ |

> [!WARNING]
> **å½“å‰å†³ç­–**: å¯¹äº 18 ä½ç²¾åº¦èµ„äº§ï¼Œç³»ç»Ÿåœ¨åˆæœŸé˜¶æ®µå¯æ¥å—æ­¤é™åˆ¶ã€‚**æœªæ¥å‡çº§è·¯å¾„**: å°†å†…éƒ¨è¡¨ç¤ºä» `u64` å‡çº§ä¸º `u128`ã€‚

---

## Part II: è§£å†³æ–¹æ¡ˆä¸å†³ç­– (Solutions & Decisions)

### 2.1 ç±»å‹å®‰å…¨ï¼šNewtype å®ˆå« (The Newtype Guardian)

**é—®é¢˜**: `u64` æ˜¯åŸç”Ÿç±»å‹ï¼Œå¼€å‘è€…å¯ä»¥è½»æ˜“å†™å‡º `amount * 10u64.pow(8)`ã€‚

**æ–¹æ¡ˆ**: å¼•å…¥**ä¸é€æ˜**çš„åŒ…è£…ç±»å‹ `ScaledAmount(u64)`:
- å†…éƒ¨å­—æ®µ `u64` æ˜¯ **private** çš„ï¼Œæ— æ³•ç›´æ¥è®¿é—®ã€‚
- æ‰€æœ‰æ„é€ å¿…é¡»é€šè¿‡ `money.rs` æä¾›çš„å®¡è®¡è¿‡çš„ Constructorã€‚
- å¦‚æœæœ‰äººæƒ³"ç§è‡ªè®¡ç®—"ï¼Œä»–å¿…é¡»å…ˆè§£åŒ…ï¼ˆ`to_raw()`ï¼‰ï¼Œè¿™ç§"ä¸è‡ªç„¶"çš„æ“ä½œåœ¨ Code Review ä¸­ä¸€çœ¼å¯è§ã€‚

```rust
// ğŸ›¡ï¸ æ ¸å¿ƒç±»å‹å®šä¹‰
pub struct ScaledAmount(u64);        // æ— ç¬¦å·ï¼šä½™é¢ã€è®¢å•æ•°é‡
pub struct ScaledAmountSigned(i64);  // æœ‰ç¬¦å·ï¼šç›ˆäºã€å·®é¢
```

**å·²å®ç°**:
- [x] `ScaledAmount` / `ScaledAmountSigned` å®šä¹‰
- [x] `checked_add` / `checked_sub` å®‰å…¨ç®—æœ¯
- [x] `Deref<Target = u64>` å…è®¸æ¯”è¾ƒï¼Œä½†ç¦æ­¢ç›´æ¥ç®—æœ¯

---

### 2.2 è®¿é—®æ§åˆ¶ï¼šå…¥å£æ”¶ç¼© (Visibility Chokepoint)

**é—®é¢˜**: å¦‚æœåº•å±‚å‡½æ•° `parse_amount(str, decimals)` æ˜¯ `pub` çš„ï¼Œå¼€å‘è€…ä¼šå€¾å‘äºç›´æ¥ä½¿ç”¨å®ƒã€‚

**æ–¹æ¡ˆ**: å°† Layer 1 å·¥å…·å‡½æ•°æ”¶ç¼©ä¸º `pub(crate)`ï¼š

| å¯è§æ€§ | å‡½æ•° | ç”¨é€” |
|--------|------|------|
| `pub(crate)` | `parse_amount`, `format_amount` | ä»…é™ `money.rs` å’Œæ ¸å¿ƒæ¨¡å—å†…éƒ¨ä½¿ç”¨ |
| `pub` | `SymbolManager::parse_qty()`, `SymbolManager::format_price()` | **å¤–éƒ¨å”¯ä¸€å…¥å£** |

**æ•ˆæœ**: åœ¨ä»£ç è‡ªåŠ¨è¡¥å…¨æ—¶ï¼Œå¼€å‘è€…é¦–å…ˆçœ‹åˆ°çš„æ˜¯ `SymbolManager` ä¸Šçš„é«˜å±‚æ–¹æ³•ã€‚

**å·²å®ç°**:
- [x] `parse_amount` / `format_amount` æ”¹ä¸º `pub(crate)`

---

### 2.3 åˆ†å±‚æ¶æ„ (Layered Architecture)

| å±‚çº§ | ç»„ä»¶ | èŒè´£ | å¯è§æ€§ |
|------|------|------|--------|
| **Layer 1 (Core)** | `money.rs` | åŸå­ç±»å‹å®šä¹‰ä¸åº•å±‚ç¼©æ”¾ | `pub(crate)` |
| **Layer 2 (Domain)** | `SymbolManager` | æ„ŸçŸ¥èµ„äº§/äº¤æ˜“å¯¹ç²¾åº¦ï¼Œæä¾›æ„å›¾ API | `pub` |
| **Layer 3 (Integration)** | `MoneyFormatter` | é«˜æ€§èƒ½æ‰¹é‡æ ¼å¼åŒ–ï¼ˆæ·±åº¦å›¾ã€Tickerï¼‰ | `pub` |

> [!TIP]
> **æ‰©å±•æ€§**: `MoneyFormatter` ç›®å‰æœåŠ¡äºæ·±åº¦å›¾ã€‚éšç€ Kline/Ticker å¤æ‚åŒ–ï¼Œæ­¤æ¨¡å¼å¯æ¨å¹¿è‡³æ‰€æœ‰è¡Œæƒ…å±•ç¤ºã€‚

---

## Part III: UX ä¸æ˜¾ç¤ºç­–ç•¥ (UX & Display Strategy)

### 3.1 ä¸¥æ ¼è§£æ vs. ç”¨æˆ·ä½“éªŒ

**å†³ç­–**: æ‹’ç» `.5` å’Œ `5.` ç­‰ç®€å†™ï¼Œå¼ºåˆ¶è¦æ±‚ `0.5` å’Œ `5.0`ã€‚

| å› ç´  | æƒè¡¡ |
|------|------|
| âœ… **å®‰å…¨æ€§** | æ¶ˆé™¤æ­§ä¹‰ï¼Œé˜²æ­¢æ‰‹æŠ–/è„šæœ¬è¾“å…¥ä¸å®Œæ•´æ•°å­— |
| âš ï¸ **API UX** | å¯¹æ‰‹å†™ cURL çš„å¼€å‘è€…ç•¥æ˜¾"æŒ‘å‰”" |

**è¡ŒåŠ¨é¡¹**:
- [ ] åœ¨ OpenAPI æ–‡æ¡£å’Œé”™è¯¯ä¿¡æ¯ä¸­æ˜ç¡®æç¤ºæ­¤è§„èŒƒ

---

### 3.2 æˆªæ–­ (Truncation) vs. å››èˆäº”å…¥ (Rounding)

**å½“å‰ç­–ç•¥**: ç»Ÿä¸€ä½¿ç”¨**è´¢åŠ¡æˆªæ–­**ã€‚

| åœºæ™¯ | ç­–ç•¥ | åŸå›  |
|------|------|------|
| **èµ„äº§ä½™é¢** | æˆªæ–­ (å¿…é¡») | å®æ„¿å°‘æ˜¾ç¤ºï¼Œä¹Ÿä¸èƒ½è®©ç”¨æˆ·è®¤ä¸ºè‡ªå·±æœ‰ä¸å­˜åœ¨çš„ 0.00000001 |
| **æˆäº¤ä»·æ ¼** | æˆªæ–­ (å½“å‰) | æè‡´èµ„é‡‘å®‰å…¨ |

**æœªæ¥è€ƒé‡**:
- [ ] è§†äº§å“éœ€æ±‚ï¼Œå¯åœ¨ `display_decimals` å±‚å¼•å…¥å››èˆäº”å…¥é€‰é¡¹ï¼ˆä»…ç”¨äº UI å±•ç¤ºï¼Œä¸å½±å“å†…éƒ¨è®¡ç®—ï¼‰

---

## Part IV: å¼ºåˆ¶æ‰§è¡Œæœºåˆ¶ (Enforcement Mechanisms)

### 4.1 ç¼–è¯‘æœŸï¼šç±»å‹ç³»ç»Ÿå±éšœ
- `ScaledAmount` æ— æ³•ä¸ `u64` ç›´æ¥è¿ç®—ã€‚
- å¿…é¡»é€šè¿‡ `Deref` (`*amount`) æˆ– `.to_raw()` æ˜¾å¼"é€ƒé€¸"ã€‚

### 4.2 ä»£ç å®¡æŸ¥ï¼šé«˜å¯è§æ€§ä¿¡å·
- ä»»ä½•ä½¿ç”¨ `.to_raw()` çš„åœ°æ–¹éƒ½åº”è¢«è§†ä¸º**éœ€è¦é¢å¤–å®¡æŸ¥**çš„ä¿¡å·ã€‚
- ä»»ä½•åœ¨ `money.rs` ä¹‹å¤–å‡ºç°çš„ `10u64.pow` éƒ½æ˜¯**ç»å¯¹ç¦æ­¢**çš„ã€‚

### 4.3 è‡ªåŠ¨åŒ–å®¡è®¡ (CI)
**å®¡è®¡è„šæœ¬**: `scripts/audit_money_safety.sh` (å¾…å®ç°)

```bash
# æ£€æŸ¥é money.rs æ–‡ä»¶ä¸­æ˜¯å¦å­˜åœ¨æ‰‹åŠ¨ç¼©æ”¾
grep -rn "10u64.pow" --include="*.rs" --exclude="money.rs" src/
grep -rn "Decimal::from(10).powi" --include="*.rs" --exclude="money.rs" src/
```
**é›†æˆ**: å°†è„šæœ¬åŠ å…¥ `.github/workflows` å’Œæœ¬åœ° pre-commit hookã€‚

### 4.4 Agent è®°å¿† (AGENTS.md)
**å·²ç”Ÿæ•ˆ**: `AGENTS.md` å¿…è¯»åˆ—è¡¨ä¸­åŒ…å«æœ¬è§„èŒƒã€‚æ‰€æœ‰ AI Agent åœ¨å¼€å§‹å·¥ä½œå‰å¿…é¡»é˜…è¯»ã€‚

---

## Part V: æœªæ¥å‡çº§è·¯å¾„ (Future Upgrade Path)

| é˜¶æ®µ | ç›®æ ‡ | çŠ¶æ€ |
|------|------|------|
| **Phase 0** | Newtype å®šä¹‰, API æ”¶ç¼©, æ–‡æ¡£æ²»ç† | âœ… å·²å®Œæˆ |
| **Phase 1** | `audit_money_safety.sh` é›†æˆ CI | â³ å¾…å®ç° |
| **Phase 2** | å­˜é‡ä»£ç å…¨é¢æ‰«æä¸è¿ç§» | â³ å¾…æ‰§è¡Œ |
| **Phase 3** | `u64` â†’ `u128` å‡çº§ (æ”¯æŒ 18 ä½é«˜ç²¾åº¦èµ„äº§) | ğŸ“‹ è§„åˆ’ä¸­ |

---

## âš–ï¸ æ€»ç»“ï¼šä¸ºä»€ä¹ˆå¦‚æ­¤ä¸¥è‹› (Why So Heavy?)

> åœ¨æ’®åˆå¼•æ“å±‚é¢ï¼Œå³ä½¿æ˜¯ **1 èª (satoshi)** çš„é”™è¯¯ï¼Œåœ¨æ•°ç™¾ä¸‡æ¬¡äº¤æ˜“åä¹Ÿå¯èƒ½å¯¼è‡´**èµ„ä¸æŠµå€º**ã€‚
>
> è¿™å¥—"é‡å‹"æ²»ç†é€šè¿‡ç±»å‹ç³»ç»Ÿã€è®¿é—®æ§åˆ¶å’Œè‡ªåŠ¨åŒ–å®¡è®¡ï¼Œæä¾›äº†**æ•°å­¦ä¸Šçš„ç¡®å®šæ€§**â€”â€”æ— è®ºé“¾æˆ–èµ„äº§å¤šä¹ˆå¤æ‚ï¼Œç³»ç»Ÿçš„è´¦ç›®å§‹ç»ˆæ˜¯å¹³è¡¡çš„ã€‚
>
> **ç®€å•æ€»ç»“**:
> - **NO** `10u64.pow()` outside `money.rs`.
> - **NO** raw `u64` arithmetic for amounts.
> - **NO** implicit scaling.
> - **YES** `SymbolManager` for all intent-based conversions.
