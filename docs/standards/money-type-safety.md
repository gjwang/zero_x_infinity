# Money Type Safety Standard | èµ„é‡‘ç±»å‹å®‰å…¨è§„èŒƒ

> **Version**: 1.4 | **Last Updated**: 2025-12-31
>
> æœ¬æ–‡ä»¶å®šä¹‰äº†æœ¬é¡¹ç›®å¤„ç†èµ„é‡‘ï¼ˆä½™é¢ã€è®¢å•é‡‘é¢ã€æˆäº¤ä»·æ ¼ï¼‰çš„**æ²»ç†æ–¹æ¡ˆ**ã€‚
> é‡ç‚¹æ˜¯ï¼š**å¦‚ä½•åœ¨ä»£ç å±‚é¢ç¦æ­¢ä¸ç¬¦åˆè§„èŒƒçš„æ“ä½œ**ã€‚
> ä»»ä½•è¿åæœ¬è§„èŒƒçš„ä»£ç **ä¸å¾—åˆå¹¶**ã€‚

---

## Part I: èƒŒæ™¯ä¸è®¾è®¡å†³ç­–

### 1.1 æ ¸å¿ƒé£é™©

**é‡‘é¢æ˜¯é¢†åŸŸæ¦‚å¿µï¼Œä¸æ˜¯åŸå§‹ç±»å‹ã€‚**

åœ¨ä»»ä½•é‡‘èç³»ç»Ÿä¸­ï¼Œ"é’±"éƒ½ä¸åº”è¢«è§†ä¸ºä¸€ä¸ªè£¸éœ²çš„æ•´æ•°ã€‚å®ƒæ˜¯ä¸€ä¸ªæºå¸¦ç²¾åº¦è¯­ä¹‰çš„**é¢†åŸŸå¯¹è±¡**â€”â€”1 BTC å†…éƒ¨è¡¨ç¤ºä¸º `100_000_000` èªï¼Œè¿™ä¸ª `10^8` çš„ç¼©æ”¾å› å­æ˜¯èµ„äº§çš„**å†…åœ¨å±æ€§**ï¼Œè€Œéç¨‹åºå‘˜çš„ä¸´æ—¶å†³å®šã€‚

å½“å¼€å‘è€…åœ¨ä»£ç ä¸­éšæ„å†™ä¸‹ `amount * 10u64.pow(8)` æ—¶ï¼Œä»–å®é™…ä¸Šåœ¨**ç ´åè¿™å±‚æŠ½è±¡**ï¼Œå°†é¢†åŸŸé€»è¾‘æ³„æ¼åˆ°ä¸šåŠ¡ä»£ç çš„æ¯ä¸€ä¸ªè§’è½ã€‚è¿™ä¼šå¯¼è‡´ï¼š

| é£é™©ç±»å‹ | åæœ |
|----------|------|
| **è´¦æœ¬æ— æ³•å¯¹é½** | ä»»ä½•å¾®å°è¯¯å·®éƒ½ä¼šç ´å"èµ„é‡‘æ’ç­‰å®šç†"ï¼Œå¯¼è‡´æ— æ³• 100% ç²¾ç¡®å¯¹è´¦ã€‚æˆ‘ä»¬æ— æ³•åŒºåˆ†"æ­£å¸¸è¯¯å·®"è¿˜æ˜¯"çœŸæ­£çš„ Bug"ã€‚ |
| **è¯­ä¹‰é”™è¯¯** | é”™è¯¯åœ°å°† BTC é‡‘é¢ä¸ USDT é‡‘é¢ç›´æ¥ç›¸åŠ ã€‚ |
| **æº¢å‡ºæ”»å‡»** | æ¶æ„æ„é€ çš„è¶…å¤§æ•°å€¼å¯¼è‡´ç³»ç»Ÿå´©æºƒæˆ–èµ„é‡‘é”™ç®—ã€‚ |
| **ç»´æŠ¤å™©æ¢¦** | è½¬æ¢é€»è¾‘å¤æ‚ï¼Œåˆ°å¤„é‡å¤å†™å¿…ç„¶åˆ°å¤„çŠ¯é”™ã€‚ |

### 1.2 ä¸ºä»€ä¹ˆé€‰æ‹© `u64` + å†…éƒ¨ç¼©æ”¾ï¼Ÿ

> **å‰ç½®é˜…è¯»**: å…³äºæµ®ç‚¹æ•°çš„é—®é¢˜ï¼Œè¯·å‚é˜… [0x02 æµ®ç‚¹æ•°çš„è¯…å’’](../src/0x02-the-curse-of-float.md)ï¼Œæ­¤å¤„ä¸å†é‡å¤ã€‚

**æ ¸å¿ƒç»“è®º**ï¼š
- `f64` æ— æ³•æ»¡è¶³**è·¨å¹³å°ç¡®å®šæ€§**ï¼ˆä¸åŒ CPU/ç¼–è¯‘å™¨ç»“æœå¯èƒ½ä¸åŒï¼‰ã€‚
- `Decimal` æ— æ³•æ»¡è¶³**æè‡´æ€§èƒ½**ï¼ˆæ¯” `u64` æ…¢ 10x+ï¼‰ã€‚
- **`u64` æ˜¯å”¯ä¸€èƒ½åŒæ—¶æ»¡è¶³"åŒºå—é“¾çº§éªŒè¯å¼ºåº¦"å’Œ"é«˜é¢‘æ’®åˆæ€§èƒ½"çš„æ–¹æ¡ˆã€‚**

ä½† `u64` éœ€è¦**å†…éƒ¨ç¼©æ”¾**ï¼Œè¿™å¼•å…¥äº†å¤æ‚æ€§ã€‚å› æ­¤æˆ‘ä»¬å¿…é¡»ï¼š
1. å°†ç¼©æ”¾ç®—æ³•å°è£…åœ¨ `money.rs` ä¸­ã€‚
2. **ä¸¥ç¦**åœ¨å…¶ä»–åœ°æ–¹æ‰‹å·¥è¿›è¡Œç¼©æ”¾è¿ç®—ã€‚

---

### 1.3 å†…éƒ¨ç¼©æ”¾æ–¹æ¡ˆï¼šå¦‚ä½•å®ç°å¤§é¢å¤„ç†ï¼Ÿ

**æ ¸å¿ƒæœºåˆ¶**ï¼šæˆ‘ä»¬ä¸ºæ¯ç§èµ„äº§å®šä¹‰**ç³»ç»Ÿç²¾åº¦**ï¼ˆé€šå¸¸ 8 ä½ï¼‰ï¼Œè€Œéä½¿ç”¨é“¾ä¸ŠåŸç”Ÿç²¾åº¦ï¼ˆå¦‚ ETH çš„ 18 ä½ï¼‰ã€‚

| èµ„äº§ | é“¾ä¸Šç²¾åº¦ | ç³»ç»Ÿç²¾åº¦ | `u64` æœ€å¤§å¯å¤„ç†é‡‘é¢ |
|------|----------|----------|----------------------|
| BTC  | 8 ä½     | 8 ä½     | **1844 äº¿ BTC** (è¿œè¶…æ€»ä¾›åº”é‡) |
| ETH  | 18 ä½    | **8 ä½** | **1844 äº¿ ETH** âœ… |
| USDT | 6 ä½     | 6 ä½     | **18.4 ä¸‡äº¿ USDT** âœ… |

> [!IMPORTANT]
> **ç²¾åº¦æƒè¡¡**ï¼šä½¿ç”¨ 8 ä½ç³»ç»Ÿç²¾åº¦æ„å‘³ç€ ETH æœ€å°å•ä½æ˜¯ `0.00000001 ETH` (10 gwei)ï¼Œè€Œéé“¾ä¸Šçš„ `1 wei`ã€‚
> å¯¹äºäº¤æ˜“æ‰€åœºæ™¯ï¼Œè¿™å®Œå…¨è¶³å¤Ÿâ€”â€”æ²¡æœ‰äººä¼šäº¤æ˜“ 1 wei çš„ ETHã€‚

**è¿™å°±æ˜¯ä¸ºä»€ä¹ˆ"ç¼©æ”¾"å¿…é¡»å°è£…**ï¼š
- ä¸åŒèµ„äº§æœ‰ä¸åŒçš„**é“¾ä¸Šç²¾åº¦**å’Œ**ç³»ç»Ÿç²¾åº¦**ã€‚
- å…¥é‡‘æ—¶ï¼šé“¾ä¸Šç²¾åº¦ â†’ ç³»ç»Ÿç²¾åº¦ï¼ˆå¯èƒ½æˆªæ–­æå°å°¾æ•°ï¼‰ã€‚
- å‡ºé‡‘æ—¶ï¼šç³»ç»Ÿç²¾åº¦ â†’ é“¾ä¸Šç²¾åº¦ï¼ˆè¡¥é›¶ï¼‰ã€‚
- è¿™å¥—è½¬æ¢é€»è¾‘å¤æ‚ï¼Œå¿…é¡»é›†ä¸­ç®¡ç†ï¼Œä¸¥ç¦å„å¤„æ‰‹å†™ã€‚

> [!TIP]
> **`u128` çš„æ›¿ä»£æ–¹æ¡ˆ**ï¼šå¦‚æœä¸è¿½æ±‚æè‡´æ€§èƒ½ï¼Œä½¿ç”¨ `u128` å¯ä»¥ç›´æ¥é‡‡ç”¨ç»Ÿä¸€çš„ 18 ä½ç²¾åº¦ï¼Œé¿å…ä¸åŒèµ„äº§é—´çš„ç²¾åº¦è½¬æ¢é—®é¢˜ã€‚ä½†è¿™ä¼šç‰ºç‰²çº¦ 10-20% çš„æ’®åˆæ€§èƒ½ã€‚

---

## Part II: è§£å†³æ–¹æ¡ˆä¸å†³ç­– (Solutions & Decisions)

### 2.1 ç±»å‹å®‰å…¨ï¼šNewtype å®ˆå« (The Newtype Guardian)

**é—®é¢˜**: `u64` æ˜¯åŸç”Ÿç±»å‹ï¼Œå¼€å‘è€…å¯ä»¥è½»æ˜“å†™å‡º `amount * 10u64.pow(8)`ã€‚

**æ–¹æ¡ˆ**: å¼•å…¥**ä¸é€æ˜**çš„åŒ…è£…ç±»å‹ `ScaledAmount(u64)`:
- å†…éƒ¨å­—æ®µ `u64` æ˜¯ **private** çš„ï¼Œæ— æ³•ç›´æ¥è®¿é—®ã€‚
- æ‰€æœ‰æ„é€ å¿…é¡»é€šè¿‡ `money.rs` æä¾›çš„å®¡è®¡è¿‡çš„ Constructorã€‚
- å¦‚æœæœ‰äººæƒ³"ç§è‡ªè®¡ç®—"ï¼Œä»–å¿…é¡»å…ˆè§£åŒ…ï¼ˆ`to_raw()`ï¼‰ï¼Œè¿™ç§"ä¸è‡ªç„¶"çš„æ“ä½œåœ¨ Code Review ä¸­ä¸€çœ¼å¯è§ã€‚

```rust
// ğŸ›¡ï¸ æ ¸å¿ƒç±»å‹å®šä¹‰
pub struct ScaledAmount(u64);        // æ— ç¬¦å·ï¼šä½™é¢ã€è®¢å•æ•°é‡
pub struct ScaledAmountSigned(i64);  // æœ‰ç¬¦å·ï¼šç›ˆäºã€å·®é¢
```

**å·²å®ç°**:
- [x] `ScaledAmount` / `ScaledAmountSigned` å®šä¹‰
- [x] `checked_add` / `checked_sub` å®‰å…¨ç®—æœ¯
- [x] `Deref<Target = u64>` å…è®¸æ¯”è¾ƒï¼Œä½†ç¦æ­¢ç›´æ¥ç®—æœ¯

---

### 2.2 è®¿é—®æ§åˆ¶ï¼šå…¥å£æ”¶ç¼© (Visibility Chokepoint)

**é—®é¢˜**: å¦‚æœåº•å±‚å‡½æ•° `parse_amount(str, decimals)` æ˜¯ `pub` çš„ï¼Œå¼€å‘è€…ä¼šå€¾å‘äºç›´æ¥ä½¿ç”¨å®ƒã€‚

**æ–¹æ¡ˆ**: å°† Layer 1 å·¥å…·å‡½æ•°æ”¶ç¼©ä¸º `pub(crate)`ï¼š

| å¯è§æ€§ | å‡½æ•° | ç”¨é€” |
|--------|------|------|
| `pub(crate)` | `parse_amount`, `format_amount` | ä»…é™ `money.rs` å’Œæ ¸å¿ƒæ¨¡å—å†…éƒ¨ä½¿ç”¨ |
| `pub` | `SymbolManager::parse_qty()`, `SymbolManager::format_price()` | **å¤–éƒ¨å”¯ä¸€å…¥å£** |

**æ•ˆæœ**: åœ¨ä»£ç è‡ªåŠ¨è¡¥å…¨æ—¶ï¼Œå¼€å‘è€…é¦–å…ˆçœ‹åˆ°çš„æ˜¯ `SymbolManager` ä¸Šçš„é«˜å±‚æ–¹æ³•ã€‚

**å·²å®ç°**:
- [x] `parse_amount` / `format_amount` æ”¹ä¸º `pub(crate)`

---

### 2.3 åˆ†å±‚æ¶æ„ (Layered Architecture)

| å±‚çº§ | ç»„ä»¶ | èŒè´£ | å¯è§æ€§ |
|------|------|------|--------|
| **Layer 1 (Core)** | `money.rs` | åŸå­ç±»å‹å®šä¹‰ä¸åº•å±‚ç¼©æ”¾ | `pub(crate)` |
| **Layer 2 (Domain)** | `Asset` / `AssetInfo` | æ„ŸçŸ¥èµ„äº§ç²¾åº¦ï¼Œæä¾›æ„å›¾å°è£… API | `pub` |
| **Layer 3 (Integration)** | `SymbolManager` / `MoneyFormatter` | äº¤æ˜“å¯¹çº§åˆ«çš„è½¬æ¢ä¸æ‰¹é‡æ ¼å¼åŒ– | `pub` |

> [!TIP]
> **æ‰©å±•æ€§**: `MoneyFormatter` ç›®å‰æœåŠ¡äºæ·±åº¦å›¾ã€‚éšç€ Kline/Ticker å¤æ‚åŒ–ï¼Œæ­¤æ¨¡å¼å¯æ¨å¹¿è‡³æ‰€æœ‰è¡Œæƒ…å±•ç¤ºã€‚

---

### 2.4 é“å¾‹ï¼šæ„å›¾å°è£… API (Intent-based API)

> [!CAUTION]
> **ä¸šåŠ¡ä»£ç ç¦æ­¢ç›´æ¥è°ƒç”¨ `money::` å‡½æ•°ã€‚å¿…é¡»ä½¿ç”¨ `Asset` / `AssetInfo` æä¾›çš„æ„å›¾å°è£… APIã€‚**

**é—®é¢˜**ï¼šç›´æ¥è°ƒç”¨åº•å±‚å‡½æ•°æš´éœ²å®ç°ç»†èŠ‚

```rust
// âŒ é”™è¯¯ï¼šæš´éœ²äº† decimals å‚æ•°ï¼Œè°ƒç”¨è€…éœ€è¦çŸ¥é“å†…éƒ¨å®ç°
let amount_scaled = *money::parse_decimal(amount, asset.decimals as u32)?;
```

**è§£å†³æ–¹æ¡ˆ**ï¼šåœ¨ `Asset` / `AssetInfo` ä¸Šæä¾›æ„å›¾å°è£…æ–¹æ³•

```rust
// âœ… æ­£ç¡®ï¼šè°ƒç”¨è€…åªéœ€è¡¨è¾¾æ„å›¾ï¼Œä¸éœ€è¦çŸ¥é“ decimals
let amount_scaled = asset.parse_amount(amount)?;
let fee_scaled = asset.parse_amount_allow_zero(fee)?;
```

---

### 2.5 é“å¾‹ï¼šFail-Fast ä¸ è¿è¡Œç¨³å®šæ€§ (Fail-Fast vs. Runtime Stability)

> [!CAUTION]
> **é‡‘èç³»ç»Ÿç»ä¸å…è®¸â€œçŒœâ€é…ç½®ï¼Œä½†ä¹Ÿç»ä¸å…è®¸è½»æ˜“å´©æºƒã€‚** å½“ç²¾åº¦ã€æ¯”ä¾‹ç­‰å…³é”®ä¿¡æ¯ç¼ºå¤±æ—¶ï¼Œå¿…é¡»éµå¾ªä»¥ä¸‹å¤„ç†ç­–ç•¥ï¼š

| é˜¶æ®µ | ä¸¥é‡æ€§ | å¤„ç†ç­–ç•¥ (Handling Strategy) |
|------|--------|-----------------------------|
| **å¯åŠ¨é˜¶æ®µ (Startup)** | è‡´å‘½ | **ä¼˜é›…ç»ˆæ­¢**ã€‚è½½å…¥é…ç½®æ—¶é‡åˆ°éæ³•æ•°æ®ï¼Œæ‰“å°æ¸…æ™°é”™è¯¯ä¿¡æ¯åä»¥éé›¶é€€å‡ºç ç»ˆæ­¢ï¼ˆç¦æ­¢ panicï¼‰ã€‚ |
| **è¿è¡Œé˜¶æ®µ (Runtime)** | éè‡´å‘½ | **ç¦æ­¢ Panic**ã€‚å¯¹äºéæ³•æ•°æ®æˆ–ä¸ä¸€è‡´è®°å½•ï¼Œå¿…é¡»ï¼šæ‰“å° Error æ—¥å¿—ã€æ‹’ç»è¯¥ç¬”äº¤æ˜“ã€**ä¼˜é›…é™çº§æˆ–è·³è¿‡**ï¼ˆé’ˆå¯¹åˆ—è¡¨ï¼‰ã€‚ |
| **å¤–éƒ¨è¾“å…¥ (External)** | æ­£å¸¸ | **æ‹’ç»è¯·æ±‚**ã€‚ç”± API Handler è¿”å› 400 é”™è¯¯ï¼Œä¸¥ç¦å› è¾“å…¥éæ³•å¯¼è‡´ç³»ç»Ÿå´©æºƒã€‚ |

**è¿è§„ç¤ºä¾‹**ï¼š
```rust
// âŒ ä¸¥é‡è¿è§„ï¼šè¿è¡Œæ—¶å› æ•°æ®åº“è®°å½•ä¸å…¨å¯¼è‡´å…¨ç«™ Panic å´©æºƒ
let precision = symbol_mgr.get_asset_precision(asset_id).expect("Asset missing"); 
```

**æ­£ç¡®åšæ³•**ï¼š
```rust
// âœ… æ­£ç¡®ï¼šæ˜¾å¼å¤„ç†ï¼Œè¿”å›é”™è¯¯ç ï¼Œè®© Handler æ‹’ç»æœåŠ¡è€Œä¸æ˜¯å´©æºƒ
let precision = symbol_mgr.get_asset_precision(asset_id)
    .ok_or_else(|| DomainError::ConfigMissing(format!("Precision for {}", asset_id)))?;
```

---

### 2.6 å®¡è®¡ä»ªå¼ï¼šFail-Fast é™æ€æ£€æŸ¥ (Audit Ritual)

æ‰€æœ‰æ¶‰åŠåˆ°èµ„äº§ã€ç²¾åº¦ã€ç”¨æˆ·èº«ä»½çš„ä»£ç ï¼Œå¿…é¡»é€šè¿‡è‡ªåŠ¨åŒ–å®¡è®¡è„šæœ¬æ‰«æï¼š

```bash
./scripts/audit_silent_defaults.sh
```

**æ ¸å¿ƒè§„åˆ™**ï¼š**æ‰€æœ‰ `.unwrap_or()` é»˜è®¤ä¸ºè¿è§„**ï¼Œé™¤éæ ‡æ³¨ `// SAFE_DEFAULT:` è¯´æ˜åŸå› ã€‚

**å…è®¸çš„æ ¼å¼**ï¼š
```rust
// åœ¨åŒä¸€è¡Œæœ«å°¾æ·»åŠ è¯´æ˜
.unwrap_or(last_value) // SAFE_DEFAULT: empty list returns current value

// åˆæ³•ç†ç”±ç¤ºä¾‹
// SAFE_DEFAULT: counter defaults to 0
// SAFE_DEFAULT: empty list semantics - no items means no change
// SAFE_DEFAULT: optional display field - empty string is valid
```

**ç¦æ­¢çš„æ¨¡å¼ï¼ˆå¿…é¡»ä¿®å¤æˆ–æ ‡æ³¨ï¼‰**ï¼š
```rust
// âŒ é‡‘é¢/è´¹ç‡é»˜è®¤ - ç»ä¸å…è®¸
.unwrap_or(0) // å¯èƒ½å¯¼è‡´èµ„é‡‘è®¡ç®—é”™è¯¯
.unwrap_or((1000, 2000)) // è´¹ç‡é»˜è®¤å¯¼è‡´ç”¨æˆ·æŸå¤±

// âŒ ID é»˜è®¤ - ç»ä¸å…è®¸  
.unwrap_or(default_user_id) // å¯èƒ½å¯¼è‡´æ•°æ®å½’å±é”™è¯¯
```

CI ä¼šå¼ºåˆ¶æ‰§è¡Œæ­¤æ£€æŸ¥ã€‚

---

### 2.6 è®¾è®¡æ¶æ„ï¼š

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ä¸šåŠ¡ä»£ç  (deposit.rs, withdraw.rs, order.rs...)                 â”‚
â”‚  âœ… asset.parse_amount(decimal)                                  â”‚
â”‚  âœ… asset.parse_amount_allow_zero(decimal)                       â”‚
â”‚  âœ… asset.format_amount(scaled_amount)                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  æ„å›¾å°è£…å±‚ (Asset / AssetInfo)                                  â”‚
â”‚  å°è£… decimals å‚æ•°ï¼Œæä¾›"ç±»å‹ â†’ ç±»å‹"çš„ç®€æ´ API                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  æ ¸å¿ƒè½¬æ¢å±‚ (money.rs)                                           â”‚
â”‚  parse_decimal() / parse_decimal_allow_zero() / format_amount() â”‚
â”‚  âš ï¸ pub(crate) - ä»…ä¾›æ„å›¾å°è£…å±‚è°ƒç”¨                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**å…³é”®æ”¶ç›Š**ï¼š

| æ”¶ç›Š | è¯´æ˜ |
|------|------|
| **ç®€æ´æ€§** | `asset.parse_amount(d)` vs `money::parse_decimal(d, asset.decimals as u32)` |
| **å°è£…æ€§** | è°ƒç”¨è€…ä¸éœ€è¦çŸ¥é“ `decimals`ã€`display_decimals` ç­‰å†…éƒ¨å‚æ•° |
| **ä¸€è‡´æ€§** | æ‰€æœ‰ä¸šåŠ¡ä»£ç ä½¿ç”¨ç›¸åŒçš„ API æ¨¡å¼ |
| **å¯å®¡è®¡æ€§** | ç›´æ¥ `money::` è°ƒç”¨æ˜¯éœ€è¦å®¡æŸ¥çš„çº¢æ—— |

---

### 2.5 ç²¾åº¦æœ¯è¯­è§„èŒƒï¼šåŒºåˆ†å†…éƒ¨ç¼©æ”¾ä¸ API ç²¾åº¦ (Precision Terminology)

> [!IMPORTANT]
> **è¿™æ˜¯ä¸€ä¸ªå…³é”®è®¾è®¡çŸ«æ­£**ï¼šåŸæœ‰çš„ `decimals` å’Œ `display_decimals` å‘½åå¯¼è‡´äº† Dev/QA å›¢é˜Ÿçš„æ··æ·†ã€‚

**é—®é¢˜èƒŒæ™¯**ï¼š

| æ—§æœ¯è¯­ | è¯­ä¹‰æ··æ·† | è¯¯ç”¨åœºæ™¯ |
|--------|----------|----------|
| `decimals` | "ç²¾åº¦" - å®¹æ˜“è¢«å½“ä½œ API éªŒè¯ç²¾åº¦ | å¼€å‘è€…ç”¨ `decimals` éªŒè¯ API è¾“å…¥ |
| `display_decimals` | "æ˜¾ç¤ºç²¾åº¦" - æš—ç¤ºä»…ç”¨äºè¾“å‡º | å®é™…ä¸Šä¹Ÿåº”ç”¨äºè¾“å…¥éªŒè¯ |

**è®¾è®¡çŸ«æ­£**ï¼šå¼•å…¥æ˜ç¡®çš„æœ¯è¯­åˆ†ç¦»

| å±‚çº§ | æ—§æœ¯è¯­ | æ–° Intent API | è¯­ä¹‰ |
|------|--------|---------------|------|
| **Asset** | `decimals` | `internal_scale()` | å†…éƒ¨å­˜å‚¨ç¼©æ”¾å› å­ï¼ˆå¦‚ BTC: 10^8ï¼‰ |
| **Asset** | `display_decimals` | `asset_precision()` | API è¾¹ç•Œç²¾åº¦ï¼ˆè¾“å…¥éªŒè¯ + è¾“å‡ºæ ¼å¼åŒ–ï¼‰ |
| **Symbol** | `price_decimal` | `price_scale()` | å†…éƒ¨ä»·æ ¼ç¼©æ”¾å› å­ |
| **Symbol** | `price_display_decimal` | `price_precision()` | API è¾¹ç•Œä»·æ ¼ç²¾åº¦ |

**ä»£ç è§„èŒƒ**ï¼š

```rust
// âœ… æ­£ç¡®ï¼šä½¿ç”¨ Intent API
if qty_decimal.scale() > base_asset.asset_precision() {
    return Err("Too many decimal places in quantity");
}
let formatted = money::format_amount(value, asset.internal_scale(), asset.asset_precision());

// âŒ é”™è¯¯ï¼šç›´æ¥è®¿é—®å­—æ®µ
if qty_decimal.scale() > base_asset.decimals {  // åº”è¯¥ç”¨ asset_precision()!
    return Err("Too many decimal places in quantity");
}
```

**å®ç°ç»†èŠ‚**ï¼š

```rust
impl AssetInfo {
    /// API è¾¹ç•Œç²¾åº¦ï¼ˆè¾“å…¥éªŒè¯ + è¾“å‡ºæ ¼å¼åŒ–ï¼‰
    pub fn asset_precision(&self) -> u32 {
        self.display_decimals  // å†…éƒ¨ä»ç”¨æ—§å­—æ®µï¼Œä½† API éšè—ç»†èŠ‚
    }
    
    /// å†…éƒ¨ç¼©æ”¾å› å­ï¼ˆä»…é™ money.rsï¼‰
    pub fn internal_scale(&self) -> u32 {
        self.decimals
    }
}

impl SymbolInfo {
    /// ä»·æ ¼ API ç²¾åº¦
    pub fn price_precision(&self) -> u32 {
        self.price_display_decimal
    }
    
    /// ä»·æ ¼å†…éƒ¨ç¼©æ”¾
    pub fn price_scale(&self) -> u32 {
        self.price_decimal
    }
}
```

**æ ¸å¿ƒåŸåˆ™**ï¼š

| åœºæ™¯ | åº”ä½¿ç”¨ | è¯´æ˜ |
|------|--------|------|
| éªŒè¯ API è¾“å…¥ç²¾åº¦ | `asset_precision()` / `price_precision()` | å®¢æˆ·ç«¯å…è®¸çš„æœ€å¤§ç²¾åº¦ |
| æ ¼å¼åŒ– API è¾“å‡º | `asset_precision()` / `price_precision()` | è¿”å›ç»™å®¢æˆ·ç«¯çš„ç²¾åº¦ |
| å†…éƒ¨ Decimalâ†”u64 è½¬æ¢ | `internal_scale()` / `price_scale()` | ä»…é™ money.rs ä½¿ç”¨ |

> [!TIP]
> **å‘åå…¼å®¹**ï¼šæ—§å­—æ®µ `decimals`ã€`display_decimals` ä¿ç•™ä½†æ ‡æ³¨ `DEPRECATED`ï¼Œé€æ­¥è¿ç§»åç§»é™¤ã€‚

---

## Part III: å†…å¤–è¾¹ç•Œä¸æ˜¾ç¤ºç­–ç•¥ (Internal/External Boundary & Display)

### 3.0 æ ¸å¿ƒè§„èŒƒï¼šå†…éƒ¨å®ç°ç»ä¸æš´éœ²

> [!CAUTION]
> **å†…éƒ¨çš„ `u64` è¡¨ç¤ºæ˜¯å®ç°ç»†èŠ‚ï¼Œç»å¯¹ä¸èƒ½æš´éœ²ç»™å®¢æˆ·ç«¯ã€‚**

**å¼ºåˆ¶è§„èŒƒ**ï¼š
1.  **ç»Ÿä¸€è½¬æ¢å±‚**ï¼šå†…éƒ¨ç³»ç»Ÿä¸å¤–éƒ¨ Client ä¹‹é—´ï¼Œå¿…é¡»ç»è¿‡**ç»Ÿä¸€çš„è½¬æ¢å±‚**ã€‚
2.  **API å±‚ä½¿ç”¨ Decimal**ï¼šDTO ä¸­çš„é‡‘é¢å­—æ®µä½¿ç”¨ `StrictDecimal`ï¼ˆè‡ªå®šä¹‰ç±»å‹ï¼‰ï¼Œåˆ©ç”¨ `rust_decimal` çš„æ ¼å¼éªŒè¯èƒ½åŠ›ã€‚
3.  **åˆ†å±‚éªŒè¯**ï¼š
    - **Serde å±‚**ï¼šæ ¼å¼éªŒè¯ï¼ˆæ‹’ç» `.5`ã€éæ•°å­—ç­‰ï¼‰â†’ å¾—åˆ° `Decimal`
    - **SymbolManager å±‚**ï¼šç²¾åº¦/èŒƒå›´éªŒè¯ â†’ å¾—åˆ° `ScaledAmount`
4.  **ç²¾åº¦æ¥æºå”¯ä¸€**ï¼šèµ„äº§ç²¾åº¦ä» `SymbolManager` è·å–ï¼Œä¸¥ç¦ç¡¬ç¼–ç ã€‚

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   Client    â”‚ â”€â”€â†’ â”‚  Serde å±‚    â”‚ â”€â”€â†’ â”‚SymbolManager â”‚ â”€â”€â†’ â”‚  Internal   â”‚
â”‚  (String)   â”‚     â”‚ (Decimal)    â”‚     â”‚ (éªŒè¯ç²¾åº¦)   â”‚     â”‚   (u64)     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
     "1.5"       æ ¼å¼éªŒè¯     Decimal(1.5)   ç²¾åº¦éªŒè¯    ScaledAmount(150_000_000)
```

**è®¾è®¡ä¼˜åŠ¿**ï¼š
- **åˆ©ç”¨åº“èƒ½åŠ›**ï¼š`rust_decimal` æä¾›æˆç†Ÿçš„æ•°å­—è§£æ
- **æ—©æœŸå¤±è´¥**ï¼šæ ¼å¼é”™è¯¯åœ¨ååºåˆ—åŒ–é˜¶æ®µå°±æ‹¦æˆª
- **å…³æ³¨ç‚¹åˆ†ç¦»**ï¼šæ ¼å¼éªŒè¯ vs ç²¾åº¦éªŒè¯ åˆ†å¼€å¤„ç†
- **ä¸šåŠ¡ä»£ç ç®€åŒ–**ï¼šHandler æ‹¿åˆ°çš„ `Decimal` å·²æ˜¯åˆæ³•æ•°å­—ï¼Œåªéœ€éªŒè¯èŒƒå›´

---

### 3.1 æˆªæ–­æ˜¯å”¯ä¸€åˆæ³•çš„èˆå…¥ç­–ç•¥

**å†³ç­–**ï¼šæ‰€æœ‰è½¬æ¢ã€è®¡ç®—è¿‡ç¨‹ä¸­çš„ç²¾åº¦æŸå¤±ï¼Œ**ä¸€å¾‹ä½¿ç”¨æˆªæ–­ï¼ˆTruncationï¼‰**ï¼Œä¸å…è®¸å››èˆäº”å…¥ã€‚

**åŸå› **ï¼š
- **ä¸€è‡´æ€§**ï¼šä¸æ•´æ•°é™¤æ³•çš„è¡Œä¸ºä¸€è‡´ï¼ˆå‘é›¶æˆªæ–­ï¼‰ã€‚
- **å¯é¢„æµ‹æ€§**ï¼šä»»ä½•äººåœ¨ä»»ä½•å¹³å°é‡ç®—ï¼Œç»“æœå®Œå…¨ä¸€è‡´ã€‚
- **å®‰å…¨æ€§**ï¼šå®æ„¿å°‘æ˜¾ç¤ºï¼Œä¹Ÿä¸èƒ½è®©ç”¨æˆ·è®¤ä¸ºè‡ªå·±æ‹¥æœ‰å®é™…ä¸å­˜åœ¨çš„ä½™é¢ã€‚

| åœºæ™¯ | ç­–ç•¥ | ç¤ºä¾‹ |
|------|------|------|
| å…¥é‡‘è½¬æ¢ | æˆªæ–­ | é“¾ä¸Š `1.23456789012345678 ETH` â†’ ç³»ç»Ÿ `1.23456789 ETH` |
| ä½™é¢æ˜¾ç¤º | æˆªæ–­ | å†…éƒ¨ `123456789` â†’ æ˜¾ç¤º `"1.2345"` (4ä½æ˜¾ç¤ºç²¾åº¦) |
| æˆäº¤è®¡ç®— | æˆªæ–­ | é¿å…å‡­ç©ºäº§ç”Ÿèµ„é‡‘ |

---

### 3.2 ä¸¥æ ¼è§£æï¼šæ‹’ç»æ¨¡ç³Šè¾“å…¥

**å†³ç­–**: æ‹’ç» `.5` å’Œ `5.` ç­‰ç®€å†™ï¼Œå¼ºåˆ¶è¦æ±‚ `0.5` å’Œ `5.0`ã€‚

**åŸå› **ï¼šå¤„ç†é‡‘é¢æ•°æ®ï¼Œ**ä¸¥è°¨å’Œå®‰å…¨æ˜¯ç¬¬ä¸€ä½çš„**ã€‚æ¨¡ç³Šçš„è¾“å…¥æ ¼å¼å¯èƒ½å¯¼è‡´ï¼š
- æ‰‹æŠ–æˆ–è„šæœ¬é”™è¯¯è¾“å…¥ä¸å®Œæ•´æ•°å­—
- ä¸åŒè§£æå™¨å¯¹æ­§ä¹‰æ ¼å¼æœ‰ä¸åŒè§£è¯»
- éšè”½çš„ç²¾åº¦ä¸¢å¤±

**è¡ŒåŠ¨é¡¹**:
- [ ] åœ¨ OpenAPI æ–‡æ¡£å’Œé”™è¯¯ä¿¡æ¯ä¸­æ˜ç¡®æç¤ºæ­¤è§„èŒƒ

---

### 3.3 é›¶å€¼å¤„ç†ï¼šé»˜è®¤ä¸¥æ ¼ + æ˜¾å¼å…¥å£

**é—®é¢˜**ï¼šé›¶å€¼åœ¨æŸäº›åœºæ™¯æ˜¯éæ³•çš„ï¼ˆè®¢å•æ•°é‡ï¼‰ï¼Œåœ¨å¦ä¸€äº›åœºæ™¯æ˜¯åˆæ³•çš„ï¼ˆæ‰‹ç»­è´¹ï¼‰ã€‚

**åæ¨¡å¼**ï¼šåˆ°å¤„å†™ workaround
```rust
// âŒ æ•£è½å„å¤„ï¼Œç»´æŠ¤å™©æ¢¦
let fee = if fee_str == "0" {
    ScaledAmount::ZERO
} else {
    parse_amount(&fee_str, decimals)?
};
```

**æ¨èæ¨¡å¼**ï¼šæ˜¾å¼å…¥å£

```rust
// ===== é»˜è®¤å…¥å£ï¼šä¸¥æ ¼ï¼Œæ‹’ç»é›¶ =====
/// ç”¨äºè®¢å•æ•°é‡ã€ä»·æ ¼ç­‰å¿…é¡»éé›¶çš„åœºæ™¯
pub fn parse_amount(s: &str, decimals: u32) -> Result<ScaledAmount>

// ===== æ˜¾å¼å…¥å£ï¼šå…è®¸é›¶ =====
/// ç”¨äºæ‰‹ç»­è´¹ç­‰å¯èƒ½ä¸ºé›¶çš„åœºæ™¯
/// è°ƒç”¨è€…åº”è¯¥çŸ¥é“è‡ªå·±åœ¨åšä»€ä¹ˆ
pub fn parse_amount_allow_zero(s: &str, decimals: u32) -> Result<ScaledAmount>
```

**ä½¿ç”¨ç¤ºä¾‹**ï¼š
```rust
// è®¢å•æ•°é‡ï¼šå¿…é¡»éé›¶ï¼ˆä½¿ç”¨é»˜è®¤ä¸¥æ ¼ç‰ˆæœ¬ï¼‰
let qty = symbol_mgr.parse_qty(symbol, &req.quantity)?;

// æç°æ‰‹ç»­è´¹ï¼šå¯ä»¥ä¸ºé›¶ï¼ˆæ˜¾å¼è¡¨è¾¾æ„å›¾ï¼‰
let fee = symbol_mgr.parse_fee_allow_zero(symbol, &req.fee)?;
```

**è®¾è®¡åŸåˆ™**ï¼š

| åŸåˆ™ | è¯´æ˜ |
|------|------|
| **å‘çš„æˆåŠŸ (Pit of Success)** | é»˜è®¤è¡Œä¸ºæ˜¯å®‰å…¨çš„ï¼Œéœ€è¦ç»•è¿‡æ—¶å¿…é¡»æ˜¾å¼å£°æ˜ |
| **æ„å›¾å¯è§** | ä»£ç ä¸­çœ‹åˆ° `_allow_zero` å°±çŸ¥é“è¿™é‡Œå…è®¸é›¶ |
| **Code Review ä¿¡å·** | `_allow_zero` è°ƒç”¨æ˜¯éœ€è¦å®¡æŸ¥çš„ä¿¡å· |
| **è§£æå±‚ä¸åšä¸šåŠ¡åˆ¤æ–­** | æ˜¯å¦å…è®¸é›¶ç”±è°ƒç”¨æ–¹é€šè¿‡é€‰æ‹©å…¥å£å†³å®š |

---

## Part IV: å¦‚ä½•åœ¨ä»£ç å±‚é¢å¼ºåˆ¶æ‰§è¡Œï¼Ÿ

> **æ ¸å¿ƒé—®é¢˜**ï¼šå¦‚ä½•ç¦æ­¢å¼€å‘è€…åˆ°å¤„ç§è‡ªè½¬æ¢ï¼Ÿ

### 4.1 ç¬¬ä¸€é“é˜²çº¿ï¼šç±»å‹ç³»ç»Ÿ (ç¼–è¯‘æœŸ)

**Newtype å°è£…**ï¼š`ScaledAmount(u64)` çš„å†…éƒ¨å­—æ®µæ˜¯ **private** çš„ã€‚

```rust
pub struct ScaledAmount(u64);  // u64 ä¸å¯ç›´æ¥è®¿é—®

impl ScaledAmount {
    pub(crate) fn from_raw(v: u64) -> Self { Self(v) }  // ä»… crate å†…éƒ¨å¯æ„é€ 
    pub fn to_raw(self) -> u64 { self.0 }                // æ˜¾å¼"é€ƒé€¸"
}
```

**æ•ˆæœ**ï¼š
- âŒ `ScaledAmount::from_raw(100)` â€” å¤–éƒ¨æ¨¡å—æ— æ³•è°ƒç”¨
- âŒ `amount.0` â€” æ— æ³•ç›´æ¥è®¿é—®å†…éƒ¨å­—æ®µ
- âŒ `amount + 100u64` â€” ç±»å‹ä¸åŒ¹é…ï¼Œç¼–è¯‘å¤±è´¥
- âœ… `*amount > 0` â€” é€šè¿‡ `Deref` å…è®¸æ¯”è¾ƒ

---

### 4.2 ç¬¬äºŒé“é˜²çº¿ï¼šå¯è§æ€§æ§åˆ¶ (API å…¥å£æ”¶ç¼©)

**å±‚çº§éš”ç¦»**ï¼š

| å‡½æ•° | å¯è§æ€§ | è°å¯ä»¥è°ƒç”¨ |
|------|--------|------------|
| `parse_amount()` | `pub(crate)` | ä»… `money.rs` å’Œæ ¸å¿ƒæ¨¡å— |
| `format_amount()` | `pub(crate)` | ä»… `money.rs` å’Œæ ¸å¿ƒæ¨¡å— |
| `SymbolManager::parse_qty()` | `pub` | **ä»»ä½•æ¨¡å—ï¼ˆå”¯ä¸€åˆæ³•å…¥å£ï¼‰** |
| `SymbolManager::format_price()` | `pub` | **ä»»ä½•æ¨¡å—ï¼ˆå”¯ä¸€åˆæ³•å…¥å£ï¼‰** |

**æ•ˆæœ**ï¼š
- Gateway Handler çš„ä»£ç è‡ªåŠ¨è¡¥å…¨ä¸­ï¼Œ**åªèƒ½çœ‹åˆ°** `SymbolManager` çš„æ–¹æ³•ã€‚
- å¦‚æœå¼€å‘è€…æƒ³è°ƒç”¨åº•å±‚ `parse_amount()`ï¼Œä¼šå‘ç°å®ƒ**ä¸åœ¨ä½œç”¨åŸŸå†…**ã€‚

---

### 4.3 ç¬¬ä¸‰é“é˜²çº¿ï¼šAPI å±‚æ•°æ®ç±»å‹ (DTO è®¾è®¡)

**å¼ºåˆ¶è§„èŒƒ**ï¼šAPI è¯·æ±‚/å“åº”ä¸­çš„é‡‘é¢å­—æ®µï¼Œ**å¿…é¡»ä½¿ç”¨ `String` ç±»å‹**ã€‚

```rust
// âœ… æ­£ç¡®: ä½¿ç”¨ Stringï¼Œç”± Handler è°ƒç”¨ SymbolManager è½¬æ¢
#[derive(Deserialize)]
pub struct PlaceOrderRequest {
    pub quantity: String,  // "1.5"
    pub price: String,     // "50000.00"
}

// âŒ é”™è¯¯: ç›´æ¥ä½¿ç”¨ u64ï¼Œæš´éœ²å†…éƒ¨å®ç°
#[derive(Deserialize)]
pub struct PlaceOrderRequest {
    pub quantity: u64,     // å®¢æˆ·ç«¯å¦‚ä½•çŸ¥é“è¦ä¼  150_000_000ï¼Ÿ
}
```

**Serde ä¸ä¼šè‡ªåŠ¨è½¬æ¢**ï¼šå¦‚æœå®¢æˆ·ç«¯ä¼  `"quantity": 1.5`ï¼ˆJSON numberï¼‰ï¼Œ`String` ç±»å‹ä¼šååºåˆ—åŒ–å¤±è´¥ï¼Œå¼ºåˆ¶å®¢æˆ·ç«¯ä¼  `"1.5"`ï¼ˆJSON stringï¼‰ã€‚

---

### 4.4 ç¬¬å››é“é˜²çº¿ï¼šCI è‡ªåŠ¨åŒ–å®¡è®¡

**å®¡è®¡è„šæœ¬**: `scripts/audit_money_safety.sh`

```bash
#!/bin/bash
set -e

echo "ğŸ” Auditing money safety..."

# 1. æ£€æŸ¥é money.rs ä¸­çš„æ‰‹åŠ¨ç¼©æ”¾
if grep -rn "10u64.pow" --include="*.rs" src/ | grep -v "money.rs"; then
    echo "âŒ FAIL: Found 10u64.pow outside money.rs"
    exit 1
fi

# 2. æ£€æŸ¥ Decimal æ‰‹åŠ¨å¹‚è¿ç®—
if grep -rn "Decimal::from(10).powi" --include="*.rs" src/ | grep -v "money.rs"; then
    echo "âŒ FAIL: Found Decimal power operation outside money.rs"
    exit 1
fi

# 3. æ£€æŸ¥ç¡¬ç¼–ç ç²¾åº¦ (å¯é€‰ï¼Œéœ€è¦æ›´ç²¾ç»†çš„è§„åˆ™)
# grep -rn "decimals.*=.*8" --include="*.rs" src/ | grep -v "symbol_manager.rs"

echo "âœ… Money safety audit passed!"
```

**é›†æˆ**ï¼š
- `.github/workflows/ci.yml` â€” æ¯æ¬¡ PR è‡ªåŠ¨è¿è¡Œ
- `.git/hooks/pre-commit` â€” æœ¬åœ°æäº¤å‰æ‹¦æˆª

---

### 4.5 ç¬¬äº”é“é˜²çº¿ï¼šCode Review ä¿¡å·

**é«˜å±æ“ä½œæ¸…å•** (PR å®¡æŸ¥æ—¶é‡ç‚¹å…³æ³¨)ï¼š

| ä»£ç æ¨¡å¼ | é£é™©ç­‰çº§ | å¤„ç†æ–¹å¼ |
|----------|----------|----------|
| `.to_raw()` | âš ï¸ é«˜ | å¿…é¡»æ³¨é‡Šè¯´æ˜åŸå›  |
| `10u64.pow` åœ¨ `money.rs` å¤– | ğŸš« ç¦æ­¢ | æ‹’ç»åˆå¹¶ |
| `decimals: u32` ç¡¬ç¼–ç  | âš ï¸ é«˜ | åº”ä» `SymbolManager` è·å– |
| API DTO ä¸­ `u64` é‡‘é¢å­—æ®µ | ğŸš« ç¦æ­¢ | å¿…é¡»ä½¿ç”¨ `String` |
| `Deref` åç›´æ¥ç®—æœ¯ (`*a + *b`) | âš ï¸ é«˜ | åº”ä½¿ç”¨ `checked_add` |
| **`.unwrap_or(100_000_000)` æˆ–ç±»ä¼¼ç¡¬ç¼–ç é»˜è®¤å€¼** | ğŸš« **ç¦æ­¢** | å¿…é¡» fail-fast |

---

### 4.5.1 ğŸš« ç¦æ­¢é™é»˜é»˜è®¤å€¼ vs ğŸš« ç¦æ­¢è¿è¡Œæ—¶ Panic

> [!IMPORTANT]
> **"å®å¯æŠ¥é”™ï¼Œä¸å¯éšç’" ä¸ç­‰åŒäº "åŠ¨è¾„å´©æºƒ"**ã€‚

**é”™è¯¯ç¤ºä¾‹ (è¿‡æ¿€çš„ Fail-Fast)**:
```rust
// âŒ é”™è¯¯ï¼šåœ¨æç°å¤„ç†ä¸­å› æ•°æ®åº“åŒæ­¥å»¶è¿Ÿå¯¼è‡´å…¨ç«™ Panic æŒ‚èµ·
let balance = row.try_get_log("balance").expect("DB error"); 
```

**æ¨èæ¨¡å¼ (å¥å£®çš„ Fail-Fast)**:
```rust
// âœ… æ­£ç¡®ï¼šè®°å½• Error å¹¶å‘ç”¨æˆ·è¿”å› 500ï¼Œä¿éšœç³»ç»Ÿå…¶ä»–åŠŸèƒ½æ­£å¸¸
let balance = row.try_get_log("balance")
    .ok_or_else(|| InternalError::DatabaseDrift("balance column missing"))?;
```

**æ€»ç»“åŸåˆ™**ï¼š
1. **é™æ€é…ç½®** (å¯åŠ¨è½½å…¥) -> `expect` / `panic`
2. **åŠ¨æ€æ•°æ®** (ä¸šåŠ¡å¤„ç†) -> `Result` / `Error`
3. **å®¡è®¡è„šæœ¬** -> æŒç»­å‘ç° `unwrap_or(0)` çš„é£é™©

---

### 4.6 ç¬¬å…­é“é˜²çº¿ï¼šAgent è®°å¿† (AGENTS.md)

**å·²ç”Ÿæ•ˆ**: `AGENTS.md` å¿…è¯»åˆ—è¡¨ä¸­åŒ…å«æœ¬è§„èŒƒã€‚æ‰€æœ‰ AI Agent åœ¨å¼€å§‹å·¥ä½œå‰å¿…é¡»é˜…è¯»ï¼Œç¡®ä¿ç”Ÿæˆçš„ä»£ç ç¬¦åˆè§„èŒƒã€‚

---

## Part V: æœªæ¥å‡çº§è·¯å¾„ (Future Upgrade Path)

| é˜¶æ®µ | ç›®æ ‡ | çŠ¶æ€ |
|------|------|------|
| **Phase 0** | Newtype å®šä¹‰, API æ”¶ç¼©, æ–‡æ¡£æ²»ç† | âœ… å·²å®Œæˆ |
| **Phase 1** | `audit_money_safety.sh` é›†æˆ CI | â³ å¾…å®ç° |
| **Phase 1.5** | [API Money Enforcement](./api-money-enforcement.md)ï¼šExtractor + IntoResponse å¼ºåˆ¶è½¬æ¢ | â³ å¾…å®ç° |
| **Phase 2** | å­˜é‡ä»£ç å…¨é¢æ‰«æä¸è¿ç§» | â³ å¾…æ‰§è¡Œ |
| **Phase 2.5** | Legacy ä»£ç è¿ç§»è‡³æ„å›¾å°è£… APIï¼ˆè§ä¸‹æ–¹è¯¦æƒ…ï¼‰ | â³ å¾…æ‰§è¡Œ |

---

### Phase 2.5 è¯¦æƒ…ï¼šLegacy ä»£ç è¿ç§»

**ç›®æ ‡**ï¼šå°†æ‰€æœ‰ç›´æ¥è°ƒç”¨ `money::` å‡½æ•°çš„ä»£ç è¿ç§»åˆ° `Asset` / `AssetInfo` æ„å›¾å°è£… APIã€‚

**è¿ç§»å†…å®¹**ï¼š

| æ—§ä»£ç  | æ–°ä»£ç  |
|--------|--------|
| `money::parse_decimal(d, asset.decimals as u32)` | `asset.parse_amount(d)` |
| `money::parse_decimal_allow_zero(d, asset.decimals as u32)` | `asset.parse_amount_allow_zero(d)` |
| `money::format_amount(amt, decimals, display)` | `asset.format_amount(amt)` |

**å·²å®Œæˆ**ï¼š
- [x] `src/funding/deposit.rs`
- [x] `src/funding/withdraw.rs`

**å¾…è¿ç§»**ï¼ˆæ‰«ææ•´ä¸ªä»£ç åº“ä¸­çš„ `money::parse` å’Œ `money::format` è°ƒç”¨ï¼‰ï¼š
- [ ] å…¶ä»–ä¸šåŠ¡æ¨¡å—å…¨é¢æ‰«æ
- [ ] æ·»åŠ  CI æ£€æŸ¥ç¦æ­¢ä¸šåŠ¡ä»£ç ç›´æ¥è°ƒç”¨ `money::` å‡½æ•°

---

## æ€»ç»“ï¼šä¸ºä»€ä¹ˆå¦‚æ­¤ä¸¥è‹› (Why So Heavy?)

### æ ¸å¿ƒåŸåˆ™ 1ï¼šè´¦æœ¬å¿…é¡» 100% å¯å¯¹è´¦

> å¦‚æœå…è®¸ä»»ä½•ç²¾åº¦è¯¯å·®çš„å­˜åœ¨ï¼Œç³»ç»Ÿçš„è´¦æœ¬å°±æ— æ³•åšåˆ° **100% å¯¹é½**ã€‚
> æˆ‘ä»¬æ— æ³•åˆ©ç”¨"**èµ„é‡‘æ’ç­‰å®šç†**"ï¼ˆæ€»å…¥é‡‘ = æ€»ä½™é¢ + æ€»å‡ºé‡‘ï¼‰æ¥è¿›è¡Œç²¾ç¡®å¯¹è´¦ã€‚
> ä¸€æ—¦è´¦æœ¬ä¸èƒ½ 100% å¯¹é½ï¼Œæˆ‘ä»¬å°±**æ— æ³•åˆ†è¾¨**ä¸€ä¸ªå·®å¼‚æ˜¯"å¯æ¥å—çš„æ­£å¸¸è¯¯å·®"è¿˜æ˜¯ä¸€ä¸ª**éšè—çš„ Bug**ã€‚
> çœŸæ­£çš„é—®é¢˜å¯èƒ½è¢«"è¯¯å·®"æ©ç›–ï¼Œç›´åˆ°é€ æˆæ— æ³•æŒ½å›çš„æŸå¤±ã€‚

### æ ¸å¿ƒåŸåˆ™ 2ï¼šè½¬æ¢é€»è¾‘å¿…é¡»æ”¶æ•›åˆ°å”¯ä¸€ä½ç½®

> é‡‘é¢è½¬æ¢é€»è¾‘éå¸¸å¤æ‚ï¼ˆç²¾åº¦ã€èˆå…¥ã€æº¢å‡ºæ£€æŸ¥ï¼‰ã€‚
> å¦‚æœå…è®¸åœ¨ä»£ç åº“å„å¤„é‡å¤ç¼–å†™ï¼Œ**æ¯ä¸ªåœ°æ–¹éƒ½å¯èƒ½çŠ¯ä¸åŒçš„é”™è¯¯**ã€‚
> å°†è½¬æ¢æ”¶æ•›åˆ°**å”¯ä¸€çš„ã€ç»è¿‡å……åˆ†å®¡è®¡å’Œæµ‹è¯•çš„ä»£ç ä½ç½®** (`money.rs` + `SymbolManager`)ï¼Œæˆ‘ä»¬å¯ä»¥ï¼š
> - å¯¹è¿™ä¸€å¤„è¿›è¡Œ**ç©·å°½å¼æµ‹è¯•**ï¼ˆè¾¹ç•Œå€¼ã€æº¢å‡ºã€è´Ÿæ•°ç­‰ï¼‰ã€‚
> - ç¡®ä¿**æ‰€æœ‰è°ƒç”¨è€…**éƒ½äº«å—åŒç­‰çš„å®‰å…¨ä¿éšœã€‚
> - åœ¨å‘ç° Bug æ—¶ï¼Œ**åªéœ€ä¿®å¤ä¸€å¤„**ï¼Œå…¨å±€ç”Ÿæ•ˆã€‚

### ç®€å•æ€»ç»“ (The Rules)

- **NO** `10u64.pow()` outside `money.rs`.
- **NO** raw `u64` arithmetic for amounts.
- **NO** implicit scaling.
- **YES** `SymbolManager` for all intent-based conversions.

---

## é€ŸæŸ¥è¡¨ (Quick Reference)

| åœºæ™¯ | âœ… æ­£ç¡®åšæ³• | âŒ é”™è¯¯åšæ³• |
|------|------------|------------|
| API DTO å­—æ®µ | `quantity: StrictDecimal` | `quantity: u64` æˆ– `quantity: String` |
| Decimal â†’ ScaledAmount | `symbol_mgr.decimal_to_scaled(symbol, decimal)` | æ‰‹åŠ¨è®¡ç®— `decimal * 10^8` |
| ScaledAmount â†’ String | `symbol_mgr.format_price(symbol, amount)` | `format!("{}", amount)` |
| è·å–ç²¾åº¦ | `symbol_mgr.get_decimals(asset)` | `let decimals = 8;` |
| ç®—æœ¯è¿ç®— | `amount.checked_add(other)?` | `*amount + *other` |
| æ¯”è¾ƒè¿ç®— | `*amount > 0` | âœ… å…è®¸ (Deref) |

---

## Part VI: å®æ–½è®°å½•ä¸éªŒæ”¶ (Implementation Record & Verification)

> **Phase 0x14-c å®æ–½æ—¥æœŸ**: 2025-12-31
> **çŠ¶æ€**: âœ… å®Œæˆ

### 6.1 å®Œæˆå·¥ä½œæ€»ç»“

#### æ ¸å¿ƒè®¾æ–½ (Layer 1)

| æ–‡ä»¶ | å˜æ›´ |
|------|------|
| [`money.rs`](../src/money.rs) | æ–°å¢ `unit_amount(decimals: u32) -> ScaledAmount` ä½œä¸º**å”¯ä¸€çš„ scaling factor æ¥æº** |

```rust
/// Returns the unit amount (1.0) for a given decimal precision as ScaledAmount.
/// This is the **ONLY** source of scaling factor in the codebase.
/// 
/// # Examples
/// - `unit_amount(8)` returns `ScaledAmount(100_000_000)` for BTC
/// - `unit_amount(6)` returns `ScaledAmount(1_000_000)` for USDT
/// - `unit_amount(18)` returns `ScaledAmount(10^18)` for ETH
pub(crate) fn unit_amount(decimals: u32) -> ScaledAmount {
    ScaledAmount::from(10u64.pow(decimals))
}
```

#### é«˜å±‚å°è£…é‡æ„ (Layer 2)

| æ–‡ä»¶ | å˜æ›´ |
|------|------|
| [`symbol_manager.rs`](../src/symbol_manager.rs) | `SymbolInfo::qty_unit()` è¿”å›ç±»å‹ä» `u64` æ”¹ä¸º `ScaledAmount`ï¼Œå§”æ‰˜ç»™ `money::unit_amount()` |

#### ä¸šåŠ¡ä»£ç è¿ç§» (Layer 3)

| æ–‡ä»¶ | ä½ç½® | å˜æ›´ |
|------|------|------|
| [`csv_io.rs`](../src/csv_io.rs) | L148, L152, L248 | `10u64.pow(...)` â†’ `*money::unit_amount(...)` |
| [`websocket/service.rs`](../src/websocket/service.rs) | L273-274, L310-311 | åŒä¸Š |
| [`sentinel/eth.rs`](../src/sentinel/eth.rs) | L585, L613 | åŒä¸Š |
| [`persistence/queries.rs`](../src/persistence/queries.rs) | L485 | åŒä¸Š |
| [`pipeline_runner.rs`](../src/pipeline_runner.rs) | L79, L195, L205 | `qty_unit()` â†’ `*qty_unit()` |
| [`pipeline_mt.rs`](../src/pipeline_mt.rs) | L129 | åŒä¸Š |
| [`ubscore.rs`](../src/ubscore.rs) | L263, L283, L318 | åŒä¸Š |
| [`ubscore_wal/recovery.rs`](../src/ubscore_wal/recovery.rs) | L89 | åŒä¸Š |

#### CI å®¡è®¡è„šæœ¬

æ–°å¢ [`scripts/audit_money_safety.sh`](../scripts/audit_money_safety.sh):
- æ£€æµ‹ `10u64.pow` åœ¨ `money.rs` å¤–çš„è¿è§„ä½¿ç”¨
- å…è®¸ `#[cfg(test)]` æµ‹è¯•ä»£ç è±å…
- é€€å‡ºç  1 è¡¨ç¤ºæœ‰è¿è§„

---

### 6.2 æµ‹è¯•éªŒæ”¶æ–¹æ³•

#### æ–¹æ³• 1: è¿è¡Œå®¡è®¡è„šæœ¬ (æ¨è)

```bash
# ä»é¡¹ç›®æ ¹ç›®å½•è¿è¡Œ
./scripts/audit_money_safety.sh

# é¢„æœŸè¾“å‡º:
# ğŸ” Money Safety Audit
# =====================
# Rule 1: Checking 10u64.pow usage...
# âœ… All 10u64.pow usage is in allowed locations
# =====================
# âœ… Money Safety Audit PASSED
```

**éªŒæ”¶æ ‡å‡†**: è„šæœ¬é€€å‡ºç ä¸º `0`ï¼Œè¾“å‡º `âœ… Money Safety Audit PASSED`

#### æ–¹æ³• 2: æ‰‹åŠ¨ grep éªŒè¯

```bash
# æ£€æŸ¥ 10u64.pow æ˜¯å¦åªåœ¨ money.rs å’Œæµ‹è¯•ä»£ç ä¸­
grep -rn "10u64\.pow" --include="*.rs" src/ | grep -v "money.rs" | grep -v "test"

# é¢„æœŸè¾“å‡º: ç©º (æ— åŒ¹é…)
```

#### æ–¹æ³• 3: è¿è¡Œå•å…ƒæµ‹è¯•

```bash
# è¿è¡Œ unit_amount ç›¸å…³æµ‹è¯•
cargo test unit_amount

# è¿è¡Œå…¨é‡æµ‹è¯•
cargo test

# é¢„æœŸ: 380+ æµ‹è¯•é€šè¿‡ï¼Œ0 å¤±è´¥
```

#### æ–¹æ³• 4: ç¼–è¯‘éªŒè¯

```bash
cargo build

# é¢„æœŸ: ç¼–è¯‘æˆåŠŸï¼Œæ—  warning
```

---

### 6.3 å›å½’æµ‹è¯•æ¸…å•

| æµ‹è¯•é¡¹ | å‘½ä»¤ | é¢„æœŸç»“æœ |
|--------|------|----------|
| å®¡è®¡è„šæœ¬ | `./scripts/audit_money_safety.sh` | âœ… PASSED |
| å•å…ƒæµ‹è¯• | `cargo test --lib` | 371+ passed |
| é›†æˆæµ‹è¯• | `cargo test --test '*'` | 9+ passed |
| ç¼–è¯‘ | `cargo build` | æˆåŠŸ |
| Clippy | `cargo clippy -- -D warnings` | æ—  warning |

---

### 6.4 æœªæ¥ CI é›†æˆ (TODO)

å°†å®¡è®¡è„šæœ¬æ·»åŠ åˆ° `.github/workflows/ci.yml`:

```yaml
  money-safety-audit:
    name: Money Safety Audit
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Run Money Safety Audit
        run: ./scripts/audit_money_safety.sh
```

---

### 6.5 ç›¸å…³ Commit

```
bdcf1ec feat(money): enforce type-safe scaling via unit_amount()
```

**Branch**: `0x14-c-money-safety`
