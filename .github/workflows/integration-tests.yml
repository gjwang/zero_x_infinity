name: Integration Tests

on:
  push:
    branches: [ main, 'feature/*', '0x*' ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:
    inputs:
      run_full_tests:
        description: 'Run full 1.3M dataset tests'
        required: false
        default: 'false'

env:
  CARGO_TERM_COLOR: always
  RUST_BACKTRACE: 1

jobs:
  # Quick tests - runs on every push
  quick-tests:
    name: Quick Tests
    runs-on: ubuntu-latest
    
    services:
      tdengine:
        image: tdengine/tdengine:latest
        ports:
          - 6030:6030
          - 6041:6041
        options: >-
          --health-cmd "taos -s 'SELECT SERVER_VERSION();'"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

      postgres:
        image: postgres:16
        ports:
          - 5432:5432
        env:
          POSTGRES_DB: exchange_info_db
          POSTGRES_USER: trading
          POSTGRES_PASSWORD: trading123
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          components: rustfmt, clippy
      
      - name: Cache cargo
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/bin/
            ~/.cargo/registry/index/
            ~/.cargo/registry/cache/
            ~/.cargo/git/db/
            target/
          key: ${{ runner.os }}-cargo-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-cargo-
      
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'
      
      - name: Install Python dependencies
        run: |
          python -m pip install --upgrade pip
          pip install pandas taos-ws-py
          pip install psycopg2-binary
          pip install psycopg2-binary
      
      - name: Check formatting
        run: cargo fmt --all -- --check
      
      - name: Clippy
        run: cargo clippy -- -D warnings -A clippy::too_many_arguments -A clippy::collapsible_if -A clippy::unwrap_or_default -A clippy::doc_lazy_continuation -A clippy::manual_is_multiple_of -A clippy::implicit_saturating_sub -A clippy::redundant_pattern_matching
      
      - name: Build
        run: cargo build --release
      
      - name: Unit Tests
        run: cargo test
      
      - name: Initialize PostgreSQL Database
        run: python3 scripts/db/manage_db.py init || echo "DB init skipped"

      - name: Integration Tests (Quick Mode)
        run: ./scripts/test_ci.sh --quick
        env:
          CI: true
          SKIP_LARGE_DATASET: 1
      
      - name: Upload test reports
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: test-reports
          path: test-reports/
          retention-days: 7

  # Full tests - runs on main branch or manually triggered
  full-tests:
    name: Full Integration Tests
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main' || github.event.inputs.run_full_tests == 'true'
    
    services:
      tdengine:
        image: tdengine/tdengine:latest
        ports:
          - 6030:6030
          - 6041:6041
        options: >-
          --health-cmd "taos -s 'SELECT SERVER_VERSION();'"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

      postgres:
        image: postgres:16
        ports:
          - 5432:5432
        env:
          POSTGRES_DB: exchange_info_db
          POSTGRES_USER: trading
          POSTGRES_PASSWORD: trading123
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable
      
      - name: Cache cargo
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/bin/
            ~/.cargo/registry/index/
            ~/.cargo/registry/cache/
            ~/.cargo/git/db/
            target/
          key: ${{ runner.os }}-cargo-${{ hashFiles('**/Cargo.lock') }}

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'
      
      - name: Install Python dependencies
        run: |
          python -m pip install --upgrade pip
          pip install pandas taos-ws-py
          pip install psycopg2-binary
          pip install psycopg2-binary
      
      - name: Build
        run: cargo build --release
      
      - name: Full Integration Tests (including 1.3M dataset)
        run: ./scripts/test_ci.sh --full
        timeout-minutes: 90
        env:
          CI: true
      
      - name: Upload test reports
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: full-test-reports
          path: test-reports/
          retention-days: 30
      
      - name: Upload performance baseline
        uses: actions/upload-artifact@v4
        with:
          name: performance-baseline
          path: |
            output/t2_summary.txt
            output/t2_perf.txt
          retention-days: 90
