name: Integration Tests

on:
  push:
    branches: [ main, 'feature/*', '0x*' ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:
    inputs:
      run_full_tests:
        description: 'Run full 1.3M dataset tests'
        required: false
        default: 'false'

env:
  CARGO_TERM_COLOR: always
  RUST_BACKTRACE: 1
  CI: true

jobs:
  # Build Job: Compiles and uploads binary
  build:
    name: Build & Cache
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          components: rustfmt, clippy
      
      - name: Cache cargo
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/bin/
            ~/.cargo/registry/index/
            ~/.cargo/registry/cache/
            ~/.cargo/git/db/
            target/
          key: ${{ runner.os }}-cargo-${{ hashFiles('**/Cargo.lock') }}
      
      - name: Build Release
        run: cargo build --release
      
      - name: Upload Binary
        uses: actions/upload-artifact@v4
        with:
          name: gateway-binary
          path: target/release/zero_x_infinity
          retention-days: 1

  # Phase 1: Unit & Pipeline Logic Tests
  test-unit:
    name: Unit & Pipeline
    needs: build
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable
      
      # Restore cargo cache for unit tests (needs dependencies)
      - name: Restore cargo cache
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/bin/
            ~/.cargo/registry/index/
            ~/.cargo/registry/cache/
            ~/.cargo/git/db/
            target/
          key: ${{ runner.os }}-cargo-${{ hashFiles('**/Cargo.lock') }}
      
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'
      
      - name: Install Python dependencies
        run: |
          python -m pip install --upgrade pip
          pip install pandas taos-ws-py psycopg2-binary pynacl requests
      
      - name: Download Binary
        uses: actions/download-artifact@v4
        with:
          name: gateway-binary
          path: target/release
      
      - name: Set Binary Executable
        run: chmod +x target/release/zero_x_infinity
      
      - name: Run Unit Tests
        run: ./scripts/test_ci.sh --test-unit

  # Phase 4: Gateway E2E
  test-gateway:
    name: Gateway E2E
    needs: build
    runs-on: ubuntu-latest
    services:
      tdengine:
        image: tdengine/tdengine:latest
        ports:
          - 6030:6030
          - 6041:6041
      postgres:
        image: postgres:16
        ports:
          - 5432:5432
        env:
          POSTGRES_DB: exchange_info_db
          POSTGRES_USER: trading
          POSTGRES_PASSWORD: trading123
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'
      
      - name: Install Python dependencies
        run: pip install pandas taos-ws-py psycopg2-binary pynacl requests
      
      - name: Initialize DB
        run: python3 scripts/db/manage_db.py init || echo "DB init skipped"
      
      - name: Download Binary
        uses: actions/download-artifact@v4
        with:
          name: gateway-binary
          path: target/release
      
      - name: Set Binary Executable
        run: chmod +x target/release/zero_x_infinity

      - name: Run Gateway E2E
        run: ./scripts/test_ci.sh --test-gateway-e2e

  # Phase 4: K-Line E2E
  test-kline:
    name: K-Line E2E
    needs: build
    runs-on: ubuntu-latest
    services:
      tdengine:
        image: tdengine/tdengine:latest
        ports:
          - 6030:6030
          - 6041:6041
      postgres:
        image: postgres:16
        ports:
          - 5432:5432
        env:
          POSTGRES_DB: exchange_info_db
          POSTGRES_USER: trading
          POSTGRES_PASSWORD: trading123
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'
      
      - name: Install Python dependencies
        run: pip install pandas taos-ws-py psycopg2-binary pynacl requests
      
      - name: Download Binary
        uses: actions/download-artifact@v4
        with:
          name: gateway-binary
          path: target/release
      
      - name: Set Binary Executable
        run: chmod +x target/release/zero_x_infinity

      - name: Run K-Line E2E
        run: ./scripts/test_ci.sh --test-kline

  # Phase 4: Depth API
  test-depth:
    name: Depth API
    needs: build
    runs-on: ubuntu-latest
    services:
      tdengine:
        image: tdengine/tdengine:latest
        ports:
          - 6030:6030
          - 6041:6041
      postgres:
        image: postgres:16
        ports:
          - 5432:5432
        env:
          POSTGRES_DB: exchange_info_db
          POSTGRES_USER: trading
          POSTGRES_PASSWORD: trading123
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'
      
      - name: Install Python dependencies
        run: pip install pandas taos-ws-py psycopg2-binary pynacl requests
      
      - name: Download Binary
        uses: actions/download-artifact@v4
        with:
          name: gateway-binary
          path: target/release
      
      - name: Set Binary Executable
        run: chmod +x target/release/zero_x_infinity

      - name: Run Depth API
        run: ./scripts/test_ci.sh --test-depth

  # Phase 5: Account Integration
  test-account:
    name: Account Integration
    needs: build
    runs-on: ubuntu-latest
    services:
      postgres:
        image: postgres:16
        ports:
          - 5432:5432
        env:
          POSTGRES_DB: exchange_info_db
          POSTGRES_USER: trading
          POSTGRES_PASSWORD: trading123
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'
      
      - name: Install Python dependencies
        run: pip install pandas taos-ws-py psycopg2-binary pynacl requests
      
      - name: Initialize DB
        run: python3 scripts/db/manage_db.py init || echo "DB init skipped"

      - name: Download Binary
        uses: actions/download-artifact@v4
        with:
          name: gateway-binary
          path: target/release
      
      - name: Set Binary Executable
        run: chmod +x target/release/zero_x_infinity

      - name: Run Account Integration
        run: ./scripts/test_ci.sh --test-account
