name: Integration Tests

on:
  push:
    branches: [ main, 'feature/*', '0x*' ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:
    inputs:
      run_full_tests:
        description: 'Run full 1.3M dataset tests'
        required: false
        default: 'false'

env:
  CARGO_TERM_COLOR: always
  RUST_BACKTRACE: 1
  CI: true

jobs:
  # ============================================================================
  # Stage 1: Build
  # ============================================================================
  build:
    name: Build & Cache
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          components: rustfmt, clippy
      
      - name: Cache cargo
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/bin/
            ~/.cargo/registry/index/
            ~/.cargo/registry/cache/
            ~/.cargo/git/db/
            target/
          key: ${{ runner.os }}-cargo-${{ hashFiles('**/Cargo.lock') }}
      
      - name: Build Release
        run: cargo build --release
      
      - name: Upload Binary
        uses: actions/upload-artifact@v4
        with:
          name: gateway-binary
          path: target/release/zero_x_infinity
          retention-days: 1

  # ============================================================================
  # Stage 2: Prerequisite Checks (each is a separate job for clear failure)
  # ============================================================================
  
  check-postgres:
    name: "✓ PostgreSQL Schema"
    runs-on: ubuntu-latest
    services:
      postgres:
        image: postgres:16
        ports:
          - 5432:5432
        env:
          POSTGRES_DB: exchange_info_db
          POSTGRES_USER: trading
          POSTGRES_PASSWORD: trading123
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
    steps:
      - uses: actions/checkout@v4
      
      - name: Apply All Migrations
        run: |
          for f in migrations/*.sql; do
            echo "Applying $f..."
            PGPASSWORD=trading123 psql -h localhost -U trading -d exchange_info_db -f "$f"
          done
      
      - name: Seed Data
        run: PGPASSWORD=trading123 psql -h localhost -U trading -d exchange_info_db -f fixtures/seed_data.sql 2>&1 | grep -v 'does not exist' || true
      
      - name: Verify Tables Exist
        run: |
          PGPASSWORD=trading123 psql -h localhost -U trading -d exchange_info_db -c "\dt" | tee tables.txt
          grep -q "users_tb" tables.txt || (echo "❌ users_tb missing" && exit 1)
          grep -q "assets_tb" tables.txt || (echo "❌ assets_tb missing" && exit 1)
          grep -q "symbols_tb" tables.txt || (echo "❌ symbols_tb missing" && exit 1)
          grep -q "api_keys_tb" tables.txt || (echo "❌ api_keys_tb missing" && exit 1)
          grep -q "balances_tb" tables.txt || (echo "❌ balances_tb missing" && exit 1)
          echo "✅ All required tables exist"

  check-tdengine:
    name: "✓ TDengine Schema"
    runs-on: ubuntu-latest
    services:
      tdengine:
        image: tdengine/tdengine:latest
        ports:
          - 6030:6030
          - 6041:6041
    steps:
      - name: Wait for TDengine
        run: |
          for i in {1..30}; do
            curl -s http://localhost:6041/rest/login/root/taosdata && echo "✅ TDengine ready" && exit 0
            echo "Waiting for TDengine... ($i/30)"
            sleep 2
          done
          echo "❌ TDengine connection timeout"
          exit 1
      
      - name: Create Database with Correct Precision
        run: |
          # CRITICAL: Precision MUST be 'us' (microseconds)
          # Code uses SystemTime::now().as_micros(), wrong precision causes
          # "Timestamp data out of range" errors
          curl -s -u root:taosdata -d "CREATE DATABASE IF NOT EXISTS trading KEEP 365d DURATION 10d BUFFER 256 WAL_LEVEL 2 PRECISION 'us'" \
            http://localhost:6041/rest/sql
          echo "✅ Database 'trading' created with 'us' precision"
      
      - name: Create Super Tables
        run: |
          # Create all super tables that Gateway's init_schema would create
          # This ensures tables exist BEFORE any test runs
          
          curl -s -u root:taosdata -d "USE trading" http://localhost:6041/rest/sql
          
          # Orders table
          curl -s -u root:taosdata -d "CREATE STABLE IF NOT EXISTS orders (ts TIMESTAMP, order_id BIGINT UNSIGNED, user_id BIGINT UNSIGNED, side TINYINT UNSIGNED, order_type TINYINT UNSIGNED, price BIGINT UNSIGNED, qty BIGINT UNSIGNED, filled_qty BIGINT UNSIGNED, status TINYINT UNSIGNED, cid NCHAR(64)) TAGS (symbol_id INT UNSIGNED)" \
            http://localhost:6041/rest/sql
          
          # Trades table
          curl -s -u root:taosdata -d "CREATE STABLE IF NOT EXISTS trades (ts TIMESTAMP, trade_id BIGINT UNSIGNED, order_id BIGINT UNSIGNED, user_id BIGINT UNSIGNED, side TINYINT UNSIGNED, price BIGINT UNSIGNED, qty BIGINT UNSIGNED, fee BIGINT UNSIGNED, role TINYINT UNSIGNED) TAGS (symbol_id INT UNSIGNED)" \
            http://localhost:6041/rest/sql
          
          # Balances table
          curl -s -u root:taosdata -d "CREATE STABLE IF NOT EXISTS balances (ts TIMESTAMP, avail BIGINT UNSIGNED, frozen BIGINT UNSIGNED, lock_version BIGINT UNSIGNED, settle_version BIGINT UNSIGNED) TAGS (user_id BIGINT UNSIGNED, asset_id INT UNSIGNED)" \
            http://localhost:6041/rest/sql
          
          # K-Lines table
          curl -s -u root:taosdata -d "CREATE STABLE IF NOT EXISTS klines (ts TIMESTAMP, open BIGINT UNSIGNED, high BIGINT UNSIGNED, low BIGINT UNSIGNED, close BIGINT UNSIGNED, volume BIGINT UNSIGNED, quote_volume DOUBLE, trade_count INT UNSIGNED) TAGS (symbol_id INT UNSIGNED, intv NCHAR(8))" \
            http://localhost:6041/rest/sql
          
          # Order events table
          curl -s -u root:taosdata -d "CREATE STABLE IF NOT EXISTS order_events (ts TIMESTAMP, order_id BIGINT UNSIGNED, event_type TINYINT UNSIGNED, prev_status TINYINT UNSIGNED, new_status TINYINT UNSIGNED, filled_qty BIGINT UNSIGNED, remaining_qty BIGINT UNSIGNED) TAGS (symbol_id INT UNSIGNED)" \
            http://localhost:6041/rest/sql
          
          echo "✅ All super tables created"
      
      - name: Verify Schema
        run: |
          result=$(curl -s -u root:taosdata -d "SHOW trading.STABLES" http://localhost:6041/rest/sql)
          echo "Super tables: $result"
          echo "✅ TDengine schema verified"

  # ============================================================================
  # Stage 3: Unit Tests (no services needed)
  # ============================================================================
  test-unit:
    name: Unit & Pipeline
    needs: build
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable
      
      - name: Restore cargo cache
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/bin/
            ~/.cargo/registry/index/
            ~/.cargo/registry/cache/
            ~/.cargo/git/db/
            target/
          key: ${{ runner.os }}-cargo-${{ hashFiles('**/Cargo.lock') }}
      
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'
      
      - name: Install Python dependencies
        run: pip install pandas taos-ws-py psycopg2-binary pynacl requests
      
      - name: Download Binary
        uses: actions/download-artifact@v4
        with:
          name: gateway-binary
          path: target/release
      
      - name: Set Binary Executable
        run: chmod +x target/release/zero_x_infinity
      
      - name: Run Unit Tests
        run: ./scripts/test_ci.sh --test-unit

  # ============================================================================
  # Stage 4: Integration Tests (depends on build + prereq checks)
  # ============================================================================
  
  test-gateway:
    name: Gateway E2E
    needs: [build, check-postgres, check-tdengine]
    runs-on: ubuntu-latest
    services:
      tdengine:
        image: tdengine/tdengine:latest
        ports:
          - 6030:6030
          - 6041:6041
      postgres:
        image: postgres:16
        ports:
          - 5432:5432
        env:
          POSTGRES_DB: exchange_info_db
          POSTGRES_USER: trading
          POSTGRES_PASSWORD: trading123
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'
      
      - name: Install Python dependencies
        run: pip install pandas taos-ws-py psycopg2-binary pynacl requests
      
      - name: Initialize DB
        run: |
          for f in migrations/*.sql; do
            echo "Applying $f..."
            PGPASSWORD=trading123 psql -h localhost -U trading -d exchange_info_db -f "$f"
          done
          PGPASSWORD=trading123 psql -h localhost -U trading -d exchange_info_db -f fixtures/seed_data.sql 2>&1 | grep -v 'does not exist' || true
      
      - name: Download Binary
        uses: actions/download-artifact@v4
        with:
          name: gateway-binary
          path: target/release
      
      - name: Set Binary Executable
        run: chmod +x target/release/zero_x_infinity

      - name: Run Gateway E2E
        run: ./scripts/test_ci.sh --test-gateway-e2e

  test-kline:
    name: K-Line E2E
    needs: [build, check-postgres, check-tdengine]
    runs-on: ubuntu-latest
    services:
      tdengine:
        image: tdengine/tdengine:latest
        ports:
          - 6030:6030
          - 6041:6041
      postgres:
        image: postgres:16
        ports:
          - 5432:5432
        env:
          POSTGRES_DB: exchange_info_db
          POSTGRES_USER: trading
          POSTGRES_PASSWORD: trading123
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'
      
      - name: Install Python dependencies
        run: pip install pandas taos-ws-py psycopg2-binary pynacl requests
      
      - name: Initialize DB
        run: |
          for f in migrations/*.sql; do
            echo "Applying $f..."
            PGPASSWORD=trading123 psql -h localhost -U trading -d exchange_info_db -f "$f"
          done
          PGPASSWORD=trading123 psql -h localhost -U trading -d exchange_info_db -f fixtures/seed_data.sql 2>&1 | grep -v 'does not exist' || true
      
      - name: Download Binary
        uses: actions/download-artifact@v4
        with:
          name: gateway-binary
          path: target/release
      
      - name: Set Binary Executable
        run: chmod +x target/release/zero_x_infinity

      - name: Run K-Line E2E
        run: ./scripts/test_ci.sh --test-kline

  test-depth:
    name: Depth API
    needs: [build, check-postgres, check-tdengine]
    runs-on: ubuntu-latest
    services:
      tdengine:
        image: tdengine/tdengine:latest
        ports:
          - 6030:6030
          - 6041:6041
      postgres:
        image: postgres:16
        ports:
          - 5432:5432
        env:
          POSTGRES_DB: exchange_info_db
          POSTGRES_USER: trading
          POSTGRES_PASSWORD: trading123
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'
      
      - name: Install Python dependencies
        run: pip install pandas taos-ws-py psycopg2-binary pynacl requests
      
      - name: Initialize DB
        run: |
          for f in migrations/*.sql; do
            echo "Applying $f..."
            PGPASSWORD=trading123 psql -h localhost -U trading -d exchange_info_db -f "$f"
          done
          PGPASSWORD=trading123 psql -h localhost -U trading -d exchange_info_db -f fixtures/seed_data.sql 2>&1 | grep -v 'does not exist' || true
      
      - name: Download Binary
        uses: actions/download-artifact@v4
        with:
          name: gateway-binary
          path: target/release
      
      - name: Set Binary Executable
        run: chmod +x target/release/zero_x_infinity

      - name: Run Depth API
        run: ./scripts/test_ci.sh --test-depth

  test-account:
    name: Account Integration
    needs: [build, check-postgres]
    runs-on: ubuntu-latest
    services:
      postgres:
        image: postgres:16
        ports:
          - 5432:5432
        env:
          POSTGRES_DB: exchange_info_db
          POSTGRES_USER: trading
          POSTGRES_PASSWORD: trading123
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'
      
      - name: Install Python dependencies
        run: pip install pandas taos-ws-py psycopg2-binary pynacl requests
      
      - name: Initialize DB
        run: |
          for f in migrations/*.sql; do
            echo "Applying $f..."
            PGPASSWORD=trading123 psql -h localhost -U trading -d exchange_info_db -f "$f"
          done
          PGPASSWORD=trading123 psql -h localhost -U trading -d exchange_info_db -f fixtures/seed_data.sql 2>&1 | grep -v 'does not exist' || true

      - name: Download Binary
        uses: actions/download-artifact@v4
        with:
          name: gateway-binary
          path: target/release
      
      - name: Set Binary Executable
        run: chmod +x target/release/zero_x_infinity

      - name: Run Account Integration
        run: ./scripts/test_ci.sh --test-account
